<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Configuraci√≥n - Sistema POS</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #333;
            padding: 20px;
        }

        .container {
            max-width: 800px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            padding: 40px;
        }

        header {
            text-align: center;
            margin-bottom: 30px;
        }

        h1 {
            font-size: 2.5rem;
            color: #4a5568;
            margin-bottom: 10px;
        }

        .subtitle {
            color: #718096;
            font-size: 0.9rem;
            margin-bottom: 20px;
        }

        .setup-section {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        .card {
            background: #f7fafc;
            border-radius: 15px;
            padding: 25px;
            border: 1px solid #e2e8f0;
        }

        h2 {
            color: #4a5568;
            margin-bottom: 15px;
            font-size: 1.5rem;
        }

        .info-text {
            color: #718096;
            margin-bottom: 15px;
        }

        .form-group {
            margin-bottom: 15px;
        }

        label {
            display: block;
            margin-bottom: 5px;
            color: #4a5568;
            font-weight: 500;
        }

        input, select {
            width: 100%;
            padding: 12px;
            border: 2px solid #e2e8f0;
            border-radius: 10px;
            font-size: 1rem;
            transition: border-color 0.3s;
        }

        input:focus, select:focus {
            outline: none;
            border-color: #667eea;
        }

        .button-group {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            margin-bottom: 15px;
        }

        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 10px;
            font-size: 1rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .btn-primary {
            background: #667eea;
            color: white;
        }

        .btn-primary:hover:not(:disabled) {
            background: #5a67d8;
            transform: translateY(-2px);
            box-shadow: 0 6px 15px rgba(102, 126, 234, 0.4);
        }

        .btn-secondary {
            background: #e2e8f0;
            color: #4a5568;
        }

        .btn-secondary:hover:not(:disabled) {
            background: #cbd5e0;
        }

        .btn-success {
            background: #38a169;
            color: white;
        }

        .btn-success:hover:not(:disabled) {
            background: #2f855a;
            transform: translateY(-2px);
            box-shadow: 0 6px 15px rgba(56, 161, 105, 0.4);
        }

        .btn-outline {
            background: transparent;
            border: 2px solid #667eea;
            color: #667eea;
        }

        .btn-outline:hover:not(:disabled) {
            background: #667eea;
            color: white;
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .status {
            margin-top: 15px;
            padding: 12px;
            border-radius: 10px;
        }

        .success {
            background: #c6f6d5;
            color: #22543d;
            border: 1px solid #9ae6b4;
        }

        .error {
            background: #fed7d7;
            color: #742a2a;
            border: 1px solid #fc8181;
        }

        .info {
            background: #bee3f8;
            color: #2a4365;
            border: 1px solid #90cdf4;
        }

        .warning {
            background: #feebc8;
            color: #744210;
            border: 1px solid #fbd38d;
        }

        .navigation {
            margin-top: 30px;
            text-align: center;
        }

        .sql-code {
            background: #2d3748;
            color: #e2e8f0;
            padding: 15px;
            border-radius: 10px;
            font-family: 'Courier New', monospace;
            font-size: 0.9rem;
            overflow-x: auto;
            margin: 15px 0;
        }

        .instructions {
            background: #edf2f7;
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 15px;
        }

        .instructions ol {
            margin-left: 20px;
            margin-bottom: 15px;
        }

        .instructions li {
            margin-bottom: 8px;
        }

        .step {
            display: flex;
            align-items: flex-start;
            gap: 15px;
            margin-bottom: 20px;
            padding: 15px;
            background: #f8fafc;
            border-radius: 10px;
            border-left: 4px solid #667eea;
        }

        .step-number {
            background: #667eea;
            color: white;
            width: 30px;
            height: 30px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            flex-shrink: 0;
        }

        .step-content {
            flex: 1;
        }

        .step-content h3 {
            margin-bottom: 5px;
            color: #4a5568;
        }

        .step-content p {
            color: #718096;
            font-size: 0.9rem;
        }

        .copy-btn {
            background: #4a5568;
            color: white;
            border: none;
            padding: 5px 10px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 0.8rem;
            margin-left: 10px;
        }

        .copy-btn:hover {
            background: #2d3748;
        }

        .test-data {
            background: #f0fff4;
            padding: 15px;
            border-radius: 10px;
            margin-top: 15px;
        }

        @media (max-width: 768px) {
            .container {
                padding: 20px;
            }
            
            h1 {
                font-size: 2rem;
            }
            
            .button-group {
                flex-direction: column;
            }
            
            .btn {
                width: 100%;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>üîß Configuraci√≥n del Sistema POS</h1>
            <p class="subtitle">Sistema completo de facturaci√≥n web - MultiLocal - Offline First</p>
        </header>

        <div class="setup-section">
            <!-- Paso 1: Crear proyecto en Supabase -->
            <div class="card">
                <h2>üìã PASO 1: Crear Proyecto en Supabase</h2>
                <div class="instructions">
                    <p>Sigue estos pasos para crear tu base de datos gratuita:</p>
                    <ol>
                        <li>Ve a <a href="https://supabase.com" target="_blank">supabase.com</a></li>
                        <li>Haz clic en "Start your project"</li>
                        <li>Inicia sesi√≥n con tu cuenta de GitHub o Google</li>
                        <li>Crea una organizaci√≥n</li>
                        <li>Selecciona "Create new project"</li>
                        <li>Elige un nombre para tu proyecto (ej: "mi-pos")</li>
                        <li>Crea una contrase√±a segura para la base de datos</li>
                        <li>Selecciona la regi√≥n m√°s cercana</li>
                        <li>Haz clic en "Create new project"</li>
                    </ol>
                    <p class="warning">‚ö†Ô∏è El proyecto puede tardar 1-2 minutos en crearse</p>
                </div>
            </div>

            <!-- Paso 2: Configurar credenciales -->
            <div class="card">
                <h2>üîë PASO 2: Configurar Credenciales</h2>
                <p class="info-text">Una vez creado el proyecto, sigue estos pasos:</p>
                
                <div class="step">
                    <div class="step-number">1</div>
                    <div class="step-content">
                        <h3>Obtener URL y Clave</h3>
                        <p>En el dashboard de tu proyecto, ve a Settings > API</p>
                    </div>
                </div>

                <div class="form-group">
                    <label for="supabaseUrl">URL de Supabase:</label>
                    <input type="text" id="supabaseUrl" placeholder="https://xxxxxxxxxxxx.supabase.co">
                    <small>Copia la URL de "Project URL"</small>
                </div>
                
                <div class="form-group">
                    <label for="supabaseKey">Clave An√≥nima (anon public):</label>
                    <input type="text" id="supabaseKey" placeholder="eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...">
                    <small>Copia la clave de "anon public" en Project API keys</small>
                </div>
                
                <button id="testConnection" class="btn btn-primary">Probar Conexi√≥n</button>
            </div>

            <!-- Paso 3: Crear tablas -->
            <div class="card">
                <h2>üóÉÔ∏è PASO 3: Crear Tablas en la Base de Datos</h2>
                <p class="info-text">Copia y pega este c√≥digo SQL en el editor de Supabase:</p>
                
                <div class="sql-code" id="sqlCode">
-- SISTEMA POS - CREACI√ìN DE TABLAS SIN RESTRICCIONES COMPLEJAS

-- 1. Tabla de locales/comercios
CREATE TABLE IF NOT EXISTS locales (
    id UUID DEFAULT gen_random_uuid() PRIMARY KEY,
    nombre VARCHAR(100) NOT NULL,
    direccion TEXT,
    telefono VARCHAR(20),
    email VARCHAR(100),
    config JSONB DEFAULT '{}',
    activo BOOLEAN DEFAULT true,
    created_at TIMESTAMP DEFAULT NOW()
);

-- 2. Tabla de cajas (SIN restricci√≥n UNIQUE para evitar problemas)
CREATE TABLE IF NOT EXISTS cajas (
    id UUID DEFAULT gen_random_uuid() PRIMARY KEY,
    numero VARCHAR(20) NOT NULL,
    nombre VARCHAR(100),
    local_id UUID,
    activa BOOLEAN DEFAULT true,
    created_at TIMESTAMP DEFAULT NOW()
);

-- 3. Tabla de productos (SIN restricci√≥n UNIQUE en c√≥digo_barras)
CREATE TABLE IF NOT EXISTS productos (
    id UUID DEFAULT gen_random_uuid() PRIMARY KEY,
    codigo_barras VARCHAR(50),
    nombre VARCHAR(200) NOT NULL,
    descripcion TEXT,
    precio_costo DECIMAL(10,2) DEFAULT 0,
    porcentaje_ganancia DECIMAL(5,2) DEFAULT 30,
    precio_venta DECIMAL(10,2) NOT NULL,
    stock INTEGER DEFAULT 0,
    stock_minimo INTEGER DEFAULT 5,
    categoria VARCHAR(100),
    proveedor_id UUID,
    activo BOOLEAN DEFAULT true,
    promocion JSONB DEFAULT '{}',
    created_at TIMESTAMP DEFAULT NOW(),
    updated_at TIMESTAMP DEFAULT NOW()
);

-- 4. Tabla de clientes (SIN restricci√≥n UNIQUE en DNI)
CREATE TABLE IF NOT EXISTS clientes (
    id UUID DEFAULT gen_random_uuid() PRIMARY KEY,
    nombre VARCHAR(100) NOT NULL,
    dni VARCHAR(20),
    telefono VARCHAR(20),
    email VARCHAR(100),
    direccion TEXT,
    limite_credito DECIMAL(10,2) DEFAULT 0,
    saldo DECIMAL(10,2) DEFAULT 0,
    activo BOOLEAN DEFAULT true,
    created_at TIMESTAMP DEFAULT NOW()
);

-- 5. Tabla de proveedores
CREATE TABLE IF NOT EXISTS proveedores (
    id UUID DEFAULT gen_random_uuid() PRIMARY KEY,
    nombre VARCHAR(100) NOT NULL,
    contacto VARCHAR(100),
    telefono VARCHAR(20),
    email VARCHAR(100),
    web VARCHAR(200),
    whatsapp VARCHAR(20),
    activo BOOLEAN DEFAULT true,
    created_at TIMESTAMP DEFAULT NOW()
);

-- 6. Tabla de ventas
CREATE TABLE IF NOT EXISTS ventas (
    id UUID DEFAULT gen_random_uuid() PRIMARY KEY,
    local_id UUID,
    caja_id UUID,
    usuario_id UUID,
    cliente_id UUID,
    total DECIMAL(10,2) NOT NULL,
    descuento DECIMAL(10,2) DEFAULT 0,
    estado VARCHAR(20) DEFAULT 'completada',
    tipo_venta VARCHAR(20) DEFAULT 'contado',
    observaciones TEXT,
    offline_id VARCHAR(100),
    sync_status VARCHAR(20) DEFAULT 'synced',
    created_at TIMESTAMP DEFAULT NOW(),
    updated_at TIMESTAMP DEFAULT NOW()
);

-- 7. Tabla de items de venta
CREATE TABLE IF NOT EXISTS venta_items (
    id UUID DEFAULT gen_random_uuid() PRIMARY KEY,
    venta_id UUID,
    producto_id UUID,
    cantidad INTEGER NOT NULL,
    precio_unitario DECIMAL(10,2) NOT NULL,
    subtotal DECIMAL(10,2) NOT NULL,
    descuento DECIMAL(10,2) DEFAULT 0,
    created_at TIMESTAMP DEFAULT NOW()
);

-- 8. Tabla de pagos
CREATE TABLE IF NOT EXISTS pagos (
    id UUID DEFAULT gen_random_uuid() PRIMARY KEY,
    venta_id UUID,
    metodo VARCHAR(50) NOT NULL,
    monto DECIMAL(10,2) NOT NULL,
    referencia VARCHAR(100),
    estado VARCHAR(20) DEFAULT 'completado',
    offline_id VARCHAR(100),
    sync_status VARCHAR(20) DEFAULT 'synced',
    created_at TIMESTAMP DEFAULT NOW()
);

-- 9. Tabla de presupuestos
CREATE TABLE IF NOT EXISTS presupuestos (
    id UUID DEFAULT gen_random_uuid() PRIMARY KEY,
    local_id UUID,
    cliente_id UUID,
    usuario_id UUID,
    total DECIMAL(10,2) NOT NULL,
    valido_hasta DATE,
    estado VARCHAR(20) DEFAULT 'pendiente',
    observaciones TEXT,
    offline_id VARCHAR(100),
    sync_status VARCHAR(20) DEFAULT 'synced',
    created_at TIMESTAMP DEFAULT NOW()
);

-- 10. Tabla de items de presupuesto
CREATE TABLE IF NOT EXISTS presupuesto_items (
    id UUID DEFAULT gen_random_uuid() PRIMARY KEY,
    presupuesto_id UUID,
    producto_id UUID,
    cantidad INTEGER NOT NULL,
    precio_unitario DECIMAL(10,2) NOT NULL,
    subtotal DECIMAL(10,2) NOT NULL,
    created_at TIMESTAMP DEFAULT NOW()
);

-- 11. Tabla de cuentas corrientes
CREATE TABLE IF NOT EXISTS cuentas_corrientes (
    id UUID DEFAULT gen_random_uuid() PRIMARY KEY,
    cliente_id UUID,
    tipo_movimiento VARCHAR(20) NOT NULL,
    monto DECIMAL(10,2) NOT NULL,
    saldo_anterior DECIMAL(10,2) NOT NULL,
    saldo_nuevo DECIMAL(10,2) NOT NULL,
    referencia_id UUID,
    observaciones TEXT,
    offline_id VARCHAR(100),
    sync_status VARCHAR(20) DEFAULT 'synced',
    created_at TIMESTAMP DEFAULT NOW()
);

-- 12. Tabla de cierres de caja
CREATE TABLE IF NOT EXISTS cierres_caja (
    id UUID DEFAULT gen_random_uuid() PRIMARY KEY,
    local_id UUID,
    caja_id UUID,
    usuario_id UUID,
    turno VARCHAR(10) NOT NULL,
    fecha DATE NOT NULL,
    saldo_inicial DECIMAL(10,2) NOT NULL,
    saldo_final DECIMAL(10,2),
    ventas_efectivo DECIMAL(10,2) DEFAULT 0,
    ventas_tarjeta DECIMAL(10,2) DEFAULT 0,
    ventas_transferencia DECIMAL(10,2) DEFAULT 0,
    observaciones TEXT,
    estado VARCHAR(20) DEFAULT 'abierto',
    created_at TIMESTAMP DEFAULT NOW(),
    updated_at TIMESTAMP DEFAULT NOW()
);
                </div>
                
                <button id="copySql" class="copy-btn">üìã Copiar SQL al Portapapeles</button>
                
                <div class="instructions" style="margin-top: 15px;">
                    <p><strong>¬øC√≥mo ejecutar el SQL?</strong></p>
                    <ol>
                        <li>En el men√∫ izquierdo de Supabase, haz clic en "SQL Editor"</li>
                        <li>Haz clic en "New query"</li>
                        <li>Pega el c√≥digo SQL anterior</li>
                        <li>Haz clic en "Run" (‚ñ∂Ô∏è)</li>
                        <li>Espera a que se ejecute (puede tardar unos segundos)</li>
                    </ol>
                </div>
            </div>

            <!-- Paso 4: Insertar datos de prueba -->
            <div class="card">
                <h2>üìä PASO 4: Insertar Datos de Prueba</h2>
                <p class="info-text">Una vez creadas las tablas, inserta datos iniciales:</p>
                
                <div class="test-data">
                    <p><strong>Datos que se insertar√°n:</strong></p>
                    <ul>
                        <li>‚úÖ 1 Local principal</li>
                        <li>‚úÖ 2 Cajas (01 y 02)</li>
                        <li>‚úÖ 4 Productos de ejemplo</li>
                        <li>‚úÖ 2 Clientes (contado y cuenta corriente)</li>
                        <li>‚úÖ 2 Proveedores</li>
                    </ul>
                </div>
                
                <button id="insertTestData" class="btn btn-primary" disabled>Insertar Datos de Prueba</button>
                <div id="dataStatus" class="status"></div>
            </div>

            <!-- Paso 5: Verificar configuraci√≥n -->
            <div class="card">
                <h2>‚úÖ PASO 5: Verificar Configuraci√≥n</h2>
                <p class="info-text">Verifica que todo est√© correctamente configurado</p>
                <button id="verifySetup" class="btn btn-success" disabled>Verificar Configuraci√≥n</button>
                <div id="verifyStatus" class="status"></div>
            </div>
        </div>

        <div class="navigation">
            <button id="goToApp" class="btn btn-success" disabled>üöÄ Ir a la Aplicaci√≥n POS</button>
            <p style="margin-top: 10px; color: #718096; font-size: 0.9rem;">
                Una vez completados todos los pasos, podr√°s usar el sistema POS
            </p>
        </div>
    </div>

    <script>
        // Configuraci√≥n
        let supabaseClient = null;
        let supabaseLoaded = false;

        // Elementos del DOM
        const supabaseUrlInput = document.getElementById('supabaseUrl');
        const supabaseKeyInput = document.getElementById('supabaseKey');
        const testConnectionBtn = document.getElementById('testConnection');
        const insertTestDataBtn = document.getElementById('insertTestData');
        const verifySetupBtn = document.getElementById('verifySetup');
        const goToAppBtn = document.getElementById('goToApp');
        const copySqlBtn = document.getElementById('copySql');
        const dataStatus = document.getElementById('dataStatus');
        const verifyStatus = document.getElementById('verifyStatus');
        const sqlCode = document.getElementById('sqlCode');

        // Cargar credenciales guardadas
        window.addEventListener('DOMContentLoaded', () => {
            const savedUrl = localStorage.getItem('supabaseUrl');
            const savedKey = localStorage.getItem('supabaseKey');
            const systemConfigured = localStorage.getItem('systemConfigured');
            
            if (savedUrl) supabaseUrlInput.value = savedUrl;
            if (savedKey) supabaseKeyInput.value = savedKey;
            
            // Si ya est√° configurado, habilitar botones
            if (systemConfigured === 'true') {
                goToAppBtn.disabled = false;
                verifyStatus.innerHTML = '<p class="success">‚úÖ Sistema ya configurado. Puedes ir a la aplicaci√≥n.</p>';
            }
            
            // Cargar Supabase desde CDN
            loadSupabase();
        });

        // Funci√≥n para cargar Supabase
        async function loadSupabase() {
            if (window.supabase) {
                supabaseLoaded = true;
                return;
            }
            
            return new Promise((resolve, reject) => {
                const script = document.createElement('script');
                script.src = 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/supabase.min.js';
                script.onload = () => {
                    supabaseLoaded = true;
                    resolve();
                };
                script.onerror = () => {
                    console.error('Error cargando Supabase');
                    reject();
                };
                document.head.appendChild(script);
            });
        }

        // Copiar SQL al portapapeles
        copySqlBtn.addEventListener('click', () => {
            const text = sqlCode.textContent;
            navigator.clipboard.writeText(text).then(() => {
                const originalText = copySqlBtn.textContent;
                copySqlBtn.textContent = '‚úÖ ¬°Copiado!';
                setTimeout(() => {
                    copySqlBtn.textContent = originalText;
                }, 2000);
            }).catch(err => {
                console.error('Error copiando texto: ', err);
            });
        });

        // Probar conexi√≥n a Supabase
        testConnectionBtn.addEventListener('click', async () => {
            const url = supabaseUrlInput.value.trim();
            const key = supabaseKeyInput.value.trim();
            
            if (!url || !key) {
                alert('Por favor, completa ambos campos');
                return;
            }
            
            // Verificar formato de URL
            if (!url.startsWith('https://') || !url.includes('.supabase.co')) {
                alert('La URL debe tener el formato: https://xxxxxx.supabase.co');
                return;
            }
            
            // Verificar formato de clave
            if (!key.startsWith('eyJ')) {
                alert('La clave debe comenzar con "eyJ". Aseg√∫rate de copiar la clave "anon public"');
                return;
            }
            
            testConnectionBtn.disabled = true;
            testConnectionBtn.textContent = 'üîÑ Probando conexi√≥n...';
            
            try {
                // Esperar a que cargue Supabase si no est√° listo
                if (!supabaseLoaded) {
                    await loadSupabase();
                }
                
                // Guardar credenciales
                localStorage.setItem('supabaseUrl', url);
                localStorage.setItem('supabaseKey', key);
                
                // Crear cliente de Supabase
                supabaseClient = window.supabase.createClient(url, key);
                
                // Probar conexi√≥n con una consulta simple a auth
                const { data, error } = await supabaseClient.auth.getSession();
                
                if (error) {
                    // Si hay error de auth, probar con una consulta a una tabla que deber√≠a existir
                    console.log('Probando conexi√≥n alternativa...');
                    
                    // Intentar una consulta simple
                    const { error: tableError } = await supabaseClient
                        .from('locales')
                        .select('count')
                        .limit(1)
                        .single();
                    
                    // Si esperamos error 404 porque la tabla no existe, pero la conexi√≥n es exitosa
                    if (tableError && tableError.code === 'PGRST116') {
                        // Tabla no existe pero conexi√≥n es exitosa
                        console.log('‚úÖ Conexi√≥n exitosa (tabla no existe a√∫n)');
                        alert('‚úÖ Conexi√≥n exitosa a Supabase\n\nAhora crea las tablas usando el SQL del paso 3.');
                    } else if (tableError) {
                        throw tableError;
                    } else {
                        throw new Error('Error desconocido');
                    }
                } else {
                    console.log('‚úÖ Conexi√≥n exitosa con sesi√≥n');
                    alert('‚úÖ Conexi√≥n exitosa a Supabase');
                }
                
                // Habilitar botones siguientes
                insertTestDataBtn.disabled = false;
                verifySetupBtn.disabled = false;
                
            } catch (error) {
                console.error('Error de conexi√≥n:', error);
                
                let errorMessage = error.message || 'Error desconocido';
                
                if (error.message.includes('JWT')) {
                    errorMessage = 'Clave inv√°lida. Aseg√∫rate de copiar la clave "anon public"';
                } else if (error.message.includes('fetch')) {
                    errorMessage = 'Error de red. Verifica tu conexi√≥n a internet y la URL';
                } else if (error.message.includes('PGRST')) {
                    errorMessage = 'URL inv√°lida. Verifica que sea correcta';
                }
                
                alert(`‚ùå Error de conexi√≥n:\n\n${errorMessage}\n\nVerifica:\n1. La URL es correcta\n2. La clave es "anon public"\n3. Tu proyecto est√° activo en Supabase`);
                
            } finally {
                testConnectionBtn.disabled = false;
                testConnectionBtn.textContent = 'Probar Conexi√≥n';
            }
        });

        // Insertar datos de prueba - VERSI√ìN CORREGIDA
        insertTestDataBtn.addEventListener('click', async () => {
            if (!supabaseClient) {
                alert('Primero prueba la conexi√≥n');
                return;
            }
            
            insertTestDataBtn.disabled = true;
            insertTestDataBtn.textContent = 'üîÑ Insertando datos...';
            dataStatus.innerHTML = '<p class="info">üîÑ Insertando datos de prueba...</p>';
            
            try {
                // 1. Insertar local principal (usamos insert simple, no upsert)
                const { data: local, error: localError } = await supabaseClient
                    .from('locales')
                    .insert({
                        nombre: 'Local Principal',
                        direccion: 'Av. Comercial 1234',
                        telefono: '011-1234-5678',
                        email: 'ventas@misupermercado.com',
                        config: { 
                            impresora: 't√©rmica 80mm',
                            moneda: 'ARS',
                            iva: 21 
                        }
                    })
                    .select()
                    .single();
                
                // Si hay error, puede ser que ya exista, entonces lo obtenemos
                let localData = local;
                if (localError) {
                    console.warn('Error insertando local (puede que ya exista):', localError.message);
                    
                    // Intentar obtener el local existente
                    const { data: existingLocal, error: fetchError } = await supabaseClient
                        .from('locales')
                        .select('*')
                        .limit(1)
                        .single();
                    
                    if (fetchError) {
                        throw new Error('No se pudo crear ni obtener el local: ' + fetchError.message);
                    }
                    localData = existingLocal;
                }
                
                // 2. Insertar cajas (usamos insert simple en lugar de upsert)
                const cajasData = [
                    { numero: '01', nombre: 'Caja Principal', local_id: localData.id },
                    { numero: '02', nombre: 'Caja Secundaria', local_id: localData.id }
                ];
                
                for (const caja of cajasData) {
                    try {
                        const { error: cajaError } = await supabaseClient
                            .from('cajas')
                            .insert(caja);
                        
                        if (cajaError && !cajaError.message.includes('duplicate key')) {
                            console.warn('Error insertando caja:', cajaError.message);
                        } else if (cajaError) {
                            console.log('Caja ya existe, continuando...');
                        }
                    } catch (cajaError) {
                        console.warn('Error al insertar caja (ignorando):', cajaError.message);
                    }
                }
                
                // 3. Insertar productos (usamos insert simple)
                const productosData = [
                    {
                        codigo_barras: '7791234567890',
                        nombre: 'Coca Cola 2.25L',
                        descripcion: 'Gaseosa Coca Cola 2.25 litros',
                        precio_costo: 450.00,
                        porcentaje_ganancia: 30.00,
                        precio_venta: 585.00,
                        stock: 100,
                        stock_minimo: 10,
                        categoria: 'Bebidas',
                        activo: true
                    },
                    {
                        codigo_barras: '7791234567891',
                        nombre: 'Pan de Molde Integral',
                        descripcion: 'Pan de molde integral 500g',
                        precio_costo: 320.00,
                        porcentaje_ganancia: 35.00,
                        precio_venta: 432.00,
                        stock: 50,
                        stock_minimo: 5,
                        categoria: 'Panader√≠a',
                        activo: true
                    },
                    {
                        codigo_barras: '7791234567892',
                        nombre: 'Leche Entera 1L',
                        descripcion: 'Leche entera larga vida 1 litro',
                        precio_costo: 280.00,
                        porcentaje_ganancia: 25.00,
                        precio_venta: 350.00,
                        stock: 80,
                        stock_minimo: 8,
                        categoria: 'L√°cteos',
                        activo: true
                    },
                    {
                        codigo_barras: '7791234567893',
                        nombre: 'Arroz Largo Fino 1kg',
                        descripcion: 'Arroz largo fino tipo 0000',
                        precio_costo: 150.00,
                        porcentaje_ganancia: 40.00,
                        precio_venta: 210.00,
                        stock: 120,
                        stock_minimo: 12,
                        categoria: 'Almac√©n',
                        activo: true
                    }
                ];
                
                for (const producto of productosData) {
                    try {
                        const { error: productoError } = await supabaseClient
                            .from('productos')
                            .insert(producto);
                        
                        if (productoError && !productoError.message.includes('duplicate key')) {
                            console.warn('Error insertando producto:', productoError.message);
                        } else if (productoError) {
                            console.log('Producto ya existe, continuando...');
                        }
                    } catch (productoError) {
                        console.warn('Error al insertar producto (ignorando):', productoError.message);
                    }
                }
                
                // 4. Insertar clientes (usamos insert simple)
                const clientesData = [
                    {
                        nombre: 'Cliente Contado',
                        dni: '12345678',
                        telefono: '011-9876-5432',
                        email: 'cliente@contado.com',
                        direccion: 'Calle Falsa 123',
                        limite_credito: 0,
                        saldo: 0,
                        activo: true
                    },
                    {
                        nombre: 'Cliente Cuenta Corriente',
                        dni: '87654321',
                        telefono: '011-1234-4321',
                        email: 'cliente@cuenta.com',
                        direccion: 'Av. Siempre Viva 742',
                        limite_credito: 50000.00,
                        saldo: 0,
                        activo: true
                    }
                ];
                
                for (const cliente of clientesData) {
                    try {
                        const { error: clienteError } = await supabaseClient
                            .from('clientes')
                            .insert(cliente);
                        
                        if (clienteError && !clienteError.message.includes('duplicate key')) {
                            console.warn('Error insertando cliente:', clienteError.message);
                        } else if (clienteError) {
                            console.log('Cliente ya existe, continuando...');
                        }
                    } catch (clienteError) {
                        console.warn('Error al insertar cliente (ignorando):', clienteError.message);
                    }
                }
                
                // 5. Insertar proveedores
                const proveedoresData = [
                    {
                        nombre: 'Distribuidora Mayorista SA',
                        contacto: 'Juan P√©rez',
                        telefono: '011-5555-6666',
                        email: 'ventas@mayorista.com.ar',
                        web: 'https://www.mayorista.com.ar',
                        whatsapp: '+5491155556666',
                        activo: true
                    },
                    {
                        nombre: 'F√°brica de Bebidas Argentinas',
                        contacto: 'Mar√≠a G√≥mez',
                        telefono: '011-7777-8888',
                        email: 'ventas@fabrica-bebidas.com',
                        web: 'https://www.fabrica-bebidas.com.ar',
                        whatsapp: '+5491177778888',
                        activo: true
                    }
                ];
                
                for (const proveedor of proveedoresData) {
                    try {
                        const { error: proveedorError } = await supabaseClient
                            .from('proveedores')
                            .insert(proveedor);
                        
                        if (proveedorError) {
                            console.warn('Error insertando proveedor:', proveedorError.message);
                        }
                    } catch (proveedorError) {
                        console.warn('Error al insertar proveedor (ignorando):', proveedorError.message);
                    }
                }
                
                dataStatus.innerHTML = `
                    <p class="success">‚úÖ Datos de prueba insertados correctamente</p>
                    <p class="info">Se insertaron:</p>
                    <ul>
                        <li>1 Local</li>
                        <li>2 Cajas</li>
                        <li>4 Productos</li>
                        <li>2 Clientes</li>
                        <li>2 Proveedores</li>
                    </ul>
                    <p class="warning">‚ö†Ô∏è Nota: Si algunos datos ya exist√≠an, se omitieron sin errores.</p>
                `;
                
                verifySetupBtn.disabled = false;
                
            } catch (error) {
                console.error('Error insertando datos:', error);
                dataStatus.innerHTML = `
                    <p class="error">‚ùå Error insertando datos:</p>
                    <p>${error.message}</p>
                    <p class="warning">‚ö†Ô∏è Aseg√∫rate de haber creado las tablas primero (Paso 3)</p>
                `;
            } finally {
                insertTestDataBtn.disabled = false;
                insertTestDataBtn.textContent = 'Insertar Datos de Prueba';
            }
        });

        // Verificar configuraci√≥n completa
        verifySetupBtn.addEventListener('click', async () => {
            if (!supabaseClient) {
                alert('Primero prueba la conexi√≥n');
                return;
            }
            
            verifySetupBtn.disabled = true;
            verifySetupBtn.textContent = 'üîÑ Verificando...';
            verifyStatus.innerHTML = '<p class="info">üîÑ Verificando configuraci√≥n...</p>';
            
            try {
                // Verificar que existan las tablas principales
                const tablesToCheck = ['locales', 'cajas', 'productos', 'clientes', 'proveedores'];
                let missingTables = [];
                
                for (const table of tablesToCheck) {
                    try {
                        const { error } = await supabaseClient
                            .from(table)
                            .select('id')
                            .limit(1);
                        
                        if (error) {
                            missingTables.push(table);
                        }
                    } catch (error) {
                        missingTables.push(table);
                    }
                }
                
                if (missingTables.length > 0) {
                    throw new Error(`Faltan las tablas: ${missingTables.join(', ')}. Ejecuta el SQL del paso 3.`);
                }
                
                // Verificar que haya datos
                const { data: productos, error: productosError } = await supabaseClient
                    .from('productos')
                    .select('id')
                    .limit(1);
                
                if (productosError) {
                    throw new Error('Error al verificar productos: ' + productosError.message);
                }
                
                if (!productos || productos.length === 0) {
                    throw new Error('No hay productos cargados. Ejecuta "Insertar Datos de Prueba"');
                }
                
                // Marcar sistema como configurado
                localStorage.setItem('systemConfigured', 'true');
                
                verifyStatus.innerHTML = `
                    <p class="success">‚úÖ Configuraci√≥n verificada correctamente</p>
                    <p class="info">‚úÖ Tablas creadas</p>
                    <p class="info">‚úÖ Datos cargados</p>
                    <p class="info">‚úÖ Conexi√≥n activa</p>
                `;
                
                goToAppBtn.disabled = false;
                
            } catch (error) {
                verifyStatus.innerHTML = `
                    <p class="error">‚ùå Error en verificaci√≥n:</p>
                    <p>${error.message}</p>
                    <p class="info">‚ö†Ô∏è Completa los pasos anteriores</p>
                `;
            } finally {
                verifySetupBtn.disabled = false;
                verifySetupBtn.textContent = 'Verificar Configuraci√≥n';
            }
        });

        // Ir a la aplicaci√≥n
        goToAppBtn.addEventListener('click', () => {
            window.location.href = 'index.html';
        });

        // Guardar credenciales al cambiar
        supabaseUrlInput.addEventListener('change', () => {
            localStorage.setItem('supabaseUrl', supabaseUrlInput.value);
        });
        
        supabaseKeyInput.addEventListener('change', () => {
            localStorage.setItem('supabaseKey', supabaseKeyInput.value);
        });
    </script>
</body>
</html>
