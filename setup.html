<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Configuración Inicial | POS CommerceFire</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', system-ui, sans-serif;
        }
        
        body {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }
        
        .setup-container {
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            width: 100%;
            max-width: 800px;
            overflow: hidden;
        }
        
        .setup-header {
            background: linear-gradient(90deg, #4f46e5, #7c3aed);
            color: white;
            padding: 30px;
            text-align: center;
        }
        
        .setup-header h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
        }
        
        .setup-header p {
            opacity: 0.9;
            font-size: 1.1rem;
        }
        
        .warning-banner {
            background: #fef3c7;
            border-left: 4px solid #f59e0b;
            padding: 15px;
            margin: 20px;
            border-radius: 8px;
        }
        
        .warning-banner h3 {
            color: #92400e;
            margin-bottom: 5px;
        }
        
        .setup-steps {
            padding: 30px;
        }
        
        .step {
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 1px solid #e5e7eb;
        }
        
        .step-header {
            display: flex;
            align-items: center;
            margin-bottom: 15px;
        }
        
        .step-number {
            background: #4f46e5;
            color: white;
            width: 36px;
            height: 36px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            margin-right: 15px;
        }
        
        .step-title {
            font-size: 1.3rem;
            color: #1f2937;
            font-weight: 600;
        }
        
        .step-content {
            padding-left: 51px;
        }
        
        .form-group {
            margin-bottom: 15px;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 5px;
            color: #4b5563;
            font-weight: 500;
        }
        
        .form-group input, .form-group select {
            width: 100%;
            padding: 12px;
            border: 1px solid #d1d5db;
            border-radius: 8px;
            font-size: 1rem;
            transition: border-color 0.2s;
        }
        
        .form-group input:focus, .form-group select:focus {
            outline: none;
            border-color: #4f46e5;
            box-shadow: 0 0 0 3px rgba(79, 70, 229, 0.1);
        }
        
        .grid-2 {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
        }
        
        .firebase-config {
            background: #f9fafb;
            border: 1px solid #e5e7eb;
            border-radius: 8px;
            padding: 15px;
            font-family: monospace;
            font-size: 0.9rem;
            white-space: pre-wrap;
            word-break: break-all;
        }
        
        .test-users {
            background: #f0f9ff;
            border: 1px solid #bae6fd;
            border-radius: 8px;
            padding: 15px;
            margin-top: 15px;
        }
        
        .test-user {
            display: flex;
            justify-content: space-between;
            padding: 8px;
            border-bottom: 1px solid #e5e7eb;
        }
        
        .test-user:last-child {
            border-bottom: none;
        }
        
        .setup-actions {
            padding: 20px 30px;
            background: #f9fafb;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .btn-primary {
            background: #4f46e5;
            color: white;
        }
        
        .btn-primary:hover:not(:disabled) {
            background: #4338ca;
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(79, 70, 229, 0.3);
        }
        
        .btn-secondary {
            background: #6b7280;
            color: white;
        }
        
        .btn-secondary:hover {
            background: #4b5563;
        }
        
        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        .status-message {
            padding: 10px 15px;
            border-radius: 8px;
            margin-bottom: 15px;
            display: none;
        }
        
        .status-success {
            background: #d1fae5;
            color: #065f46;
            border: 1px solid #a7f3d0;
            display: block;
        }
        
        .status-error {
            background: #fee2e2;
            color: #991b1b;
            border: 1px solid #fecaca;
            display: block;
        }
        
        .status-info {
            background: #dbeafe;
            color: #1e40af;
            border: 1px solid #bfdbfe;
            display: block;
        }
        
        .progress-bar {
            height: 6px;
            background: #e5e7eb;
            border-radius: 3px;
            overflow: hidden;
            margin: 15px 0;
        }
        
        .progress-fill {
            height: 100%;
            background: #4f46e5;
            width: 0%;
            transition: width 0.3s;
        }
        
        .setup-complete {
            text-align: center;
            padding: 40px 30px;
            display: none;
        }
        
        .setup-complete h2 {
            color: #065f46;
            margin-bottom: 20px;
        }
        
        .setup-complete .success-icon {
            font-size: 4rem;
            color: #10b981;
            margin-bottom: 20px;
        }
        
        .credentials {
            background: #f8fafc;
            border-radius: 10px;
            padding: 20px;
            margin: 20px 0;
            text-align: left;
        }
        
        .credential-item {
            margin-bottom: 10px;
            padding-bottom: 10px;
            border-bottom: 1px dashed #e5e7eb;
        }
        
        .credential-item:last-child {
            border-bottom: none;
            margin-bottom: 0;
            padding-bottom: 0;
        }
    </style>
</head>
<body>
    <div class="setup-container">
        <div class="setup-header">
            <h1>⚙️ Configuración Inicial</h1>
            <p>POS CommerceFire - Sistema de Punto de Venta</p>
        </div>
        
        <div class="warning-banner">
            <h3>⚠️ ADVERTENCIA IMPORTANTE</h3>
            <p>Este setup debe ejecutarse <strong>UNA SOLA VEZ</strong> para inicializar la estructura de la base de datos. Asegúrate de tener permiso de administrador en Firebase.</p>
        </div>
        
        <div id="setup-form">
            <div class="setup-steps">
                <div class="step">
                    <div class="step-header">
                        <div class="step-number">1</div>
                        <div class="step-title">Configuración Firebase</div>
                    </div>
                    <div class="step-content">
                        <p>Ingresa la configuración de tu proyecto Firebase. Esta configuración se encuentra en la consola de Firebase → Configuración del proyecto → Tus apps.</p>
                        
                        <div class="form-group">
                            <label for="firebase-config">Configuración Firebase</label>
                            <textarea id="firebase-config" rows="6" class="firebase-config" placeholder='{
  apiKey: "AIzaSyCtOiUy2tUQeixUiJxTdI_ESULY4WpqXzw",
  authDomain: "whatsappau-30dc1.firebaseapp.com",
  projectId: "whatsappau-30dc1",
  storageBucket: "whatsappau-30dc1.firebasestorage.app",
  messagingSenderId: "456068013185",
  appId: "1:456068013185:web:5bdd49337fb622e56f0180"
}'></textarea>
                        </div>
                        
                        <div class="form-group">
                            <button id="test-connection" class="btn btn-secondary" style="width: auto;">Probar Conexión Firebase</button>
                            <span id="connection-test-result" style="margin-left: 10px;"></span>
                        </div>
                    </div>
                </div>
                
                <div class="step">
                    <div class="step-header">
                        <div class="step-number">2</div>
                        <div class="step-title">Datos del Negocio Principal</div>
                    </div>
                    <div class="step-content">
                        <div class="grid-2">
                            <div class="form-group">
                                <label for="business-name">Nombre del Negocio *</label>
                                <input type="text" id="business-name" placeholder="Ej: Mi Comercio S.A." required>
                            </div>
                            <div class="form-group">
                                <label for="business-address">Dirección</label>
                                <input type="text" id="business-address" placeholder="Calle 123, Ciudad">
                            </div>
                        </div>
                        
                        <div class="grid-2">
                            <div class="form-group">
                                <label for="business-phone">Teléfono</label>
                                <input type="text" id="business-phone" placeholder="+54 11 1234-5678">
                            </div>
                            <div class="form-group">
                                <label for="business-email">Email</label>
                                <input type="email" id="business-email" placeholder="info@micomercio.com">
                            </div>
                        </div>
                        
                        <div class="form-group">
                            <label for="business-logo">Logo URL (opcional)</label>
                            <input type="text" id="business-logo" placeholder="https://...">
                        </div>
                    </div>
                </div>
                
                <div class="step">
                    <div class="step-header">
                        <div class="step-number">3</div>
                        <div class="step-title">Local Principal</div>
                    </div>
                    <div class="step-content">
                        <p>Este será tu primer local de ventas. Puedes agregar más locales después.</p>
                        
                        <div class="grid-2">
                            <div class="form-group">
                                <label for="local-name">Nombre del Local *</label>
                                <input type="text" id="local-name" placeholder="Ej: Sucursal Centro" required>
                            </div>
                            <div class="form-group">
                                <label for="local-code">Código del Local *</label>
                                <input type="text" id="local-code" placeholder="CENTRO" required>
                            </div>
                        </div>
                        
                        <div class="form-group">
                            <label for="local-address">Dirección del Local</label>
                            <input type="text" id="local-address" placeholder="Calle Principal 456">
                        </div>
                        
                        <div class="grid-2">
                            <div class="form-group">
                                <label for="local-phone">Teléfono Local</label>
                                <input type="text" id="local-phone" placeholder="+54 11 8765-4321">
                            </div>
                            <div class="form-group">
                                <label for="local-opening">Horario</label>
                                <input type="text" id="local-opening" placeholder="9:00 - 18:00">
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="step">
                    <div class="step-header">
                        <div class="step-number">4</div>
                        <div class="step-title">Usuarios de Prueba</div>
                    </div>
                    <div class="step-content">
                        <p>Se crearán estos usuarios para comenzar a usar el sistema. Cambia las contraseñas después del primer login.</p>
                        
                        <div class="test-users">
                            <div class="test-user">
                                <div>
                                    <strong>Administrador</strong><br>
                                    admin@comercio.com
                                </div>
                                <div>Contraseña: admin123</div>
                            </div>
                            <div class="test-user">
                                <div>
                                    <strong>Cajero</strong><br>
                                    cajero@comercio.com
                                </div>
                                <div>Contraseña: cajero123</div>
                            </div>
                            <div class="test-user">
                                <div>
                                    <strong>Vendedor</strong><br>
                                    vendedor@comercio.com
                                </div>
                                <div>Contraseña: vendedor123</div>
                            </div>
                        </div>
                        
                        <div class="form-group" style="margin-top: 15px;">
                            <label for="admin-email">Email Administrador Personalizado (opcional)</label>
                            <input type="email" id="admin-email" placeholder="tucorreo@dominio.com">
                        </div>
                    </div>
                </div>
                
                <div class="step">
                    <div class="step-header">
                        <div class="step-number">5</div>
                        <div class="step-title">Productos de Prueba</div>
                    </div>
                    <div class="step-content">
                        <p>Se crearán 50 productos de ejemplo para comenzar a probar el sistema.</p>
                        
                        <div class="form-group">
                            <label for="product-category">Categoría Principal</label>
                            <select id="product-category">
                                <option value="general">General</option>
                                <option value="alimentos">Alimentos</option>
                                <option value="bebidas">Bebidas</option>
                                <option value="limpieza">Limpieza</option>
                                <option value="electronica">Electrónica</option>
                            </select>
                        </div>
                        
                        <div class="form-group">
                            <label>
                                <input type="checkbox" id="create-products" checked>
                                Crear productos de prueba
                            </label>
                        </div>
                    </div>
                </div>
            </div>
            
            <div id="status-messages"></div>
            
            <div class="progress-bar">
                <div id="progress-fill" class="progress-fill"></div>
            </div>
            
            <div class="setup-actions">
                <div>
                    <strong id="current-operation">Listo para configurar</strong>
                </div>
                <div>
                    <button id="start-setup" class="btn btn-primary">Iniciar Configuración</button>
                </div>
            </div>
        </div>
        
        <div id="setup-complete" class="setup-complete">
            <div class="success-icon">✅</div>
            <h2>¡Configuración Completada!</h2>
            <p>El sistema POS CommerceFire ha sido configurado correctamente.</p>
            
            <div class="credentials">
                <h3>Credenciales de Acceso:</h3>
                <div class="credential-item">
                    <strong>Administrador:</strong><br>
                    admin@comercio.com / admin123
                </div>
                <div class="credential-item">
                    <strong>Cajero:</strong><br>
                    cajero@comercio.com / cajero123
                </div>
                <div class="credential-item">
                    <strong>Vendedor:</strong><br>
                    vendedor@comercio.com / vendedor123
                </div>
            </div>
            
            <p><strong>¡IMPORTANTE!</strong> Cambia estas contraseñas después del primer login.</p>
            
            <div style="margin-top: 30px;">
                <a href="index.html" class="btn btn-primary" style="text-decoration: none;">Ir al Sistema POS</a>
            </div>
        </div>
    </div>
    
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    
    <script>
        // Elementos del DOM
        const setupForm = document.getElementById('setup-form');
        const setupComplete = document.getElementById('setup-complete');
        const startSetupBtn = document.getElementById('start-setup');
        const testConnectionBtn = document.getElementById('test-connection');
        const statusMessages = document.getElementById('status-messages');
        const progressFill = document.getElementById('progress-fill');
        const currentOperation = document.getElementById('current-operation');
        const connectionTestResult = document.getElementById('connection-test-result');
        
        // Estado de la configuración
        let firebaseApp = null;
        let db = null;
        let auth = null;
        let isConfiguring = false;
        
        // Probar conexión a Firebase
        testConnectionBtn.addEventListener('click', async () => {
            const configText = document.getElementById('firebase-config').value;
            
            if (!configText) {
                connectionTestResult.innerHTML = '<span style="color: #dc2626;">Ingresa la configuración primero</span>';
                return;
            }
            
            try {
                const config = JSON.parse(configText);
                connectionTestResult.innerHTML = '<span style="color: #059669;">Probando conexión...</span>';
                
                // Intentar inicializar Firebase
                firebaseApp = firebase.initializeApp(config);
                db = firebase.firestore();
                auth = firebase.auth();
                
                // Probar conexión simple
                await db.collection('test').limit(1).get();
                
                connectionTestResult.innerHTML = '<span style="color: #059669;">✅ Conexión exitosa</span>';
                startSetupBtn.disabled = false;
                
            } catch (error) {
                console.error('Error de conexión:', error);
                connectionTestResult.innerHTML = `<span style="color: #dc2626;">Error: ${error.message}</span>`;
                startSetupBtn.disabled = true;
            }
        });
        
        // Iniciar configuración completa
        startSetupBtn.addEventListener('click', async () => {
            if (isConfiguring) return;
            
            // Validar campos requeridos
            if (!validateRequiredFields()) {
                return;
            }
            
            isConfiguring = true;
            startSetupBtn.disabled = true;
            startSetupBtn.textContent = 'Configurando...';
            
            // Recopilar datos del formulario
            const businessData = {
                name: document.getElementById('business-name').value,
                address: document.getElementById('business-address').value,
                phone: document.getElementById('business-phone').value,
                email: document.getElementById('business-email').value,
                logo: document.getElementById('business-logo').value || null
            };
            
            const localData = {
                name: document.getElementById('local-name').value,
                code: document.getElementById('local-code').value.toUpperCase(),
                address: document.getElementById('local-address').value,
                phone: document.getElementById('local-phone').value,
                openingHours: document.getElementById('local-opening').value,
                isActive: true,
                createdAt: new Date().toISOString()
            };
            
            const adminEmail = document.getElementById('admin-email').value || 'admin@comercio.com';
            const createProducts = document.getElementById('create-products').checked;
            const productCategory = document.getElementById('product-category').value;
            
            try {
                // Paso 1: Crear estructura de colecciones
                updateProgress('Creando estructura de base de datos...', 10);
                await createDatabaseStructure();
                
                // Paso 2: Crear negocio principal
                updateProgress('Creando datos del negocio...', 20);
                const businessId = await createBusiness(businessData);
                
                // Paso 3: Crear local principal
                updateProgress('Creando local principal...', 30);
                const localId = await createLocal(localData, businessId);
                
                // Paso 4: Crear usuarios
                updateProgress('Creando usuarios de prueba...', 50);
                await createUsers(adminEmail, localId);
                
                // Paso 5: Crear productos de prueba
                if (createProducts) {
                    updateProgress('Creando productos de prueba...', 70);
                    await createSampleProducts(localId, productCategory);
                }
                
                // Paso 6: Configurar permisos iniciales
                updateProgress('Configurando permisos...', 90);
                await setupInitialPermissions(localId);
                
                // Finalizar
                updateProgress('Configuración completada', 100);
                
                // Mostrar pantalla de éxito
                setTimeout(() => {
                    setupForm.style.display = 'none';
                    setupComplete.style.display = 'block';
                }, 1000);
                
            } catch (error) {
                showError(`Error durante la configuración: ${error.message}`);
                console.error('Setup error:', error);
                isConfiguring = false;
                startSetupBtn.disabled = false;
                startSetupBtn.textContent = 'Iniciar Configuración';
            }
        });
        
        // Funciones de configuración
        async function createDatabaseStructure() {
            // Crear colecciones base con documentos iniciales
            const collections = [
                'businesses',
                'locals',
                'users',
                'products',
                'categories',
                'clients',
                'providers',
                'sales',
                'budgets',
                'cashboxes',
                'settings'
            ];
            
            // Solo creamos documentos de configuración, Firestore crea colecciones al primer documento
            await db.collection('system').doc('config').set({
                version: '1.0.0',
                setupDate: new Date().toISOString(),
                setupCompleted: true
            });
        }
        
        async function createBusiness(data) {
            const businessRef = db.collection('businesses').doc();
            await businessRef.set({
                ...data,
                id: businessRef.id,
                createdAt: new Date().toISOString(),
                updatedAt: new Date().toISOString()
            });
            return businessRef.id;
        }
        
        async function createLocal(data, businessId) {
            const localRef = db.collection('locals').doc();
            await localRef.set({
                ...data,
                id: localRef.id,
                businessId: businessId,
                createdAt: new Date().toISOString(),
                updatedAt: new Date().toISOString()
            });
            return localRef.id;
        }
        
        async function createUsers(adminEmail, localId) {
            // Usuario Administrador
            await auth.createUserWithEmailAndPassword(adminEmail, 'admin123');
            
            const adminUserRef = db.collection('users').doc();
            await adminUserRef.set({
                id: adminUserRef.id,
                email: adminEmail,
                name: 'Administrador Principal',
                role: 'admin',
                localId: localId,
                isActive: true,
                createdAt: new Date().toISOString(),
                createdBy: 'system'
            });
            
            // Usuario Cajero
            await auth.createUserWithEmailAndPassword('cajero@comercio.com', 'cajero123');
            
            const cashierUserRef = db.collection('users').doc();
            await cashierUserRef.set({
                id: cashierUserRef.id,
                email: 'cajero@comercio.com',
                name: 'Cajero de Prueba',
                role: 'cajero',
                localId: localId,
                isActive: true,
                createdAt: new Date().toISOString(),
                createdBy: 'system'
            });
            
            // Usuario Vendedor
            await auth.createUserWithEmailAndPassword('vendedor@comercio.com', 'vendedor123');
            
            const sellerUserRef = db.collection('users').doc();
            await sellerUserRef.set({
                id: sellerUserRef.id,
                email: 'vendedor@comercio.com',
                name: 'Vendedor de Prueba',
                role: 'vendedor',
                localId: localId,
                isActive: true,
                createdAt: new Date().toISOString(),
                createdBy: 'system'
            });
        }
        
        async function createSampleProducts(localId, category) {
            const sampleProducts = generateSampleProducts(50, category);
            
            // Crear categoría
            const categoryRef = db.collection('categories').doc();
            await categoryRef.set({
                id: categoryRef.id,
                name: category.charAt(0).toUpperCase() + category.slice(1),
                localId: localId,
                isActive: true,
                createdAt: new Date().toISOString()
            });
            
            // Crear productos
            for (const product of sampleProducts) {
                const productRef = db.collection('products').doc();
                await productRef.set({
                    ...product,
                    id: productRef.id,
                    localId: localId,
                    categoryId: categoryRef.id,
                    createdAt: new Date().toISOString(),
                    updatedAt: new Date().toISOString()
                });
            }
        }
        
        async function setupInitialPermissions(localId) {
            // Configuración inicial de permisos
            const settingsRef = db.collection('settings').doc('permissions');
            await settingsRef.set({
                localId: localId,
                roles: {
                    admin: ['all'],
                    supervisor: ['read', 'write', 'approve'],
                    cajero: ['sales', 'cashbox', 'read_products'],
                    vendedor: ['sales', 'read_products', 'budgets']
                },
                updatedAt: new Date().toISOString()
            });
        }
        
        function generateSampleProducts(count, category) {
            const products = [];
            const categories = {
                alimentos: ['Arroz', 'Fideos', 'Aceite', 'Harina', 'Azúcar', 'Sal', 'Galletas', 'Conservas'],
                bebidas: ['Agua', 'Gaseosa', 'Jugo', 'Cerveza', 'Vino', 'Refresco', 'Energizante'],
                limpieza: ['Jabón', 'Detergente', 'Lavandina', 'Desinfectante', 'Esponja', 'Papel Higiénico'],
                electronica: ['Cable USB', 'Pila AA', 'Foco LED', 'Adaptador', 'Batería', 'Cargador'],
                general: ['Cuaderno', 'Lápiz', 'Resma Papel', 'Cinta', 'Tijera', 'Goma', 'Marcador']
            };
            
            const baseProducts = categories[category] || categories.general;
            
            for (let i = 1; i <= count; i++) {
                const nameIndex = i % baseProducts.length;
                const product = {
                    code: `PROD${String(i).padStart(5, '0')}`,
                    barcode: `789${String(1000000 + i).padStart(10, '0')}`,
                    name: `${baseProducts[nameIndex]} ${i}`,
                    description: `${baseProducts[nameIndex]} de prueba ${i}`,
                    cost: parseFloat((Math.random() * 100 + 10).toFixed(2)),
                    margin: parseFloat((Math.random() * 50 + 20).toFixed(2)),
                    price: 0, // Se calcula en la función
                    stock: Math.floor(Math.random() * 100),
                    minStock: 10,
                    unit: 'unidad',
                    isActive: true,
                    hasStockControl: true
                };
                
                product.price = parseFloat((product.cost * (1 + product.margin / 100)).toFixed(2));
                
                products.push(product);
            }
            
            return products;
        }
        
        function validateRequiredFields() {
            const requiredFields = [
                'business-name',
                'local-name',
                'local-code'
            ];
            
            let isValid = true;
            
            requiredFields.forEach(fieldId => {
                const field = document.getElementById(fieldId);
                if (!field.value.trim()) {
                    field.style.borderColor = '#dc2626';
                    isValid = false;
                } else {
                    field.style.borderColor = '';
                }
            });
            
            if (!isValid) {
                showError('Completa todos los campos requeridos (*)');
            }
            
            return isValid;
        }
        
        function updateProgress(message, percentage) {
            currentOperation.textContent = message;
            progressFill.style.width = `${percentage}%`;
            
            // Mostrar mensaje de progreso
            const progressMsg = document.createElement('div');
            progressMsg.className = 'status-info';
            progressMsg.textContent = `✓ ${message}`;
            statusMessages.appendChild(progressMsg);
            
            // Scroll al final
            statusMessages.scrollTop = statusMessages.scrollHeight;
        }
        
        function showError(message) {
            const errorMsg = document.createElement('div');
            errorMsg.className = 'status-error';
            errorMsg.textContent = message;
            statusMessages.appendChild(errorMsg);
            
            // Scroll al final
            statusMessages.scrollTop = statusMessages.scrollHeight;
        }
        
        // Inicializar botón
        startSetupBtn.disabled = true;
    </script>
</body>
</html>
