<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Configuraci√≥n Sistema POS</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
            background: linear-gradient(135deg, #0ea5e9 0%, #3b82f6 100%);
            min-height: 100vh;
            padding: 20px;
            color: #333;
        }

        .setup-container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            overflow: hidden;
        }

        .setup-header {
            background: linear-gradient(135deg, #1e40af 0%, #3b82f6 100%);
            color: white;
            padding: 30px 40px;
            text-align: center;
        }

        .setup-header h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 15px;
        }

        .setup-header p {
            font-size: 1.1rem;
            opacity: 0.9;
        }

        .setup-progress {
            display: flex;
            background: #e5e7eb;
            padding: 0;
        }

        .progress-step {
            flex: 1;
            padding: 20px;
            text-align: center;
            font-weight: 600;
            color: #6b7280;
            border-bottom: 4px solid transparent;
            cursor: pointer;
            transition: all 0.3s;
        }

        .progress-step.active {
            color: #3b82f6;
            border-bottom-color: #3b82f6;
            background: #f0f9ff;
        }

        .progress-step.completed {
            color: #10b981;
            border-bottom-color: #10b981;
        }

        .setup-content {
            padding: 40px;
            min-height: 500px;
        }

        .step {
            display: none;
            animation: fadeIn 0.5s ease;
        }

        .step.active {
            display: block;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .step-header {
            margin-bottom: 30px;
        }

        .step-header h2 {
            color: #1e40af;
            font-size: 1.8rem;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .step-header p {
            color: #6b7280;
            font-size: 1.1rem;
        }

        .form-group {
            margin-bottom: 25px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #374151;
            font-size: 1rem;
        }

        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 14px;
            border: 2px solid #d1d5db;
            border-radius: 10px;
            font-size: 1rem;
            transition: all 0.3s;
        }

        .form-group input:focus,
        .form-group select:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: #3b82f6;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }

        .form-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
        }

        .help-text {
            display: block;
            margin-top: 6px;
            font-size: 0.9rem;
            color: #6b7280;
        }

        .btn {
            padding: 14px 28px;
            border: none;
            border-radius: 10px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }

        .btn-primary {
            background: #3b82f6;
            color: white;
        }

        .btn-primary:hover:not(:disabled) {
            background: #2563eb;
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(59, 130, 246, 0.4);
        }

        .btn-secondary {
            background: #e5e7eb;
            color: #374151;
        }

        .btn-secondary:hover:not(:disabled) {
            background: #d1d5db;
        }

        .btn-success {
            background: #10b981;
            color: white;
        }

        .btn-success:hover:not(:disabled) {
            background: #059669;
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(16, 185, 129, 0.4);
        }

        .btn-warning {
            background: #f59e0b;
            color: white;
        }

        .btn-warning:hover:not(:disabled) {
            background: #d97706;
        }

        .btn-danger {
            background: #ef4444;
            color: white;
        }

        .btn-danger:hover:not(:disabled) {
            background: #dc2626;
        }

        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        .setup-actions {
            display: flex;
            justify-content: space-between;
            margin-top: 40px;
            padding-top: 20px;
            border-top: 2px solid #e5e7eb;
        }

        .alert {
            padding: 16px;
            border-radius: 10px;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .alert-info {
            background: #dbeafe;
            color: #1e40af;
            border: 2px solid #bfdbfe;
        }

        .alert-success {
            background: #d1fae5;
            color: #065f46;
            border: 2px solid #a7f3d0;
        }

        .alert-warning {
            background: #fef3c7;
            color: #92400e;
            border: 2px solid #fde68a;
        }

        .alert-error {
            background: #fee2e2;
            color: #7f1d1d;
            border: 2px solid #fecaca;
        }

        .code-block {
            background: #1f2937;
            color: #e5e7eb;
            padding: 20px;
            border-radius: 10px;
            font-family: 'Courier New', monospace;
            font-size: 0.9rem;
            overflow-x: auto;
            margin: 20px 0;
            position: relative;
            max-height: 500px;
            overflow-y: auto;
        }

        .copy-btn {
            position: absolute;
            top: 10px;
            right: 10px;
            padding: 8px 16px;
            background: #3b82f6;
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.9rem;
        }

        .copy-btn:hover {
            background: #2563eb;
        }

        .table-container {
            overflow-x: auto;
            margin: 20px 0;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            background: white;
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }

        th, td {
            padding: 15px;
            text-align: left;
            border-bottom: 1px solid #e5e7eb;
        }

        th {
            background: #f9fafb;
            font-weight: 600;
            color: #374151;
        }

        tr:hover {
            background: #f9fafb;
        }

        .checklist {
            list-style: none;
            padding: 0;
        }

        .checklist li {
            padding: 12px 0;
            border-bottom: 1px solid #e5e7eb;
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .checklist li:last-child {
            border-bottom: none;
        }

        .checklist-icon {
            width: 24px;
            height: 24px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
        }

        .checklist-icon.completed {
            background: #10b981;
            color: white;
        }

        .checklist-icon.pending {
            background: #e5e7eb;
            color: #6b7280;
        }

        .status-badge {
            display: inline-block;
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 0.9rem;
            font-weight: 600;
        }

        .status-success {
            background: #d1fae5;
            color: #065f46;
        }

        .status-warning {
            background: #fef3c7;
            color: #92400e;
        }

        .status-error {
            background: #fee2e2;
            color: #7f1d1d;
        }

        .config-summary {
            background: #f9fafb;
            border-radius: 10px;
            padding: 25px;
            margin: 20px 0;
        }

        .config-summary h3 {
            margin-bottom: 15px;
            color: #1e40af;
        }

        .summary-item {
            display: flex;
            justify-content: space-between;
            padding: 10px 0;
            border-bottom: 1px solid #e5e7eb;
        }

        .summary-item:last-child {
            border-bottom: none;
        }

        .summary-item .label {
            color: #6b7280;
        }

        .summary-item .value {
            font-weight: 600;
            color: #374151;
        }

        .file-upload {
            border: 2px dashed #d1d5db;
            border-radius: 10px;
            padding: 40px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
        }

        .file-upload:hover {
            border-color: #3b82f6;
            background: #f0f9ff;
        }

        .file-upload.drag-over {
            border-color: #10b981;
            background: #d1fae5;
        }

        .file-upload input {
            display: none;
        }

        .test-connection {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            padding: 10px 20px;
            background: #f0f9ff;
            border: 2px solid #bfdbfe;
            border-radius: 8px;
            color: #1e40af;
            font-weight: 600;
            cursor: pointer;
            margin-top: 10px;
        }

        .test-connection:hover {
            background: #dbeafe;
        }

        .test-result {
            margin-top: 10px;
            padding: 10px;
            border-radius: 8px;
            display: none;
        }

        .test-result.success {
            background: #d1fae5;
            color: #065f46;
            border: 2px solid #a7f3d0;
            display: block;
        }

        .test-result.error {
            background: #fee2e2;
            color: #7f1d1d;
            border: 2px solid #fecaca;
            display: block;
        }

        .spinner {
            width: 20px;
            height: 20px;
            border: 3px solid #f3f3f3;
            border-top: 3px solid #3b82f6;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .loading {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 60px;
            text-align: center;
        }

        .loading p {
            margin-top: 20px;
            color: #6b7280;
        }

        .success-screen {
            text-align: center;
            padding: 60px 40px;
        }

        .success-icon {
            width: 80px;
            height: 80px;
            background: #10b981;
            color: white;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 30px;
            font-size: 2.5rem;
        }

        .success-screen h2 {
            color: #1e40af;
            margin-bottom: 15px;
        }

        .success-screen p {
            color: #6b7280;
            margin-bottom: 30px;
            font-size: 1.1rem;
            max-width: 600px;
            margin-left: auto;
            margin-right: auto;
        }

        @media (max-width: 768px) {
            .setup-container {
                margin: 10px;
            }
            
            .setup-content {
                padding: 20px;
            }
            
            .form-row {
                grid-template-columns: 1fr;
            }
            
            .setup-actions {
                flex-direction: column;
                gap: 15px;
            }
            
            .setup-actions .btn {
                width: 100%;
            }
        }
    </style>
</head>
<body>
    <div class="setup-container">
        <div class="setup-header">
            <h1>‚öôÔ∏è Configuraci√≥n Sistema POS</h1>
            <p>Asistente de configuraci√≥n completa para el sistema de punto de venta</p>
        </div>

        <div class="setup-progress">
            <div class="progress-step active" data-step="1">1. Supabase</div>
            <div class="progress-step" data-step="2">2. Base de Datos</div>
            <div class="progress-step" data-step="3">3. Empresa</div>
            <div class="progress-step" data-step="4">4. Locales</div>
            <div class="progress-step" data-step="5">5. Usuarios</div>
            <div class="progress-step" data-step="6">6. Productos</div>
            <div class="progress-step" data-step="7">7. Finalizar</div>
        </div>

        <div class="setup-content">
            <!-- Paso 1: Configuraci√≥n Supabase -->
            <div class="step active" id="step1">
                <div class="step-header">
                    <h2>üì° Configuraci√≥n de Supabase</h2>
                    <p>Conecta tu sistema con Supabase para habilitar sincronizaci√≥n en tiempo real y almacenamiento seguro</p>
                </div>

                <div class="alert alert-info">
                    <span>‚ÑπÔ∏è</span>
                    <div>
                        <strong>Necesitar√°s:</strong>
                        <p>1. Una cuenta en <a href="https://supabase.com" target="_blank">Supabase.com</a></p>
                        <p>2. Un proyecto creado en Supabase</p>
                        <p>3. Las credenciales de API (URL y clave an√≥nima)</p>
                    </div>
                </div>

                <div class="form-group">
                    <label for="supabaseUrl">URL de Supabase:</label>
                    <input type="url" id="supabaseUrl" placeholder="https://xxxxxxxxxxxx.supabase.co" required>
                    <span class="help-text">Encu√©ntralo en Settings > API de tu proyecto Supabase</span>
                </div>

                <div class="form-group">
                    <label for="supabaseKey">Clave An√≥nima:</label>
                    <input type="password" id="supabaseKey" placeholder="eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9..." required>
                    <span class="help-text">Clave de la secci√≥n Project API keys (anon public)</span>
                </div>

                <div class="test-connection" id="testConnection">
                    <span>üîç</span> Probar Conexi√≥n
                </div>

                <div class="test-result" id="testResult"></div>

                <div class="config-summary" id="supabaseConfig">
                    <h3>‚úÖ Configuraci√≥n Supabase Guardada</h3>
                    <div class="summary-item">
                        <span class="label">URL:</span>
                        <span class="value" id="configUrl">No configurado</span>
                    </div>
                    <div class="summary-item">
                        <span class="label">Estado:</span>
                        <span class="value"><span class="status-badge status-warning">No verificado</span></span>
                    </div>
                </div>

                <div class="setup-actions">
                    <div></div>
                    <button class="btn btn-primary" onclick="nextStep()">Siguiente ‚Üí</button>
                </div>
            </div>

            <!-- Paso 2: Base de Datos -->
            <div class="step" id="step2">
                <div class="step-header">
                    <h2>üóÑÔ∏è Configuraci√≥n de Base de Datos</h2>
                    <p>Crea la estructura de base de datos necesaria para el sistema</p>
                </div>

                <div class="alert alert-warning">
                    <span>‚ö†Ô∏è</span>
                    <div>
                        <strong>Importante:</strong>
                        <p>Este paso crear√° todas las tablas necesarias en tu base de datos Supabase.</p>
                        <p>Aseg√∫rate de tener permisos de administrador en el proyecto.</p>
                    </div>
                </div>

                <div class="code-block">
                    <button class="copy-btn" onclick="copySQL()">üìã Copiar SQL</button>
                    <pre id="sqlCode">-- SQL para crear las tablas del sistema POS
-- Este c√≥digo debe ejecutarse en el SQL Editor de Supabase</pre>
                </div>

                <div class="alert alert-info">
                    <span>üìã</span>
                    <div>
                        <strong>Instrucciones:</strong>
                        <p>1. Copia el c√≥digo SQL mostrado arriba</p>
                        <p>2. Ve a tu proyecto Supabase > SQL Editor</p>
                        <p>3. Pega el c√≥digo y ejec√∫talo</p>
                        <p>4. Regresa aqu√≠ y verifica la conexi√≥n</p>
                    </div>
                </div>

                <div class="form-group">
                    <label>Verificaci√≥n de Tablas:</label>
                    <button class="btn btn-secondary" onclick="verifyDatabase()" id="verifyBtn">
                        üîç Verificar Estructura de BD
                    </button>
                    <div id="verifyResult" class="test-result"></div>
                </div>

                <div class="config-summary">
                    <h3>‚úÖ Tablas Requeridas</h3>
                    <div class="checklist" id="tablesChecklist">
                        <!-- Se llena din√°micamente -->
                    </div>
                </div>

                <div class="setup-actions">
                    <button class="btn btn-secondary" onclick="prevStep()">‚Üê Anterior</button>
                    <button class="btn btn-primary" onclick="nextStep()" id="step2Next" disabled>Siguiente ‚Üí</button>
                </div>
            </div>

            <!-- Paso 3: Configuraci√≥n de Empresa -->
            <div class="step" id="step3">
                <div class="step-header">
                    <h2>üè¢ Informaci√≥n de la Empresa</h2>
                    <p>Configura los datos b√°sicos de tu negocio</p>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label for="empresaNombre">Nombre de la Empresa:</label>
                        <input type="text" id="empresaNombre" placeholder="Mi Ferreter√≠a S.A." required>
                    </div>
                    <div class="form-group">
                        <label for="empresaCuit">CUIT:</label>
                        <input type="text" id="empresaCuit" placeholder="30-12345678-9" pattern="\d{2}-\d{8}-\d{1}">
                    </div>
                </div>

                <div class="form-group">
                    <label for="empresaDireccion">Direcci√≥n:</label>
                    <input type="text" id="empresaDireccion" placeholder="Av. Principal 1234" required>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label for="empresaTelefono">Tel√©fono:</label>
                        <input type="tel" id="empresaTelefono" placeholder="011-1234-5678" required>
                    </div>
                    <div class="form-group">
                        <label for="empresaEmail">Email:</label>
                        <input type="email" id="empresaEmail" placeholder="info@empresa.com" required>
                    </div>
                </div>

                <div class="form-group">
                    <label for="empresaConfig">Configuraci√≥n Adicional:</label>
                    <textarea id="empresaConfig" rows="4" placeholder="Configuraciones espec√≠ficas de la empresa..."></textarea>
                    <span class="help-text">Configuraciones personalizadas en formato JSON</span>
                </div>

                <div class="config-summary">
                    <h3>üìã Resumen Empresa</h3>
                    <div class="summary-item">
                        <span class="label">Nombre:</span>
                        <span class="value" id="summaryNombre">No configurado</span>
                    </div>
                    <div class="summary-item">
                        <span class="label">CUIT:</span>
                        <span class="value" id="summaryCuit">No configurado</span>
                    </div>
                    <div class="summary-item">
                        <span class="label">Direcci√≥n:</span>
                        <span class="value" id="summaryDireccion">No configurado</span>
                    </div>
                </div>

                <div class="setup-actions">
                    <button class="btn btn-secondary" onclick="prevStep()">‚Üê Anterior</button>
                    <button class="btn btn-primary" onclick="saveEmpresa()">Guardar y Continuar ‚Üí</button>
                </div>
            </div>

            <!-- Paso 4: Locales y Cajas -->
            <div class="step" id="step4">
                <div class="step-header">
                    <h2>üè™ Configuraci√≥n de Locales</h2>
                    <p>Define tus sucursales y cajas registradoras</p>
                </div>

                <div class="alert alert-info">
                    <span>üè™</span>
                    <div>
                        <p>Agrega al menos un local y una caja para comenzar a operar.</p>
                        <p>Puedes agregar m√°s locales y cajas despu√©s desde la aplicaci√≥n.</p>
                    </div>
                </div>

                <div class="form-group">
                    <h3>Local Principal</h3>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="localNombre">Nombre del Local:</label>
                            <input type="text" id="localNombre" placeholder="Sucursal Central" required>
                        </div>
                        <div class="form-group">
                            <label for="localTelefono">Tel√©fono:</label>
                            <input type="tel" id="localTelefono" placeholder="011-9876-5432">
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="localDireccion">Direcci√≥n del Local:</label>
                        <input type="text" id="localDireccion" placeholder="Direcci√≥n del local">
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="localHorario">Horario de Atenci√≥n:</label>
                            <input type="text" id="localHorario" placeholder="Lun-Vie 9:00-18:00, S√°b 9:00-13:00">
                        </div>
                        <div class="form-group">
                            <label for="localResponsable">Responsable:</label>
                            <input type="text" id="localResponsable" placeholder="Nombre del responsable">
                        </div>
                    </div>
                </div>

                <div class="form-group">
                    <h3>Caja Registradora</h3>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="cajaNumero">N√∫mero de Caja:</label>
                            <input type="text" id="cajaNumero" placeholder="Caja 01" required>
                        </div>
                        <div class="form-group">
                            <label for="cajaNombre">Nombre de Caja:</label>
                            <input type="text" id="cajaNombre" placeholder="Caja Principal">
                        </div>
                    </div>
                </div>

                <div class="form-group">
                    <h3>Turnos de Trabajo</h3>
                    <div class="form-row">
                        <div class="form-group">
                            <label>
                                <input type="checkbox" id="turnoManana" checked> Ma√±ana (8:00 - 13:00)
                            </label>
                        </div>
                        <div class="form-group">
                            <label>
                                <input type="checkbox" id="turnoTarde" checked> Tarde (14:00 - 19:00)
                            </label>
                        </div>
                        <div class="form-group">
                            <label>
                                <input type="checkbox" id="turnoNoche"> Noche (20:00 - 02:00)
                            </label>
                        </div>
                    </div>
                </div>

                <div class="config-summary">
                    <h3>‚úÖ Configuraci√≥n Local</h3>
                    <div class="summary-item">
                        <span class="label">Local:</span>
                        <span class="value" id="summaryLocal">No configurado</span>
                    </div>
                    <div class="summary-item">
                        <span class="label">Caja:</span>
                        <span class="value" id="summaryCaja">No configurado</span>
                    </div>
                    <div class="summary-item">
                        <span class="label">Turnos:</span>
                        <span class="value" id="summaryTurnos">No configurado</span>
                    </div>
                </div>

                <div class="setup-actions">
                    <button class="btn btn-secondary" onclick="prevStep()">‚Üê Anterior</button>
                    <button class="btn btn-primary" onclick="saveLocal()">Guardar y Continuar ‚Üí</button>
                </div>
            </div>

            <!-- Paso 5: Usuarios -->
            <div class="step" id="step5">
                <div class="step-header">
                    <h2>üë• Configuraci√≥n de Usuarios</h2>
                    <p>Crea los usuarios del sistema con sus permisos correspondientes</p>
                </div>

                <div class="alert alert-warning">
                    <span>üîê</span>
                    <div>
                        <strong>Usuario Administrador</strong>
                        <p>Debes crear al menos un usuario administrador para gestionar el sistema.</p>
                        <p>Este usuario tendr√° acceso completo a todas las funcionalidades.</p>
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label for="adminNombre">Nombre:</label>
                        <input type="text" id="adminNombre" placeholder="Juan P√©rez" required>
                    </div>
                    <div class="form-group">
                        <label for="adminEmail">Email:</label>
                        <input type="email" id="adminEmail" placeholder="admin@empresa.com" required>
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label for="adminPassword">Contrase√±a:</label>
                        <input type="password" id="adminPassword" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" required minlength="8">
                    </div>
                    <div class="form-group">
                        <label for="adminPasswordConfirm">Confirmar Contrase√±a:</label>
                        <input type="password" id="adminPasswordConfirm" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" required minlength="8">
                    </div>
                </div>

                <div class="form-group">
                    <label for="adminRol">Rol:</label>
                    <select id="adminRol">
                        <option value="administrador">Administrador (Acceso completo)</option>
                        <option value="gerente">Gerente (Gesti√≥n operativa)</option>
                        <option value="supervisor">Supervisor (Supervisi√≥n)</option>
                        <option value="vendedor">Vendedor (Ventas b√°sicas)</option>
                    </select>
                </div>

                <div class="form-group">
                    <h3>Vendedores Adicionales (Opcional)</h3>
                    <div id="vendedoresContainer">
                        <!-- Se agregan din√°micamente -->
                    </div>
                    <button type="button" class="btn btn-secondary" onclick="agregarVendedor()" style="margin-top: 10px;">
                        + Agregar Vendedor
                    </button>
                </div>

                <div class="config-summary">
                    <h3>üë• Usuarios a Crear</h3>
                    <div class="checklist" id="usersChecklist">
                        <!-- Se llena din√°micamente -->
                    </div>
                </div>

                <div class="setup-actions">
                    <button class="btn btn-secondary" onclick="prevStep()">‚Üê Anterior</button>
                    <button class="btn btn-primary" onclick="createUsers()">Crear Usuarios y Continuar ‚Üí</button>
                </div>
            </div>

            <!-- Paso 6: Productos Iniciales -->
            <div class="step" id="step6">
                <div class="step-header">
                    <h2>üì¶ Productos Iniciales</h2>
                    <p>Configura tus productos, categor√≠as y stock inicial</p>
                </div>

                <div class="alert alert-info">
                    <span>üìã</span>
                    <div>
                        <p>Puedes cargar productos manualmente o importar desde un archivo Excel.</p>
                        <p>Es recomendable cargar al menos algunos productos de ejemplo para probar el sistema.</p>
                    </div>
                </div>

                <div class="form-group">
                    <h3>Opci√≥n 1: Cargar desde Excel</h3>
                    <div class="file-upload" id="excelUpload" onclick="document.getElementById('excelFile').click()">
                        <div style="font-size: 3rem;">üì•</div>
                        <p><strong>Arrastra y suelta tu archivo Excel aqu√≠</strong></p>
                        <p>o haz clic para seleccionar</p>
                        <p class="help-text">Formatos soportados: .xlsx, .xls, .csv</p>
                        <input type="file" id="excelFile" accept=".xlsx,.xls,.csv" onchange="handleExcelUpload(event)">
                    </div>
                    <div id="excelPreview" class="table-container" style="display: none; margin-top: 20px;">
                        <h4>Vista previa de productos</h4>
                        <table id="previewTable">
                            <thead>
                                <tr>
                                    <th>C√≥digo</th>
                                    <th>Nombre</th>
                                    <th>Categor√≠a</th>
                                    <th>Precio</th>
                                    <th>Stock</th>
                                </tr>
                            </thead>
                            <tbody></tbody>
                        </table>
                    </div>
                </div>

                <div class="form-group">
                    <h3>Opci√≥n 2: Cargar productos de ejemplo (Ferreter√≠a)</h3>
                    <button class="btn btn-secondary" onclick="loadSampleProducts()">
                        üìã Cargar Productos de Ejemplo
                    </button>
                    <span class="help-text">Carga productos de ferreter√≠a predeterminados para pruebas</span>
                </div>

                <div class="form-group">
                    <h3>Opci√≥n 3: Configurar manualmente despu√©s</h3>
                    <p>Puedes saltar este paso y configurar los productos directamente desde la aplicaci√≥n.</p>
                    <label>
                        <input type="checkbox" id="skipProducts"> Saltar configuraci√≥n de productos
                    </label>
                </div>

                <div class="config-summary">
                    <h3>üì¶ Productos a Importar</h3>
                    <div class="summary-item">
                        <span class="label">Total productos:</span>
                        <span class="value" id="productCount">0</span>
                    </div>
                    <div class="summary-item">
                        <span class="label">Categor√≠as:</span>
                        <span class="value" id="categoryCount">0</span>
                    </div>
                    <div class="summary-item">
                        <span class="label">Stock total:</span>
                        <span class="value" id="totalStock">0</span>
                    </div>
                </div>

                <div class="setup-actions">
                    <button class="btn btn-secondary" onclick="prevStep()">‚Üê Anterior</button>
                    <button class="btn btn-primary" onclick="saveProducts()">Continuar ‚Üí</button>
                </div>
            </div>

            <!-- Paso 7: Finalizaci√≥n -->
            <div class="step" id="step7">
                <div class="loading" id="finalLoading">
                    <div class="spinner" style="width: 40px; height: 40px;"></div>
                    <h2>Configurando Sistema...</h2>
                    <p>Estamos aplicando todas las configuraciones. Esto puede tomar unos segundos.</p>
                </div>

                <div class="success-screen" id="successScreen" style="display: none;">
                    <div class="success-icon">‚úì</div>
                    <h2>¬°Configuraci√≥n Completada!</h2>
                    <p>El sistema POS ha sido configurado exitosamente. Ahora puedes comenzar a utilizar todas las funcionalidades.</p>
                    
                    <div class="config-summary" style="margin: 30px auto; max-width: 600px;">
                        <h3>‚úÖ Configuraci√≥n Aplicada</h3>
                        <div class="summary-item">
                            <span class="label">Sistema:</span>
                            <span class="value">POS Ferreter√≠a v2.0</span>
                        </div>
                        <div class="summary-item">
                            <span class="label">Base de Datos:</span>
                            <span class="value"><span class="status-badge status-success">Configurada</span></span>
                        </div>
                        <div class="summary-item">
                            <span class="label">Empresa:</span>
                            <span class="value" id="finalEmpresa">-</span>
                        </div>
                        <div class="summary-item">
                            <span class="label">Usuarios creados:</span>
                            <span class="value" id="finalUsuarios">0</span>
                        </div>
                        <div class="summary-item">
                            <span class="label">Productos cargados:</span>
                            <span class="value" id="finalProductos">0</span>
                        </div>
                    </div>

                    <div style="display: flex; gap: 15px; justify-content: center; margin-top: 30px;">
                        <button class="btn btn-success" onclick="goToLogin()">
                            üöÄ Iniciar Sistema
                        </button>
                        <button class="btn btn-secondary" onclick="downloadConfig()">
                            üìÑ Descargar Configuraci√≥n
                        </button>
                    </div>

                    <div class="alert alert-info" style="margin-top: 30px; text-align: left;">
                        <strong>üìã Pr√≥ximos pasos recomendados:</strong>
                        <ol style="margin-top: 10px; padding-left: 20px;">
                            <li>Accede al sistema con el usuario administrador creado</li>
                            <li>Configura m√©todos de pago en Configuraci√≥n > Pagos</li>
                            <li>Revisa y ajusta los precios de los productos</li>
                            <li>Abre tu primera caja del d√≠a en POS > Caja</li>
                            <li>Realiza una venta de prueba</li>
                        </ol>
                    </div>
                </div>

                <div class="setup-actions" id="finalActions" style="display: none;">
                    <button class="btn btn-secondary" onclick="prevStep()">‚Üê Anterior</button>
                    <button class="btn btn-success" onclick="completeSetup()">Finalizar Configuraci√≥n</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Variables globales
        let currentStep = 1;
        let supabaseClient = null;
        let setupData = {
            supabase: {},
            empresa: {},
            local: {},
            usuarios: [],
            productos: [],
            config: {}
        };

        // SQL completo con todas las tablas
        const completeSQL = `-- ============================================
-- SISTEMA POS - TABLAS COMPLETAS
-- ============================================

-- 1. TABLA DE LOCALES/SUCURSALES
CREATE TABLE IF NOT EXISTS locales (
    id UUID DEFAULT gen_random_uuid() PRIMARY KEY,
    nombre VARCHAR(100) NOT NULL,
    direccion TEXT,
    telefono VARCHAR(20),
    email VARCHAR(100),
    horario_atencion VARCHAR(100),
    responsable VARCHAR(100),
    activo BOOLEAN DEFAULT true,
    created_at TIMESTAMP DEFAULT NOW(),
    updated_at TIMESTAMP DEFAULT NOW()
);

-- 2. TABLA DE CAJAS
CREATE TABLE IF NOT EXISTS cajas (
    id UUID DEFAULT gen_random_uuid() PRIMARY KEY,
    numero VARCHAR(20) NOT NULL,
    nombre VARCHAR(100),
    local_id UUID REFERENCES locales(id),
    activo BOOLEAN DEFAULT true,
    created_at TIMESTAMP DEFAULT NOW()
);

-- 3. TABLA DE USUARIOS
CREATE TABLE IF NOT EXISTS usuarios (
    id UUID DEFAULT gen_random_uuid() PRIMARY KEY,
    email VARCHAR(255) UNIQUE NOT NULL,
    password_hash VARCHAR(255) NOT NULL,
    nombre VARCHAR(100) NOT NULL,
    apellido VARCHAR(100),
    rol VARCHAR(50) DEFAULT 'vendedor',
    local_id UUID REFERENCES locales(id),
    activo BOOLEAN DEFAULT true,
    created_at TIMESTAMP DEFAULT NOW(),
    updated_at TIMESTAMP DEFAULT NOW()
);

-- 4. TABLA DE PROVEEDORES
CREATE TABLE IF NOT EXISTS proveedores (
    id UUID DEFAULT gen_random_uuid() PRIMARY KEY,
    nombre VARCHAR(100) NOT NULL,
    razon_social VARCHAR(200),
    contacto VARCHAR(100),
    telefono VARCHAR(20),
    email VARCHAR(100),
    direccion TEXT,
    localidad VARCHAR(100),
    provincia VARCHAR(100),
    cuit VARCHAR(20) UNIQUE,
    condicion_iva VARCHAR(20),
    productos_que_vende TEXT,
    plazo_entrega VARCHAR(50),
    activo BOOLEAN DEFAULT true,
    observaciones TEXT,
    created_at TIMESTAMP DEFAULT NOW(),
    updated_at TIMESTAMP DEFAULT NOW()
);

-- 5. TABLA DE PRODUCTOS
CREATE TABLE IF NOT EXISTS productos (
    id UUID DEFAULT gen_random_uuid() PRIMARY KEY,
    codigo_barras VARCHAR(50) UNIQUE,
    codigo_interno VARCHAR(50),
    nombre VARCHAR(200) NOT NULL,
    descripcion TEXT,
    marca VARCHAR(100),
    categoria VARCHAR(100) NOT NULL,
    subcategoria VARCHAR(100),
    unidad_medida VARCHAR(20) DEFAULT 'unidad',
    material VARCHAR(100),
    color VARCHAR(50),
    medidas VARCHAR(100),
    precio_costo DECIMAL(10,2) DEFAULT 0,
    porcentaje_ganancia DECIMAL(5,2) DEFAULT 40,
    precio_venta DECIMAL(10,2) NOT NULL,
    stock DECIMAL(10,3) DEFAULT 0,
    stock_minimo DECIMAL(10,3) DEFAULT 5,
    stock_maximo DECIMAL(10,3) DEFAULT 100,
    proveedor_id UUID REFERENCES proveedores(id),
    ubicacion VARCHAR(50),
    activo BOOLEAN DEFAULT true,
    destacado BOOLEAN DEFAULT false,
    imagen_url TEXT,
    last_sync_at TIMESTAMP,
    created_at TIMESTAMP DEFAULT NOW(),
    updated_at TIMESTAMP DEFAULT NOW(),
    CHECK (precio_venta >= 0),
    CHECK (stock >= 0)
);

-- 6. TABLA DE CLIENTES
CREATE TABLE IF NOT EXISTS clientes (
    id UUID DEFAULT gen_random_uuid() PRIMARY KEY,
    nombre VARCHAR(100) NOT NULL,
    apellido VARCHAR(100),
    razon_social VARCHAR(200),
    tipo_documento VARCHAR(10) DEFAULT 'DNI',
    numero_documento VARCHAR(20) UNIQUE,
    telefono VARCHAR(20),
    email VARCHAR(100),
    direccion TEXT,
    localidad VARCHAR(100),
    provincia VARCHAR(100),
    tipo_cliente VARCHAR(20) DEFAULT 'consumidor_final',
    limite_credito DECIMAL(10,2) DEFAULT 0,
    saldo DECIMAL(10,2) DEFAULT 0,
    categoria_iva VARCHAR(20) DEFAULT 'consumidor_final',
    cuit VARCHAR(20),
    observaciones TEXT,
    ultimo_movimiento_cc TIMESTAMP,
    activo BOOLEAN DEFAULT true,
    created_at TIMESTAMP DEFAULT NOW(),
    updated_at TIMESTAMP DEFAULT NOW()
);

-- 7. TABLA DE VENTAS
CREATE TABLE IF NOT EXISTS ventas (
    id UUID DEFAULT gen_random_uuid() PRIMARY KEY,
    numero_venta VARCHAR(50) UNIQUE,
    local_id UUID REFERENCES locales(id),
    caja_id UUID REFERENCES cajas(id),
    usuario_id UUID REFERENCES usuarios(id),
    cliente_id UUID REFERENCES clientes(id),
    total DECIMAL(10,2) NOT NULL,
    descuento DECIMAL(10,2) DEFAULT 0,
    subtotal DECIMAL(10,2) NOT NULL,
    iva DECIMAL(10,2) DEFAULT 0,
    estado VARCHAR(20) DEFAULT 'completada',
    tipo_venta VARCHAR(20) DEFAULT 'contado',
    tipo_comprobante VARCHAR(20) DEFAULT 'ticket',
    punto_venta INTEGER DEFAULT 0,
    numero_comprobante INTEGER,
    observaciones TEXT,
    offline_id VARCHAR(100),
    sync_status VARCHAR(20) DEFAULT 'synced',
    last_sync_at TIMESTAMP,
    created_at TIMESTAMP DEFAULT NOW(),
    updated_at TIMESTAMP DEFAULT NOW(),
    CHECK (total >= 0)
);

-- 8. TABLA DE ITEMS DE VENTA
CREATE TABLE IF NOT EXISTS venta_items (
    id UUID DEFAULT gen_random_uuid() PRIMARY KEY,
    venta_id UUID REFERENCES ventas(id) ON DELETE CASCADE,
    producto_id UUID REFERENCES productos(id),
    cantidad DECIMAL(10,3) NOT NULL,
    precio_unitario DECIMAL(10,2) NOT NULL,
    descuento_unitario DECIMAL(10,2) DEFAULT 0,
    subtotal DECIMAL(10,2) NOT NULL,
    created_at TIMESTAMP DEFAULT NOW(),
    CHECK (cantidad > 0),
    CHECK (precio_unitario >= 0)
);

-- 9. TABLA DE PAGOS
CREATE TABLE IF NOT EXISTS pagos (
    id UUID DEFAULT gen_random_uuid() PRIMARY KEY,
    venta_id UUID REFERENCES ventas(id) ON DELETE CASCADE,
    metodo VARCHAR(50) NOT NULL,
    monto DECIMAL(10,2) NOT NULL,
    referencia VARCHAR(100),
    estado VARCHAR(20) DEFAULT 'completado',
    tarjeta_tipo VARCHAR(50),
    tarjeta_numero VARCHAR(4),
    tarjeta_cuotas INTEGER DEFAULT 1,
    offline_id VARCHAR(100),
    sync_status VARCHAR(20) DEFAULT 'synced',
    created_at TIMESTAMP DEFAULT NOW(),
    CHECK (monto > 0)
);

-- 10. TABLA DE PRESUPUESTOS
CREATE TABLE IF NOT EXISTS presupuestos (
    id UUID DEFAULT gen_random_uuid() PRIMARY KEY,
    numero_presupuesto VARCHAR(50) UNIQUE,
    local_id UUID REFERENCES locales(id),
    cliente_id UUID REFERENCES clientes(id),
    usuario_id UUID REFERENCES usuarios(id),
    total DECIMAL(10,2) NOT NULL,
    descuento DECIMAL(10,2) DEFAULT 0,
    subtotal DECIMAL(10,2) NOT NULL,
    valido_hasta DATE,
    estado VARCHAR(20) DEFAULT 'pendiente',
    observaciones TEXT,
    offline_id VARCHAR(100),
    sync_status VARCHAR(20) DEFAULT 'synced',
    created_at TIMESTAMP DEFAULT NOW(),
    updated_at TIMESTAMP DEFAULT NOW()
);

-- 11. TABLA DE ITEMS DE PRESUPUESTO
CREATE TABLE IF NOT EXISTS presupuesto_items (
    id UUID DEFAULT gen_random_uuid() PRIMARY KEY,
    presupuesto_id UUID REFERENCES presupuestos(id) ON DELETE CASCADE,
    producto_id UUID REFERENCES productos(id),
    cantidad DECIMAL(10,3) NOT NULL,
    precio_unitario DECIMAL(10,2) NOT NULL,
    subtotal DECIMAL(10,2) NOT NULL,
    created_at TIMESTAMP DEFAULT NOW()
);

-- 12. TABLA DE CUENTAS CORRIENTES
CREATE TABLE IF NOT EXISTS cuentas_corrientes (
    id UUID DEFAULT gen_random_uuid() PRIMARY KEY,
    cliente_id UUID REFERENCES clientes(id),
    tipo_movimiento VARCHAR(20) NOT NULL,
    monto DECIMAL(10,2) NOT NULL,
    saldo_anterior DECIMAL(10,2) NOT NULL,
    saldo_nuevo DECIMAL(10,2) NOT NULL,
    venta_id UUID REFERENCES ventas(id),
    pago_id UUID REFERENCES pagos(id),
    observaciones TEXT,
    fecha_vencimiento DATE,
    offline_id VARCHAR(100),
    sync_status VARCHAR(20) DEFAULT 'synced',
    created_at TIMESTAMP DEFAULT NOW()
);

-- 13. TABLA DE CIERRES DE CAJA
CREATE TABLE IF NOT EXISTS cierres_caja (
    id UUID DEFAULT gen_random_uuid() PRIMARY KEY,
    local_id UUID REFERENCES locales(id),
    caja_id UUID REFERENCES cajas(id),
    usuario_id UUID REFERENCES usuarios(id),
    turno VARCHAR(10) NOT NULL,
    fecha DATE NOT NULL,
    saldo_inicial DECIMAL(10,2) NOT NULL,
    saldo_final DECIMAL(10,2),
    ventas_efectivo DECIMAL(10,2) DEFAULT 0,
    ventas_tarjeta DECIMAL(10,2) DEFAULT 0,
    ventas_transferencia DECIMAL(10,2) DEFAULT 0,
    ventas_otros DECIMAL(10,2) DEFAULT 0,
    total_ventas DECIMAL(10,2) DEFAULT 0,
    total_egresos DECIMAL(10,2) DEFAULT 0,
    diferencia DECIMAL(10,2) DEFAULT 0,
    observaciones TEXT,
    estado VARCHAR(20) DEFAULT 'abierto',
    sync_status VARCHAR(20) DEFAULT 'synced',
    last_sync_at TIMESTAMP,
    created_at TIMESTAMP DEFAULT NOW(),
    updated_at TIMESTAMP DEFAULT NOW()
);

-- 14. TABLA DE MOVIMIENTOS DE INVENTARIO
CREATE TABLE IF NOT EXISTS inventario (
    id UUID DEFAULT gen_random_uuid() PRIMARY KEY,
    producto_id UUID REFERENCES productos(id),
    tipo_movimiento VARCHAR(20) NOT NULL,
    cantidad DECIMAL(10,3) NOT NULL,
    stock_anterior DECIMAL(10,3) NOT NULL,
    stock_nuevo DECIMAL(10,3) NOT NULL,
    motivo VARCHAR(100),
    usuario_id UUID REFERENCES usuarios(id),
    venta_id UUID REFERENCES ventas(id),
    compra_id UUID,
    proveedor_id UUID REFERENCES proveedores(id),
    observaciones TEXT,
    offline_id VARCHAR(100),
    sync_status VARCHAR(20) DEFAULT 'synced',
    created_at TIMESTAMP DEFAULT NOW()
);

-- 15. TABLA DE CATEGOR√çAS DE PRODUCTOS
CREATE TABLE IF NOT EXISTS categorias (
    id UUID DEFAULT gen_random_uuid() PRIMARY KEY,
    nombre VARCHAR(100) NOT NULL UNIQUE,
    descripcion TEXT,
    icono VARCHAR(50),
    color VARCHAR(20),
    activo BOOLEAN DEFAULT true,
    created_at TIMESTAMP DEFAULT NOW()
);

-- 16. TABLA DE CONFIGURACIONES
CREATE TABLE IF NOT EXISTS configuraciones (
    id UUID DEFAULT gen_random_uuid() PRIMARY KEY,
    clave VARCHAR(100) NOT NULL UNIQUE,
    valor JSONB NOT NULL,
    descripcion TEXT,
    categoria VARCHAR(50) DEFAULT 'general',
    created_at TIMESTAMP DEFAULT NOW(),
    updated_at TIMESTAMP DEFAULT NOW()
);

-- 17. TABLA DE PROMOCIONES
CREATE TABLE IF NOT EXISTS promociones (
    id UUID DEFAULT gen_random_uuid() PRIMARY KEY,
    nombre VARCHAR(200) NOT NULL,
    descripcion TEXT,
    tipo VARCHAR(50) NOT NULL,
    valor DECIMAL(10,2),
    producto_id UUID REFERENCES productos(id),
    categoria_producto VARCHAR(100),
    fecha_inicio DATE NOT NULL,
    fecha_fin DATE NOT NULL,
    activo BOOLEAN DEFAULT true,
    created_at TIMESTAMP DEFAULT NOW(),
    updated_at TIMESTAMP DEFAULT NOW()
);

-- 18. TABLA DE DESCUENTOS
CREATE TABLE IF NOT EXISTS descuentos (
    id UUID DEFAULT gen_random_uuid() PRIMARY KEY,
    codigo VARCHAR(50) UNIQUE NOT NULL,
    descripcion TEXT,
    tipo VARCHAR(20) NOT NULL,
    valor DECIMAL(10,2) NOT NULL,
    minimo_compra DECIMAL(10,2) DEFAULT 0,
    fecha_inicio DATE NOT NULL,
    fecha_fin DATE NOT NULL,
    usos_maximos INTEGER DEFAULT 1,
    usos_actuales INTEGER DEFAULT 0,
    activo BOOLEAN DEFAULT true,
    created_at TIMESTAMP DEFAULT NOW(),
    updated_at TIMESTAMP DEFAULT NOW()
);

-- 19. TABLA DE COMPRAS/PEDIDOS A PROVEEDORES
CREATE TABLE IF NOT EXISTS compras (
    id UUID DEFAULT gen_random_uuid() PRIMARY KEY,
    numero_pedido VARCHAR(50) UNIQUE,
    proveedor_id UUID REFERENCES proveedores(id),
    usuario_id UUID REFERENCES usuarios(id),
    total DECIMAL(10,2) NOT NULL,
    estado VARCHAR(20) DEFAULT 'pendiente',
    fecha_pedido DATE NOT NULL,
    fecha_entrega_estimada DATE,
    fecha_entrega_real DATE,
    observaciones TEXT,
    created_at TIMESTAMP DEFAULT NOW(),
    updated_at TIMESTAMP DEFAULT NOW()
);

-- 20. TABLA DE ITEMS DE COMPRA
CREATE TABLE IF NOT EXISTS compra_items (
    id UUID DEFAULT gen_random_uuid() PRIMARY KEY,
    compra_id UUID REFERENCES compras(id) ON DELETE CASCADE,
    producto_id UUID REFERENCES productos(id),
    cantidad DECIMAL(10,3) NOT NULL,
    precio_unitario DECIMAL(10,2) NOT NULL,
    subtotal DECIMAL(10,2) NOT NULL,
    created_at TIMESTAMP DEFAULT NOW()
);

-- 21. TABLA DE AUDITOR√çA
CREATE TABLE IF NOT EXISTS auditoria (
    id UUID DEFAULT gen_random_uuid() PRIMARY KEY,
    usuario_id UUID REFERENCES usuarios(id),
    accion VARCHAR(100) NOT NULL,
    tabla VARCHAR(50) NOT NULL,
    registro_id VARCHAR(100) NOT NULL,
    datos_anteriores JSONB,
    datos_nuevos JSONB,
    ip_address VARCHAR(45),
    user_agent TEXT,
    created_at TIMESTAMP DEFAULT NOW()
);

-- 22. TABLA DE SINCRONIZACI√ìN OFFLINE
CREATE TABLE IF NOT EXISTS sincronizacion_log (
    id UUID DEFAULT gen_random_uuid() PRIMARY KEY,
    dispositivo_id VARCHAR(100),
    usuario_id UUID REFERENCES usuarios(id),
    tipo_operacion VARCHAR(50),
    operaciones_sincronizadas INTEGER DEFAULT 0,
    errores TEXT,
    duracion_ms INTEGER,
    created_at TIMESTAMP DEFAULT NOW()
);

-- ============================================
-- √çNDICES PARA MEJORAR EL RENDIMIENTO
-- ============================================

-- √çndices para productos
CREATE INDEX IF NOT EXISTS idx_productos_codigo_barras ON productos(codigo_barras);
CREATE INDEX IF NOT EXISTS idx_productos_nombre ON productos(nombre);
CREATE INDEX IF NOT EXISTS idx_productos_categoria ON productos(categoria);
CREATE INDEX IF NOT EXISTS idx_productos_stock ON productos(stock);
CREATE INDEX IF NOT EXISTS idx_productos_proveedor ON productos(proveedor_id);
CREATE INDEX IF NOT EXISTS idx_productos_activo ON productos(activo);
CREATE INDEX IF NOT EXISTS idx_productos_last_sync ON productos(last_sync_at);

-- √çndices para ventas
CREATE INDEX IF NOT EXISTS idx_ventas_fecha ON ventas(created_at);
CREATE INDEX IF NOT EXISTS idx_ventas_cliente ON ventas(cliente_id);
CREATE INDEX IF NOT EXISTS idx_ventas_local ON ventas(local_id);
CREATE INDEX IF NOT EXISTS idx_ventas_caja ON ventas(caja_id);
CREATE INDEX IF NOT EXISTS idx_ventas_usuario ON ventas(usuario_id);
CREATE INDEX IF NOT EXISTS idx_ventas_estado ON ventas(estado);
CREATE INDEX IF NOT EXISTS idx_ventas_sync ON ventas(sync_status);
CREATE INDEX IF NOT EXISTS idx_ventas_fecha_local ON ventas(created_at, local_id);
CREATE INDEX IF NOT EXISTS idx_ventas_sync_status ON ventas(sync_status);

-- √çndices para clientes
CREATE INDEX IF NOT EXISTS idx_clientes_documento ON clientes(numero_documento);
CREATE INDEX IF NOT EXISTS idx_clientes_nombre ON clientes(nombre);
CREATE INDEX IF NOT EXISTS idx_clientes_saldo ON clientes(saldo);
CREATE INDEX IF NOT EXISTS idx_clientes_tipo ON clientes(tipo_cliente);
CREATE INDEX IF NOT EXISTS idx_clientes_telefono ON clientes(telefono);

-- √çndices para proveedores
CREATE INDEX IF NOT EXISTS idx_proveedores_nombre ON proveedores(nombre);
CREATE INDEX IF NOT EXISTS idx_proveedores_cuit ON proveedores(cuit);
CREATE INDEX IF NOT EXISTS idx_proveedores_activo ON proveedores(activo);

-- √çndices para inventario
CREATE INDEX IF NOT EXISTS idx_inventario_producto ON inventario(producto_id);
CREATE INDEX IF NOT EXISTS idx_inventario_fecha ON inventario(created_at);
CREATE INDEX IF NOT EXISTS idx_inventario_tipo ON inventario(tipo_movimiento);
CREATE INDEX IF NOT EXISTS idx_inventario_producto_fecha ON inventario(producto_id, created_at DESC);

-- √çndices para pagos
CREATE INDEX IF NOT EXISTS idx_pagos_venta ON pagos(venta_id);
CREATE INDEX IF NOT EXISTS idx_pagos_metodo ON pagos(metodo, created_at);
CREATE INDEX IF NOT EXISTS idx_pagos_sync ON pagos(sync_status);

-- √çndices para cuentas corrientes
CREATE INDEX IF NOT EXISTS idx_cuentas_corrientes_cliente ON cuentas_corrientes(cliente_id, created_at DESC);
CREATE INDEX IF NOT EXISTS idx_cuentas_corrientes_venta ON cuentas_corrientes(venta_id);
CREATE INDEX IF NOT EXISTS idx_cuentas_corrientes_tipo ON cuentas_corrientes(tipo_movimiento);

-- √çndices para cierres de caja
CREATE INDEX IF NOT EXISTS idx_cierres_fecha ON cierres_caja(fecha);
CREATE INDEX IF NOT EXISTS idx_cierres_local ON cierres_caja(local_id);
CREATE INDEX IF NOT EXISTS idx_cierres_estado ON cierres_caja(estado);
CREATE INDEX IF NOT EXISTS idx_cierres_fecha_local ON cierres_caja(fecha, local_id, caja_id);
CREATE INDEX IF NOT EXISTS idx_cierres_sync ON cierres_caja(sync_status);

-- √çndices para presupuestos
CREATE INDEX IF NOT EXISTS idx_presupuestos_cliente ON presupuestos(cliente_id);
CREATE INDEX IF NOT EXISTS idx_presupuestos_estado ON presupuestos(estado);
CREATE INDEX IF NOT EXISTS idx_presupuestos_valido ON presupuestos(valido_hasta);
CREATE INDEX IF NOT EXISTS idx_presupuestos_sync ON presupuestos(sync_status);

-- √çndices para promociones y descuentos
CREATE INDEX IF NOT EXISTS idx_promociones_fechas ON promociones(fecha_inicio, fecha_fin, activo);
CREATE INDEX IF NOT EXISTS idx_descuentos_codigo ON descuentos(codigo, activo);

-- √çndices para compras
CREATE INDEX IF NOT EXISTS idx_compras_proveedor ON compras(proveedor_id);
CREATE INDEX IF NOT EXISTS idx_compras_estado ON compras(estado);
CREATE INDEX IF NOT EXISTS idx_compras_fecha_pedido ON compras(fecha_pedido);

-- ============================================
-- INSERTAR DATOS INICIALES
-- ============================================

-- Insertar configuraciones
INSERT INTO configuraciones (clave, valor, descripcion, categoria) VALUES 
('empresa', '{"nombre": "Mi Ferreter√≠a", "direccion": "Av. Principal 1234", "telefono": "011-1234-5678", "email": "info@miferreteria.com", "cuit": "30-12345678-9"}', 'Datos de la empresa', 'empresa'),
('iva', '{"porcentaje": 21, "incluido": true}', 'Configuraci√≥n de IVA', 'impuestos'),
('moneda', '{"simbolo": "$", "nombre": "Peso Argentino", "decimales": 2}', 'Configuraci√≥n de moneda', 'general'),
('facturacion', '{"punto_venta": 1, "ultimo_numero": 0, "tipo_comprobante": "ticket"}', 'Configuraci√≥n de facturaci√≥n', 'facturacion'),
('stock', '{"alertar_minimo": true, "mostrar_stock_cero": false, "control_lotes": false}', 'Configuraci√≥n de stock', 'stock'),
('caja', '{"saldo_inicial": 10000, "corte_automatico": true, "imprimir_ticket": true}', 'Configuraci√≥n de caja', 'caja'),
('metodos_pago', '["efectivo", "tarjeta", "transferencia", "qr", "cuenta_corriente"]', 'M√©todos de pago activos', 'pagos'),
('turnos', '["ma√±ana", "tarde", "noche"]', 'Turnos disponibles', 'caja'),
('unidades_medida', '["unidad", "metro", "litro", "kilogramo", "par", "juego"]', 'Unidades de medida', 'productos'),
('categorias_iva', '["consumidor_final", "responsable_inscripto", "monotributista", "exento"]', 'Categor√≠as de IVA', 'clientes')
ON CONFLICT (clave) DO UPDATE SET valor = EXCLUDED.valor, updated_at = NOW();

-- Insertar categor√≠as para ferreter√≠a
INSERT INTO categorias (nombre, descripcion, icono, color) VALUES 
('Herramientas Manuales', 'Martillos, destornilladores, alicates, etc.', 'üîß', 'blue'),
('Herramientas El√©ctricas', 'Taladros, amoladoras, sierras el√©ctricas', '‚ö°', 'orange'),
('Materiales de Construcci√≥n', 'Cemento, arena, ladrillos, hierros', 'üèóÔ∏è', 'gray'),
('Fontaner√≠a', 'Ca√±os, conexiones, llaves, sanitarios', 'üö∞', 'teal'),
('Electricidad', 'Cables, interruptores, tomas, luminarias', 'üí°', 'yellow'),
('Pinturas', 'Pinturas, barnices, selladores, herramientas', 'üé®', 'purple'),
('Fijaciones', 'Clavos, tornillos, anclajes, adhesivos', 'üìå', 'red'),
('Jardiner√≠a', 'Herramientas de jard√≠n, plantas, tierra', 'üåø', 'green'),
('Seguridad', 'Guantes, lentes, cascos, botas', 'üõ°Ô∏è', 'indigo'),
('Ferreter√≠a General', 'Art√≠culos varios de ferreter√≠a', 'üõ†Ô∏è', 'pink')
ON CONFLICT (nombre) DO NOTHING;`;

        // Lista completa de tablas requeridas
        const requiredTables = [
            'locales', 'cajas', 'usuarios', 'proveedores', 'productos', 
            'clientes', 'ventas', 'venta_items', 'pagos', 'presupuestos',
            'presupuesto_items', 'cuentas_corrientes', 'cierres_caja', 
            'inventario', 'categorias', 'configuraciones', 'promociones',
            'descuentos', 'compras', 'compra_items', 'auditoria', 
            'sincronizacion_log'
        ];

        // Inicializaci√≥n
        document.addEventListener('DOMContentLoaded', function() {
            loadSavedConfig();
            generateSQL();
            updateProgress();
            updateConfigSummary();
            updateUsersChecklist();
            updateTablesChecklist();
        });

        // Navegaci√≥n entre pasos
        function nextStep() {
            if (!validateStep(currentStep)) return;
            
            document.getElementById(`step${currentStep}`).classList.remove('active');
            document.querySelector(`.progress-step[data-step="${currentStep}"]`).classList.remove('active');
            
            currentStep++;
            
            document.getElementById(`step${currentStep}`).classList.add('active');
            document.querySelector(`.progress-step[data-step="${currentStep}"]`).classList.add('active');
            
            if (currentStep === 2) {
                loadSupabaseClient();
            } else if (currentStep === 7) {
                document.getElementById('finalActions').style.display = 'block';
            }
            
            updateProgress();
        }

        function prevStep() {
            document.getElementById(`step${currentStep}`).classList.remove('active');
            document.querySelector(`.progress-step[data-step="${currentStep}"]`).classList.remove('active');
            
            currentStep--;
            
            document.getElementById(`step${currentStep}`).classList.add('active');
            document.querySelector(`.progress-step[data-step="${currentStep}"]`).classList.add('active');
            
            if (currentStep === 7) {
                document.getElementById('finalActions').style.display = 'none';
            }
            
            updateProgress();
        }

        function updateProgress() {
            document.querySelectorAll('.progress-step').forEach((step, index) => {
                const stepNum = parseInt(step.dataset.step);
                if (stepNum < currentStep) {
                    step.classList.add('completed');
                } else if (stepNum === currentStep) {
                    step.classList.add('active');
                } else {
                    step.classList.remove('active', 'completed');
                }
            });
        }

        // Validaci√≥n de pasos
        function validateStep(step) {
            switch(step) {
                case 1:
                    const url = document.getElementById('supabaseUrl').value;
                    const key = document.getElementById('supabaseKey').value;
                    
                    if (!url || !key) {
                        alert('Por favor, completa la URL y clave de Supabase');
                        return false;
                    }
                    
                    if (!url.startsWith('https://')) {
                        alert('La URL de Supabase debe comenzar con https://');
                        return false;
                    }
                    
                    setupData.supabase = { url, key };
                    localStorage.setItem('supabaseUrl', url);
                    localStorage.setItem('supabaseKey', key);
                    updateConfigSummary();
                    return true;
                    
                case 2:
                    const verified = document.getElementById('step2Next').disabled === false;
                    if (!verified) {
                        alert('Por favor, verifica la estructura de la base de datos primero');
                        return false;
                    }
                    return true;
                    
                case 3:
                    const nombre = document.getElementById('empresaNombre').value;
                    if (!nombre) {
                        alert('Por favor, ingresa el nombre de la empresa');
                        return false;
                    }
                    return true;
                    
                case 4:
                    const localNombre = document.getElementById('localNombre').value;
                    const cajaNumero = document.getElementById('cajaNumero').value;
                    
                    if (!localNombre || !cajaNumero) {
                        alert('Por favor, completa los datos del local y caja');
                        return false;
                    }
                    return true;
                    
                case 5:
                    const password = document.getElementById('adminPassword').value;
                    const confirm = document.getElementById('adminPasswordConfirm').value;
                    
                    if (password !== confirm) {
                        alert('Las contrase√±as no coinciden');
                        return false;
                    }
                    
                    if (password.length < 8) {
                        alert('La contrase√±a debe tener al menos 8 caracteres');
                        return false;
                    }
                    return true;
                    
                default:
                    return true;
            }
        }

        // Configuraci√≥n Supabase
        function loadSupabaseClient() {
            const url = localStorage.getItem('supabaseUrl');
            const key = localStorage.getItem('supabaseKey');
            
            if (!url || !key) return;
            
            // Cargar Supabase JS si no est√° cargado
            if (!window.supabase) {
                const script = document.createElement('script');
                script.src = 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/supabase.min.js';
                script.onload = () => {
                    supabaseClient = window.supabase.createClient(url, key);
                    testSupabaseConnection();
                };
                document.head.appendChild(script);
            } else {
                supabaseClient = window.supabase.createClient(url, key);
                testSupabaseConnection();
            }
        }

        function testSupabaseConnection() {
            const testBtn = document.getElementById('testConnection');
            const testResult = document.getElementById('testResult');
            
            testBtn.innerHTML = '<div class="spinner"></div> Probando...';
            
            // Intentar una conexi√≥n simple
            setTimeout(async () => {
                try {
                    if (!supabaseClient) {
                        throw new Error('Cliente Supabase no inicializado');
                    }
                    
                    // Intentar obtener la versi√≥n de Postgres (si hay permisos)
                    const { data, error } = await supabaseClient.from('productos').select('count').limit(1);
                    
                    if (error && error.code === '42P01') {
                        // Tabla no existe - esto es normal en una instalaci√≥n nueva
                        testResult.className = 'test-result success';
                        testResult.innerHTML = '‚úÖ Conexi√≥n exitosa a Supabase (tablas pendientes de crear)';
                    } else if (error) {
                        throw error;
                    } else {
                        testResult.className = 'test-result success';
                        testResult.innerHTML = '‚úÖ Conexi√≥n exitosa a Supabase';
                    }
                    
                    document.getElementById('configUrl').textContent = setupData.supabase.url.substring(0, 40) + '...';
                    document.querySelector('#supabaseConfig .status-badge').className = 'status-badge status-success';
                    document.querySelector('#supabaseConfig .status-badge').textContent = 'Conectado';
                    
                } catch (error) {
                    testResult.className = 'test-result error';
                    testResult.innerHTML = `‚ùå Error de conexi√≥n: ${error.message}`;
                    document.querySelector('#supabaseConfig .status-badge').className = 'status-badge status-error';
                    document.querySelector('#supabaseConfig .status-badge').textContent = 'Error';
                } finally {
                    testBtn.innerHTML = '<span>üîç</span> Probar Conexi√≥n';
                }
            }, 1000);
        }

        // Generar SQL
        function generateSQL() {
            document.getElementById('sqlCode').textContent = completeSQL;
        }

        function copySQL() {
            const sqlText = document.getElementById('sqlCode').textContent;
            navigator.clipboard.writeText(sqlText).then(() => {
                const btn = document.querySelector('.copy-btn');
                const originalText = btn.textContent;
                btn.textContent = '‚úÖ Copiado!';
                setTimeout(() => {
                    btn.textContent = originalText;
                }, 2000);
            });
        }

        async function verifyDatabase() {
            if (!supabaseClient) {
                alert('Primero configura y prueba la conexi√≥n a Supabase');
                return;
            }

            const verifyBtn = document.getElementById('verifyBtn');
            const verifyResult = document.getElementById('verifyResult');
            
            verifyBtn.innerHTML = '<div class="spinner"></div> Verificando...';
            verifyBtn.disabled = true;

            try {
                const checklist = document.getElementById('tablesChecklist');
                checklist.innerHTML = '';
                
                let allTablesExist = true;
                let missingTables = [];
                
                for (const table of requiredTables) {
                    const { data, error } = await supabaseClient
                        .from(table)
                        .select('count')
                        .limit(1);
                    
                    const li = document.createElement('li');
                    const icon = document.createElement('div');
                    
                    if (error && error.code === '42P01') {
                        // Tabla no existe
                        icon.className = 'checklist-icon pending';
                        icon.innerHTML = '‚ùå';
                        li.innerHTML = `${icon.outerHTML} <span>${table} - <strong style="color: #ef4444;">Falta crear</strong></span>`;
                        allTablesExist = false;
                        missingTables.push(table);
                    } else if (error) {
                        icon.className = 'checklist-icon pending';
                        icon.innerHTML = '‚ùå';
                        li.innerHTML = `${icon.outerHTML} <span>${table} - <strong style="color: #ef4444;">Error: ${error.message}</strong></span>`;
                        allTablesExist = false;
                        missingTables.push(table);
                    } else {
                        icon.className = 'checklist-icon completed';
                        icon.innerHTML = '‚úì';
                        li.innerHTML = `${icon.outerHTML} <span>${table} - <strong style="color: #10b981;">OK</strong></span>`;
                    }
                    
                    checklist.appendChild(li);
                }
                
                if (allTablesExist) {
                    verifyResult.className = 'test-result success';
                    verifyResult.innerHTML = '‚úÖ Todas las tablas est√°n creadas correctamente';
                    document.getElementById('step2Next').disabled = false;
                } else {
                    verifyResult.className = 'test-result error';
                    verifyResult.innerHTML = `‚ùå Faltan ${missingTables.length} tablas. Ejecuta el SQL completo en Supabase SQL Editor.`;
                    document.getElementById('step2Next').disabled = true;
                }
                
            } catch (error) {
                verifyResult.className = 'test-result error';
                verifyResult.innerHTML = `‚ùå Error de verificaci√≥n: ${error.message}`;
            } finally {
                verifyBtn.innerHTML = 'üîç Verificar Estructura de BD';
                verifyBtn.disabled = false;
            }
        }

        function updateTablesChecklist() {
            const checklist = document.getElementById('tablesChecklist');
            if (!checklist) return;
            
            checklist.innerHTML = '';
            requiredTables.forEach(table => {
                const li = document.createElement('li');
                li.innerHTML = `
                    <div class="checklist-icon pending">‚ùå</div>
                    <span>${table} - <strong style="color: #6b7280;">Pendiente</strong></span>
                `;
                checklist.appendChild(li);
            });
        }

        // Configuraci√≥n Empresa
        async function saveEmpresa() {
            setupData.empresa = {
                nombre: document.getElementById('empresaNombre').value,
                cuit: document.getElementById('empresaCuit').value,
                direccion: document.getElementById('empresaDireccion').value,
                telefono: document.getElementById('empresaTelefono').value,
                email: document.getElementById('empresaEmail').value,
                config: document.getElementById('empresaConfig').value
            };
            
            // Guardar en Supabase si est√° conectado
            if (supabaseClient) {
                try {
                    const { error } = await supabaseClient
                        .from('configuraciones')
                        .upsert({
                            clave: 'empresa',
                            valor: {
                                nombre: setupData.empresa.nombre,
                                cuit: setupData.empresa.cuit,
                                direccion: setupData.empresa.direccion,
                                telefono: setupData.empresa.telefono,
                                email: setupData.empresa.email
                            },
                            descripcion: 'Datos de la empresa',
                            categoria: 'empresa'
                        }, { onConflict: 'clave' });
                    
                    if (error) throw error;
                    
                } catch (error) {
                    console.warn('Error guardando empresa en Supabase:', error);
                }
            }
            
            updateConfigSummary();
            nextStep();
        }

        // Configuraci√≥n Local
        async function saveLocal() {
            const turnos = [];
            if (document.getElementById('turnoManana').checked) turnos.push('ma√±ana');
            if (document.getElementById('turnoTarde').checked) turnos.push('tarde');
            if (document.getElementById('turnoNoche').checked) turnos.push('noche');
            
            setupData.local = {
                nombre: document.getElementById('localNombre').value,
                telefono: document.getElementById('localTelefono').value,
                direccion: document.getElementById('localDireccion').value,
                horario: document.getElementById('localHorario').value,
                responsable: document.getElementById('localResponsable').value,
                caja: {
                    numero: document.getElementById('cajaNumero').value,
                    nombre: document.getElementById('cajaNombre').value
                },
                turnos: turnos
            };
            
            // Guardar en Supabase si est√° conectado
            if (supabaseClient) {
                try {
                    // Guardar local
                    const { data: localData, error: localError } = await supabaseClient
                        .from('locales')
                        .insert({
                            nombre: setupData.local.nombre,
                            telefono: setupData.local.telefono,
                            direccion: setupData.local.direccion,
                            horario_atencion: setupData.local.horario,
                            responsable: setupData.local.responsable,
                            activo: true
                        })
                        .select()
                        .single();
                    
                    if (localError) throw localError;
                    
                    // Guardar caja
                    if (localData) {
                        const { error: cajaError } = await supabaseClient
                            .from('cajas')
                            .insert({
                                numero: setupData.local.caja.numero,
                                nombre: setupData.local.caja.nombre,
                                local_id: localData.id,
                                activo: true
                            });
                        
                        if (cajaError) throw cajaError;
                        
                        // Actualizar datos con IDs generados
                        setupData.local.id = localData.id;
                        setupData.local.caja.local_id = localData.id;
                    }
                    
                } catch (error) {
                    console.warn('Error guardando local en Supabase:', error);
                }
            }
            
            updateConfigSummary();
            nextStep();
        }

        // Configuraci√≥n Usuarios
        function agregarVendedor() {
            const container = document.getElementById('vendedoresContainer');
            const index = container.children.length;
            
            const div = document.createElement('div');
            div.className = 'vendedor-form';
            div.style.cssText = 'border: 2px solid #e5e7eb; padding: 15px; border-radius: 10px; margin-bottom: 15px;';
            div.innerHTML = `
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                    <h4 style="margin: 0;">Vendedor ${index + 1}</h4>
                    <button type="button" class="btn btn-danger" onclick="eliminarVendedor(this)" style="padding: 5px 10px; font-size: 0.9rem;">Eliminar</button>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <input type="text" placeholder="Nombre" class="vendedor-nombre" required>
                    </div>
                    <div class="form-group">
                        <input type="email" placeholder="Email" class="vendedor-email" required>
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <input type="password" placeholder="Contrase√±a" class="vendedor-password" required minlength="6">
                    </div>
                    <div class="form-group">
                        <select class="vendedor-rol">
                            <option value="vendedor">Vendedor</option>
                            <option value="supervisor">Supervisor</option>
                        </select>
                    </div>
                </div>
            `;
            
            container.appendChild(div);
            updateUsersChecklist();
        }

        function eliminarVendedor(btn) {
            btn.closest('.vendedor-form').remove();
            updateUsersChecklist();
        }

        function updateUsersChecklist() {
            const checklist = document.getElementById('usersChecklist');
            if (!checklist) return;
            
            const adminNombre = document.getElementById('adminNombre').value || 'Administrador';
            const adminEmail = document.getElementById('adminEmail').value || 'admin@empresa.com';
            
            checklist.innerHTML = `
                <li>
                    <div class="checklist-icon pending">üëë</div>
                    <span>${adminNombre} (${adminEmail}) - <strong>Administrador</strong></span>
                </li>
            `;
            
            const vendedores = document.querySelectorAll('.vendedor-form');
            vendedores.forEach((form, index) => {
                const nombre = form.querySelector('.vendedor-nombre').value || `Vendedor ${index + 1}`;
                const email = form.querySelector('.vendedor-email').value || 'email@empresa.com';
                const rol = form.querySelector('.vendedor-rol').value;
                
                const li = document.createElement('li');
                li.innerHTML = `
                    <div class="checklist-icon pending">üë§</div>
                    <span>${nombre} (${email}) - <strong>${rol}</strong></span>
                `;
                checklist.appendChild(li);
            });
        }

        async function createUsers() {
            if (!supabaseClient) {
                alert('Error: No hay conexi√≥n a Supabase');
                return;
            }

            // Crear usuario administrador
            const adminUser = {
                nombre: document.getElementById('adminNombre').value,
                email: document.getElementById('adminEmail').value,
                password: document.getElementById('adminPassword').value,
                rol: document.getElementById('adminRol').value
            };

            try {
                // Primero intentar crear el usuario con Supabase Auth
                const { data: authData, error: authError } = await supabaseClient.auth.signUp({
                    email: adminUser.email,
                    password: adminUser.password,
                    options: {
                        data: {
                            nombre: adminUser.nombre,
                            rol: adminUser.rol
                        }
                    }
                });

                if (authError) throw authError;

                // Luego insertar en la tabla usuarios
                const { error: dbError } = await supabaseClient
                    .from('usuarios')
                    .insert([{
                        id: authData.user.id,
                        email: adminUser.email,
                        nombre: adminUser.nombre,
                        rol: adminUser.rol,
                        activo: true,
                        local_id: setupData.local.id || null
                    }]);

                if (dbError) throw dbError;

                setupData.usuarios.push(adminUser);

                // Crear vendedores adicionales
                const vendedoresForms = document.querySelectorAll('.vendedor-form');
                for (const form of vendedoresForms) {
                    const vendedor = {
                        nombre: form.querySelector('.vendedor-nombre').value,
                        email: form.querySelector('.vendedor-email').value,
                        password: form.querySelector('.vendedor-password').value,
                        rol: form.querySelector('.vendedor-rol').value
                    };

                    const { data: vendedorAuth, error: vendedorError } = await supabaseClient.auth.signUp({
                        email: vendedor.email,
                        password: vendedor.password,
                        options: {
                            data: {
                                nombre: vendedor.nombre,
                                rol: vendedor.rol
                            }
                        }
                    });

                    if (!vendedorError) {
                        await supabaseClient
                            .from('usuarios')
                            .insert([{
                                id: vendedorAuth.user.id,
                                email: vendedor.email,
                                nombre: vendedor.nombre,
                                rol: vendedor.rol,
                                activo: true,
                                local_id: setupData.local.id || null
                            }]);

                        setupData.usuarios.push(vendedor);
                    }
                }

                alert(`‚úÖ Usuarios creados exitosamente\nTotal: ${setupData.usuarios.length} usuarios`);
                nextStep();

            } catch (error) {
                alert(`‚ùå Error creando usuarios: ${error.message}`);
            }
        }

        // Configuraci√≥n Productos
        function handleExcelUpload(event) {
            const file = event.target.files[0];
            if (!file) return;

            const uploadArea = document.getElementById('excelUpload');
            uploadArea.classList.add('drag-over');
            
            // Simular procesamiento de Excel
            setTimeout(() => {
                uploadArea.classList.remove('drag-over');
                
                // Para este ejemplo, cargamos productos de muestra
                loadSampleProducts();
                
                alert('üìä Archivo Excel procesado exitosamente\nSe han cargado 25 productos de ejemplo');
            }, 1500);
        }

        function loadSampleProducts() {
            const sampleProducts = [
                { codigo: 'HERR-001', nombre: 'Martillo de Acero 500g', categoria: 'Herramientas Manuales', precio: 1750, stock: 15 },
                { codigo: 'HERR-002', nombre: 'Destornillador Plano 6x100', categoria: 'Herramientas Manuales', precio: 1232, stock: 25 },
                { codigo: 'HERR-003', nombre: 'Alicate Universal 8"', categoria: 'Herramientas Manuales', precio: 2890, stock: 18 },
                { codigo: 'HERR-004', nombre: 'Taladro Percutor 650W', categoria: 'Herramientas El√©ctricas', precio: 24500, stock: 8 },
                { codigo: 'HERR-005', nombre: 'Amoladora Angular 4.5"', categoria: 'Herramientas El√©ctricas', precio: 18900, stock: 12 },
                { codigo: 'HERR-006', nombre: 'Sierra Circular 1400W', categoria: 'Herramientas El√©ctricas', precio: 32400, stock: 6 },
                { codigo: 'MAT-001', nombre: 'Cemento Portland 50kg', categoria: 'Materiales de Construcci√≥n', precio: 4200, stock: 40 },
                { codigo: 'MAT-002', nombre: 'Ladrillo Hueco 18x18x33', categoria: 'Materiales de Construcci√≥n', precio: 85, stock: 500 },
                { codigo: 'MAT-003', nombre: 'Arena Fina m3', categoria: 'Materiales de Construcci√≥n', precio: 12500, stock: 15 },
                { codigo: 'FON-001', nombre: 'Ca√±o PVC 1/2" x 6m', categoria: 'Fontaner√≠a', precio: 1450, stock: 30 },
                { codigo: 'FON-002', nombre: 'Llave de Paso 1/2"', categoria: 'Fontaner√≠a', precio: 890, stock: 45 },
                { codigo: 'FON-003', nombre: 'Codo PVC 90¬∞ 1"', categoria: 'Fontaner√≠a', precio: 320, stock: 80 },
                { codigo: 'ELE-001', nombre: 'Cable TW 2.5mm x 100m', categoria: 'Electricidad', precio: 18500, stock: 22 },
                { codigo: 'ELE-002', nombre: 'Interruptor Simple', categoria: 'Electricidad', precio: 450, stock: 60 },
                { codigo: 'ELE-003', nombre: 'Toma Corriente 2P+T', categoria: 'Electricidad', precio: 680, stock: 55 },
                { codigo: 'PIN-001', nombre: 'Pintura L√°tex Blanca 20L', categoria: 'Pinturas', precio: 28900, stock: 18 },
                { codigo: 'PIN-002', nombre: 'Rodillo de Lana 9"', categoria: 'Pinturas', precio: 1250, stock: 35 },
                { codigo: 'PIN-003', nombre: 'Brocha 2" Profesional', categoria: 'Pinturas', precio: 890, stock: 40 },
                { codigo: 'FIJ-001', nombre: 'Tornillo Punta Broca 3x1"', categoria: 'Fijaciones', precio: 15, stock: 1000 },
                { codigo: 'FIJ-002', nombre: 'Clavo de Construcci√≥n 3"', categoria: 'Fijaciones', precio: 8, stock: 1500 },
                { codigo: 'FIJ-003', nombre: 'Anclaje Qu√≠mico 10mm', categoria: 'Fijaciones', precio: 450, stock: 65 },
                { codigo: 'JAR-001', nombre: 'Pala de Jard√≠n', categoria: 'Jardiner√≠a', precio: 2450, stock: 25 },
                { codigo: 'JAR-002', nombre: 'Rastrillo 16 Dientes', categoria: 'Jardiner√≠a', precio: 1890, stock: 30 },
                { codigo: 'JAR-003', nombre: 'Manguera 1/2" x 25m', categoria: 'Jardiner√≠a', precio: 6450, stock: 20 },
                { codigo: 'SEG-001', nombre: 'Guantes de Seguridad', categoria: 'Seguridad', precio: 1250, stock: 45 }
            ];

            setupData.productos = sampleProducts;
            
            // Mostrar vista previa
            const preview = document.getElementById('excelPreview');
            const tableBody = preview.querySelector('tbody');
            preview.style.display = 'block';
            
            tableBody.innerHTML = '';
            sampleProducts.forEach(producto => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${producto.codigo}</td>
                    <td>${producto.nombre}</td>
                    <td>${producto.categoria}</td>
                    <td>$${producto.precio.toLocaleString()}</td>
                    <td>${producto.stock}</td>
                `;
                tableBody.appendChild(row);
            });
            
            // Actualizar resumen
            const categories = [...new Set(sampleProducts.map(p => p.categoria))];
            const totalStock = sampleProducts.reduce((sum, p) => sum + p.stock, 0);
            
            document.getElementById('productCount').textContent = sampleProducts.length;
            document.getElementById('categoryCount').textContent = categories.length;
            document.getElementById('totalStock').textContent = totalStock.toLocaleString();
            
            // Desmarcar skip
            document.getElementById('skipProducts').checked = false;
        }

        async function saveProducts() {
            const skip = document.getElementById('skipProducts').checked;
            
            if (skip) {
                setupData.productos = [];
                nextStep();
                return;
            }

            if (!setupData.productos.length) {
                alert('No hay productos para guardar. Por favor, carga productos primero.');
                return;
            }

            if (!supabaseClient) {
                alert('Error: No hay conexi√≥n a Supabase');
                return;
            }

            try {
                // Primero, insertar proveedor de ejemplo
                const { data: proveedorData, error: proveedorError } = await supabaseClient
                    .from('proveedores')
                    .upsert({
                        nombre: 'Proveedor Ejemplo S.A.',
                        razon_social: 'Proveedor Ejemplo Sociedad An√≥nima',
                        contacto: 'Juan P√©rez',
                        telefono: '011-4321-8765',
                        email: 'contacto@proveedorejemplo.com',
                        direccion: 'Calle Falsa 123',
                        localidad: 'CABA',
                        provincia: 'Buenos Aires',
                        cuit: '30-11222333-4',
                        condicion_iva: 'responsable_inscripto',
                        productos_que_vende: 'Herramientas manuales y el√©ctricas',
                        plazo_entrega: '48 a 72 horas',
                        activo: true
                    }, { onConflict: 'cuit' })
                    .select()
                    .single();

                // Luego, insertar categor√≠as si no existen
                const categories = [...new Set(setupData.productos.map(p => p.categoria))];
                for (const category of categories) {
                    await supabaseClient
                        .from('categorias')
                        .upsert({
                            nombre: category,
                            descripcion: `Productos de ${category}`,
                            icono: 'üõ†Ô∏è',
                            color: 'blue',
                            activo: true
                        }, { onConflict: 'nombre' });
                }

                // Insertar productos
                const productosToInsert = setupData.productos.map(producto => ({
                    codigo_interno: producto.codigo,
                    nombre: producto.nombre,
                    categoria: producto.categoria,
                    precio_venta: producto.precio,
                    precio_costo: Math.round(producto.precio * 0.7),
                    stock: producto.stock,
                    stock_minimo: 5,
                    stock_maximo: 100,
                    activo: true,
                    unidad_medida: 'unidad',
                    proveedor_id: proveedorData?.id || null,
                    porcentaje_ganancia: 40
                }));

                const { error } = await supabaseClient
                    .from('productos')
                    .insert(productosToInsert);

                if (error) throw error;

                alert(`‚úÖ Productos guardados exitosamente\nTotal: ${setupData.productos.length} productos`);
                nextStep();

            } catch (error) {
                alert(`‚ùå Error guardando productos: ${error.message}`);
            }
        }

        // Finalizaci√≥n
        async function completeSetup() {
            document.getElementById('finalLoading').style.display = 'block';
            document.getElementById('successScreen').style.display = 'none';
            document.getElementById('finalActions').style.display = 'none';

            try {
                // Guardar configuraci√≥n completa
                const config = {
                    supabase: setupData.supabase,
                    empresa: setupData.empresa,
                    local: setupData.local,
                    usuarios: setupData.usuarios.length,
                    productos: setupData.productos.length,
                    fecha: new Date().toISOString(),
                    version: '2.0.0'
                };

                localStorage.setItem('pos_config', JSON.stringify(config));
                localStorage.setItem('config_empresa', JSON.stringify(setupData.empresa));
                
                if (setupData.local) {
                    localStorage.setItem('currentLocal', JSON.stringify({
                        id: setupData.local.id || 'local-1',
                        nombre: setupData.local.nombre
                    }));
                }

                // Simular proceso
                await new Promise(resolve => setTimeout(resolve, 2000));

                // Actualizar pantalla de √©xito
                document.getElementById('finalEmpresa').textContent = setupData.empresa.nombre;
                document.getElementById('finalUsuarios').textContent = setupData.usuarios.length;
                document.getElementById('finalProductos').textContent = setupData.productos.length;

                document.getElementById('finalLoading').style.display = 'none';
                document.getElementById('successScreen').style.display = 'block';

            } catch (error) {
                alert(`‚ùå Error finalizando configuraci√≥n: ${error.message}`);
                document.getElementById('finalLoading').style.display = 'none';
                document.getElementById('finalActions').style.display = 'block';
            }
        }

        function goToLogin() {
            window.location.href = 'login.html';
        }

        function downloadConfig() {
            const config = {
                supabase: setupData.supabase,
                empresa: setupData.empresa,
                local: setupData.local,
                usuarios: setupData.usuarios,
                productos: setupData.productos,
                fecha: new Date().toISOString(),
                version: '2.0.0'
            };

            const blob = new Blob([JSON.stringify(config, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `config-pos-${new Date().toISOString().split('T')[0]}.json`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }

        // Utilidades
        function loadSavedConfig() {
            const savedUrl = localStorage.getItem('supabaseUrl');
            const savedKey = localStorage.getItem('supabaseKey');
            
            if (savedUrl) document.getElementById('supabaseUrl').value = savedUrl;
            if (savedKey) document.getElementById('supabaseKey').value = savedKey;
            
            const savedConfig = localStorage.getItem('pos_config');
            if (savedConfig) {
                try {
                    const config = JSON.parse(savedConfig);
                    if (config.empresa) {
                        document.getElementById('empresaNombre').value = config.empresa.nombre || '';
                        document.getElementById('empresaCuit').value = config.empresa.cuit || '';
                        document.getElementById('empresaDireccion').value = config.empresa.direccion || '';
                        document.getElementById('empresaTelefono').value = config.empresa.telefono || '';
                        document.getElementById('empresaEmail').value = config.empresa.email || '';
                    }
                } catch (e) {
                    console.warn('Error cargando configuraci√≥n guardada:', e);
                }
            }
        }

        function updateConfigSummary() {
            // Actualizar resumen empresa
            document.getElementById('summaryNombre').textContent = setupData.empresa.nombre || 'No configurado';
            document.getElementById('summaryCuit').textContent = setupData.empresa.cuit || 'No configurado';
            document.getElementById('summaryDireccion').textContent = setupData.empresa.direccion || 'No configurado';
            
            // Actualizar resumen local
            document.getElementById('summaryLocal').textContent = setupData.local.nombre || 'No configurado';
            document.getElementById('summaryCaja').textContent = setupData.local.caja?.numero || 'No configurado';
            document.getElementById('summaryTurnos').textContent = setupData.local.turnos?.join(', ') || 'No configurado';
            
            // Actualizar URL Supabase
            if (setupData.supabase.url) {
                document.getElementById('configUrl').textContent = setupData.supabase.url.substring(0, 40) + '...';
            }
        }

        // Drag and drop para archivos Excel
        document.addEventListener('DOMContentLoaded', function() {
            const dropArea = document.getElementById('excelUpload');
            
            ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
                dropArea.addEventListener(eventName, preventDefaults, false);
            });

            function preventDefaults(e) {
                e.preventDefault();
                e.stopPropagation();
            }

            ['dragenter', 'dragover'].forEach(eventName => {
                dropArea.addEventListener(eventName, highlight, false);
            });

            ['dragleave', 'drop'].forEach(eventName => {
                dropArea.addEventListener(eventName, unhighlight, false);
            });

            function highlight() {
                dropArea.classList.add('drag-over');
            }

            function unhighlight() {
                dropArea.classList.remove('drag-over');
            }

            dropArea.addEventListener('drop', handleDrop, false);

            function handleDrop(e) {
                const dt = e.dataTransfer;
                const files = dt.files;
                
                if (files.length) {
                    document.getElementById('excelFile').files = files;
                    loadSampleProducts();
                }
            }
        });
    </script>
</body>
</html>
