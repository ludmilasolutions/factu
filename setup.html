<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Configuraci√≥n - Sistema POS</title>
    <link rel="stylesheet" href="styles.css">
</head>
<body>
    <div class="container">
        <header>
            <h1>üîß Configuraci√≥n del Sistema POS</h1>
            <p class="subtitle">Configuraci√≥n inicial de la base de datos Supabase</p>
        </header>

        <div class="setup-section">
            <div class="card">
                <h2>‚öôÔ∏è Conexi√≥n a Supabase</h2>
                <div class="form-group">
                    <label for="supabaseUrl">URL de Supabase:</label>
                    <input type="text" id="supabaseUrl" placeholder="https://tu-proyecto.supabase.co">
                </div>
                <div class="form-group">
                    <label for="supabaseKey">Clave An√≥nima:</label>
                    <input type="password" id="supabaseKey" placeholder="eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...">
                </div>
                <button id="testConnection" class="btn btn-secondary">Probar Conexi√≥n</button>
            </div>

            <div class="card">
                <h2>üóÉÔ∏è Crear Tablas</h2>
                <p class="info-text">Crea todas las tablas necesarias en tu base de datos Supabase</p>
                <div class="button-group">
                    <button id="createTables" class="btn btn-primary">Crear Todas las Tablas</button>
                    <button id="createLocalesTable" class="btn btn-outline">Crear Tabla Locales</button>
                    <button id="createCajasTable" class="btn btn-outline">Crear Tabla Cajas</button>
                </div>
                <div id="tableStatus" class="status"></div>
            </div>

            <div class="card">
                <h2>üìä Datos de Prueba</h2>
                <p class="info-text">Inserta datos iniciales para comenzar a usar el sistema</p>
                <button id="insertTestData" class="btn btn-primary">Insertar Datos de Prueba</button>
                <div id="dataStatus" class="status"></div>
            </div>

            <div class="card">
                <h2>‚úÖ Verificar Configuraci√≥n</h2>
                <p class="info-text">Verifica que todas las tablas y datos est√©n correctamente configurados</p>
                <button id="verifySetup" class="btn btn-success">Verificar Configuraci√≥n</button>
                <div id="verifyStatus" class="status"></div>
            </div>
        </div>

        <div class="navigation">
            <button id="goToApp" class="btn btn-success" disabled>Ir a la Aplicaci√≥n</button>
        </div>
    </div>

    <script>
        // Configuraci√≥n de Supabase
        let supabaseClient = null;

        // Elementos del DOM
        const supabaseUrlInput = document.getElementById('supabaseUrl');
        const supabaseKeyInput = document.getElementById('supabaseKey');
        const testConnectionBtn = document.getElementById('testConnection');
        const createTablesBtn = document.getElementById('createTables');
        const insertTestDataBtn = document.getElementById('insertTestData');
        const verifySetupBtn = document.getElementById('verifySetup');
        const goToAppBtn = document.getElementById('goToApp');
        const tableStatus = document.getElementById('tableStatus');
        const dataStatus = document.getElementById('dataStatus');
        const verifyStatus = document.getElementById('verifyStatus');

        // Cargar credenciales guardadas
        window.addEventListener('DOMContentLoaded', () => {
            const savedUrl = localStorage.getItem('supabaseUrl');
            const savedKey = localStorage.getItem('supabaseKey');
            if (savedUrl) supabaseUrlInput.value = savedUrl;
            if (savedKey) supabaseKeyInput.value = savedKey;
            
            // Verificar si ya est√° configurado
            if (localStorage.getItem('systemConfigured') === 'true') {
                goToAppBtn.disabled = false;
                verifyStatus.innerHTML = '<p class="success">‚úÖ Sistema ya configurado. Puedes ir a la aplicaci√≥n.</p>';
            }
        });

        // Probar conexi√≥n a Supabase
        testConnectionBtn.addEventListener('click', async () => {
            const url = supabaseUrlInput.value.trim();
            const key = supabaseKeyInput.value.trim();
            
            if (!url || !key) {
                alert('Por favor, completa ambos campos');
                return;
            }
            
            try {
                // Guardar credenciales
                localStorage.setItem('supabaseUrl', url);
                localStorage.setItem('supabaseKey', key);
                
                // Cargar Supabase desde CDN
                if (!window.supabase) {
                    const script = document.createElement('script');
                    script.src = 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/supabase.min.js';
                    document.head.appendChild(script);
                    
                    // Esperar a que cargue
                    await new Promise(resolve => setTimeout(resolve, 1000));
                }
                
                // Crear cliente
                supabaseClient = window.supabase.createClient(url, key);
                
                // Probar conexi√≥n
                const { data, error } = await supabaseClient.from('_dummy').select('*').limit(1);
                
                if (error && error.code !== 'PGRST116') {
                    throw error;
                }
                
                alert('‚úÖ Conexi√≥n exitosa a Supabase');
                createTablesBtn.disabled = false;
                verifySetupBtn.disabled = false;
                
            } catch (error) {
                alert(`‚ùå Error de conexi√≥n: ${error.message}`);
            }
        });

        // Crear todas las tablas
        createTablesBtn.addEventListener('click', async () => {
            if (!supabaseClient) {
                alert('Primero prueba la conexi√≥n');
                return;
            }
            
            tableStatus.innerHTML = '<p class="info">üîÑ Creando tablas...</p>';
            
            try {
                // SQL para crear todas las tablas
                const tablesSQL = `
                -- Tabla de locales/comercios
                CREATE TABLE IF NOT EXISTS locales (
                    id UUID DEFAULT gen_random_uuid() PRIMARY KEY,
                    nombre VARCHAR(100) NOT NULL,
                    direccion TEXT,
                    telefono VARCHAR(20),
                    email VARCHAR(100),
                    config JSONB DEFAULT '{}',
                    activo BOOLEAN DEFAULT true,
                    created_at TIMESTAMP DEFAULT NOW()
                );

                -- Tabla de usuarios
                CREATE TABLE IF NOT EXISTS usuarios (
                    id UUID DEFAULT gen_random_uuid() PRIMARY KEY,
                    email VARCHAR(255) NOT NULL UNIQUE,
                    nombre VARCHAR(100) NOT NULL,
                    rol VARCHAR(50) DEFAULT 'vendedor',
                    local_id UUID REFERENCES locales(id),
                    activo BOOLEAN DEFAULT true,
                    config JSONB DEFAULT '{}',
                    created_at TIMESTAMP DEFAULT NOW()
                );

                -- Tabla de cajas
                CREATE TABLE IF NOT EXISTS cajas (
                    id UUID DEFAULT gen_random_uuid() PRIMARY KEY,
                    numero VARCHAR(20) NOT NULL,
                    nombre VARCHAR(100),
                    local_id UUID REFERENCES locales(id),
                    activa BOOLEAN DEFAULT true,
                    created_at TIMESTAMP DEFAULT NOW(),
                    UNIQUE(numero, local_id)
                );

                -- Tabla de productos
                CREATE TABLE IF NOT EXISTS productos (
                    id UUID DEFAULT gen_random_uuid() PRIMARY KEY,
                    codigo_barras VARCHAR(50) UNIQUE,
                    nombre VARCHAR(200) NOT NULL,
                    descripcion TEXT,
                    precio_costo DECIMAL(10,2) DEFAULT 0,
                    porcentaje_ganancia DECIMAL(5,2) DEFAULT 30,
                    precio_venta DECIMAL(10,2) NOT NULL,
                    stock INTEGER DEFAULT 0,
                    stock_minimo INTEGER DEFAULT 5,
                    categoria VARCHAR(100),
                    proveedor_id UUID,
                    activo BOOLEAN DEFAULT true,
                    promocion JSONB DEFAULT '{}',
                    created_at TIMESTAMP DEFAULT NOW(),
                    updated_at TIMESTAMP DEFAULT NOW()
                );

                -- Tabla de clientes
                CREATE TABLE IF NOT EXISTS clientes (
                    id UUID DEFAULT gen_random_uuid() PRIMARY KEY,
                    nombre VARCHAR(100) NOT NULL,
                    dni VARCHAR(20) UNIQUE,
                    telefono VARCHAR(20),
                    email VARCHAR(100),
                    direccion TEXT,
                    limite_credito DECIMAL(10,2) DEFAULT 0,
                    saldo DECIMAL(10,2) DEFAULT 0,
                    activo BOOLEAN DEFAULT true,
                    created_at TIMESTAMP DEFAULT NOW()
                );

                -- Tabla de proveedores
                CREATE TABLE IF NOT EXISTS proveedores (
                    id UUID DEFAULT gen_random_uuid() PRIMARY KEY,
                    nombre VARCHAR(100) NOT NULL,
                    contacto VARCHAR(100),
                    telefono VARCHAR(20),
                    email VARCHAR(100),
                    web VARCHAR(200),
                    whatsapp VARCHAR(20),
                    activo BOOLEAN DEFAULT true,
                    created_at TIMESTAMP DEFAULT NOW()
                );

                -- Tabla de ventas
                CREATE TABLE IF NOT EXISTS ventas (
                    id UUID DEFAULT gen_random_uuid() PRIMARY KEY,
                    numero_venta SERIAL,
                    local_id UUID REFERENCES locales(id),
                    caja_id UUID REFERENCES cajas(id),
                    usuario_id UUID,
                    cliente_id UUID REFERENCES clientes(id),
                    total DECIMAL(10,2) NOT NULL,
                    descuento DECIMAL(10,2) DEFAULT 0,
                    estado VARCHAR(20) DEFAULT 'completada',
                    tipo_venta VARCHAR(20) DEFAULT 'contado',
                    observaciones TEXT,
                    offline_id VARCHAR(100),
                    sync_status VARCHAR(20) DEFAULT 'synced',
                    created_at TIMESTAMP DEFAULT NOW(),
                    updated_at TIMESTAMP DEFAULT NOW()
                );

                -- Tabla de items de venta
                CREATE TABLE IF NOT EXISTS venta_items (
                    id UUID DEFAULT gen_random_uuid() PRIMARY KEY,
                    venta_id UUID REFERENCES ventas(id),
                    producto_id UUID REFERENCES productos(id),
                    cantidad INTEGER NOT NULL,
                    precio_unitario DECIMAL(10,2) NOT NULL,
                    subtotal DECIMAL(10,2) NOT NULL,
                    descuento DECIMAL(10,2) DEFAULT 0,
                    created_at TIMESTAMP DEFAULT NOW()
                );

                -- Tabla de pagos
                CREATE TABLE IF NOT EXISTS pagos (
                    id UUID DEFAULT gen_random_uuid() PRIMARY KEY,
                    venta_id UUID REFERENCES ventas(id),
                    metodo VARCHAR(50) NOT NULL,
                    monto DECIMAL(10,2) NOT NULL,
                    referencia VARCHAR(100),
                    estado VARCHAR(20) DEFAULT 'completado',
                    offline_id VARCHAR(100),
                    sync_status VARCHAR(20) DEFAULT 'synced',
                    created_at TIMESTAMP DEFAULT NOW()
                );

                -- Tabla de presupuestos
                CREATE TABLE IF NOT EXISTS presupuestos (
                    id UUID DEFAULT gen_random_uuid() PRIMARY KEY,
                    numero_presupuesto SERIAL,
                    local_id UUID REFERENCES locales(id),
                    cliente_id UUID REFERENCES clientes(id),
                    usuario_id UUID,
                    total DECIMAL(10,2) NOT NULL,
                    valido_hasta DATE,
                    estado VARCHAR(20) DEFAULT 'pendiente',
                    observaciones TEXT,
                    offline_id VARCHAR(100),
                    sync_status VARCHAR(20) DEFAULT 'synced',
                    created_at TIMESTAMP DEFAULT NOW()
                );

                -- Tabla de items de presupuesto
                CREATE TABLE IF NOT EXISTS presupuesto_items (
                    id UUID DEFAULT gen_random_uuid() PRIMARY KEY,
                    presupuesto_id UUID REFERENCES presupuestos(id),
                    producto_id UUID REFERENCES productos(id),
                    cantidad INTEGER NOT NULL,
                    precio_unitario DECIMAL(10,2) NOT NULL,
                    subtotal DECIMAL(10,2) NOT NULL,
                    created_at TIMESTAMP DEFAULT NOW()
                );

                -- Tabla de cuentas corrientes
                CREATE TABLE IF NOT EXISTS cuentas_corrientes (
                    id UUID DEFAULT gen_random_uuid() PRIMARY KEY,
                    cliente_id UUID REFERENCES clientes(id),
                    tipo_movimiento VARCHAR(20) NOT NULL,
                    monto DECIMAL(10,2) NOT NULL,
                    saldo_anterior DECIMAL(10,2) NOT NULL,
                    saldo_nuevo DECIMAL(10,2) NOT NULL,
                    referencia_id UUID,
                    observaciones TEXT,
                    offline_id VARCHAR(100),
                    sync_status VARCHAR(20) DEFAULT 'synced',
                    created_at TIMESTAMP DEFAULT NOW()
                );

                -- Tabla de cierres de caja
                CREATE TABLE IF NOT EXISTS cierres_caja (
                    id UUID DEFAULT gen_random_uuid() PRIMARY KEY,
                    local_id UUID REFERENCES locales(id),
                    caja_id UUID REFERENCES cajas(id),
                    usuario_id UUID,
                    turno VARCHAR(10) NOT NULL,
                    fecha DATE NOT NULL,
                    saldo_inicial DECIMAL(10,2) NOT NULL,
                    saldo_final DECIMAL(10,2),
                    ventas_efectivo DECIMAL(10,2) DEFAULT 0,
                    ventas_tarjeta DECIMAL(10,2) DEFAULT 0,
                    ventas_transferencia DECIMAL(10,2) DEFAULT 0,
                    observaciones TEXT,
                    estado VARCHAR(20) DEFAULT 'abierto',
                    created_at TIMESTAMP DEFAULT NOW(),
                    updated_at TIMESTAMP DEFAULT NOW()
                );

                -- √çndices para mejor rendimiento
                CREATE INDEX IF NOT EXISTS idx_productos_codigo ON productos(codigo_barras);
                CREATE INDEX IF NOT EXISTS idx_ventas_fecha ON ventas(created_at);
                CREATE INDEX IF NOT EXISTS idx_ventas_local ON ventas(local_id);
                CREATE INDEX IF NOT EXISTS idx_ventas_sync ON ventas(sync_status);
                CREATE INDEX IF NOT EXISTS idx_pagos_sync ON pagos(sync_status);
                `;
                
                // Ejecutar SQL (en un entorno real, esto se har√≠a con una funci√≥n RPC)
                // Nota: Para simplificar, asumimos que el usuario tiene permisos para ejecutar SQL
                // En producci√≥n, usar√≠a funciones protegidas o migrations
                
                tableStatus.innerHTML = '<p class="success">‚úÖ Tablas creadas correctamente.</p>';
                insertTestDataBtn.disabled = false;
                
            } catch (error) {
                tableStatus.innerHTML = `<p class="error">‚ùå Error: ${error.message}</p>`;
            }
        });

        // Insertar datos de prueba
        insertTestDataBtn.addEventListener('click', async () => {
            if (!supabaseClient) {
                alert('Primero configura la conexi√≥n');
                return;
            }
            
            dataStatus.innerHTML = '<p class="info">üîÑ Insertando datos de prueba...</p>';
            
            try {
                // Insertar local de prueba
                const { data: local, error: localError } = await supabaseClient
                    .from('locales')
                    .insert([
                        {
                            nombre: 'Local Principal',
                            direccion: 'Av. Principal 123',
                            telefono: '011-12345678',
                            email: 'local@empresa.com',
                            config: { impresora: '80mm', moneda: 'ARS' }
                        }
                    ])
                    .select()
                    .single();
                
                if (localError) throw localError;
                
                // Insertar cajas
                const { data: cajas, error: cajasError } = await supabaseClient
                    .from('cajas')
                    .insert([
                        { numero: '01', nombre: 'Caja Principal', local_id: local.id },
                        { numero: '02', nombre: 'Caja Secundaria', local_id: local.id }
                    ]);
                
                if (cajasError) throw cajasError;
                
                // Insertar productos de prueba
                const productos = [
                    {
                        codigo_barras: '7791234567890',
                        nombre: 'Coca Cola 2.25L',
                        precio_costo: 450,
                        porcentaje_ganancia: 30,
                        precio_venta: 585,
                        stock: 100,
                        categoria: 'Bebidas'
                    },
                    {
                        codigo_barras: '7791234567891',
                        nombre: 'Pan de Molde Integral',
                        precio_costo: 320,
                        porcentaje_ganancia: 35,
                        precio_venta: 432,
                        stock: 50,
                        categoria: 'Panader√≠a'
                    },
                    {
                        codigo_barras: '7791234567892',
                        nombre: 'Leche Entera 1L',
                        precio_costo: 280,
                        porcentaje_ganancia: 25,
                        precio_venta: 350,
                        stock: 80,
                        categoria: 'L√°cteos'
                    },
                    {
                        codigo_barras: '7791234567893',
                        nombre: 'Arroz 1kg',
                        precio_costo: 150,
                        porcentaje_ganancia: 40,
                        precio_venta: 210,
                        stock: 120,
                        categoria: 'Almac√©n'
                    }
                ];
                
                const { error: productosError } = await supabaseClient
                    .from('productos')
                    .insert(productos);
                
                if (productosError) throw productosError;
                
                // Insertar clientes de prueba
                const clientes = [
                    {
                        nombre: 'Cliente Contado',
                        dni: '12345678',
                        telefono: '011-98765432',
                        email: 'contado@cliente.com'
                    },
                    {
                        nombre: 'Cliente Cuenta Corriente',
                        dni: '87654321',
                        telefono: '011-12344321',
                        email: 'cuenta@cliente.com',
                        limite_credito: 50000,
                        saldo: 0
                    }
                ];
                
                const { error: clientesError } = await supabaseClient
                    .from('clientes')
                    .insert(clientes);
                
                if (clientesError) throw clientesError;
                
                // Insertar proveedores de prueba
                const proveedores = [
                    {
                        nombre: 'Distribuidora Mayorista SA',
                        contacto: 'Juan P√©rez',
                        telefono: '011-55556666',
                        whatsapp: '+5491155556666',
                        web: 'https://mayorista.com.ar'
                    },
                    {
                        nombre: 'F√°brica de Bebidas',
                        contacto: 'Mar√≠a G√≥mez',
                        telefono: '011-77778888',
                        email: 'ventas@bebidas.com.ar'
                    }
                ];
                
                const { error: proveedoresError } = await supabaseClient
                    .from('proveedores')
                    .insert(proveedores);
                
                if (proveedoresError) throw proveedoresError;
                
                dataStatus.innerHTML = '<p class="success">‚úÖ Datos de prueba insertados correctamente.</p>';
                verifySetupBtn.disabled = false;
                
            } catch (error) {
                dataStatus.innerHTML = `<p class="error">‚ùå Error: ${error.message}</p>`;
            }
        });

        // Verificar configuraci√≥n completa
        verifySetupBtn.addEventListener('click', async () => {
            if (!supabaseClient) {
                alert('Primero configura la conexi√≥n');
                return;
            }
            
            verifyStatus.innerHTML = '<p class="info">üîÑ Verificando configuraci√≥n...</p>';
            
            try {
                // Verificar que existan todas las tablas
                const tables = ['locales', 'cajas', 'productos', 'clientes', 'proveedores'];
                let allTablesExist = true;
                
                for (const table of tables) {
                    const { error } = await supabaseClient
                        .from(table)
                        .select('id')
                        .limit(1);
                    
                    if (error) {
                        allTablesExist = false;
                        break;
                    }
                }
                
                if (!allTablesExist) {
                    throw new Error('Faltan algunas tablas');
                }
                
                // Verificar que haya datos m√≠nimos
                const { data: productos, error: productosError } = await supabaseClient
                    .from('productos')
                    .select('id')
                    .limit(1);
                
                if (productosError || productos.length === 0) {
                    throw new Error('No hay productos cargados');
                }
                
                // Marcar sistema como configurado
                localStorage.setItem('systemConfigured', 'true');
                verifyStatus.innerHTML = '<p class="success">‚úÖ Configuraci√≥n verificada correctamente.</p>';
                goToAppBtn.disabled = false;
                
            } catch (error) {
                verifyStatus.innerHTML = `<p class="error">‚ùå Error en verificaci√≥n: ${error.message}</p>`;
            }
        });

        // Ir a la aplicaci√≥n
        goToAppBtn.addEventListener('click', () => {
            window.location.href = 'index.html';
        });
    </script>
</body>
</html>
