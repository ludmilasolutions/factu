<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Configuración Inicial - Sistema de Facturación</title>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    <style>
        * { box-sizing: border-box; margin: 0; padding: 0; font-family: 'Segoe UI', Arial, sans-serif; }
        body { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); min-height: 100vh; padding: 20px; }
        .setup-container { max-width: 800px; margin: 40px auto; background: white; border-radius: 20px; box-shadow: 0 20px 60px rgba(0,0,0,0.3); overflow: hidden; }
        .header { background: linear-gradient(90deg, #4f46e5, #7c3aed); color: white; padding: 30px; text-align: center; }
        .header h1 { font-size: 28px; margin-bottom: 10px; }
        .header p { opacity: 0.9; }
        .setup-steps { display: flex; padding: 20px; background: #f8fafc; border-bottom: 1px solid #e2e8f0; }
        .step { flex: 1; text-align: center; padding: 10px; position: relative; }
        .step.active { color: #4f46e5; font-weight: bold; }
        .step::after { content: ''; position: absolute; right: -10px; top: 50%; width: 20px; height: 1px; background: #cbd5e1; }
        .step:last-child::after { display: none; }
        .content { padding: 40px; }
        .step-content { display: none; }
        .step-content.active { display: block; animation: fadeIn 0.5s; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .form-group { margin-bottom: 25px; }
        label { display: block; margin-bottom: 8px; font-weight: 600; color: #334155; font-size: 14px; }
        input, select, textarea { width: 100%; padding: 12px 16px; border: 2px solid #e2e8f0; border-radius: 10px; font-size: 16px; transition: border 0.3s; }
        input:focus, select:focus, textarea:focus { outline: none; border-color: #4f46e5; box-shadow: 0 0 0 3px rgba(79, 70, 229, 0.1); }
        .form-row { display: flex; gap: 20px; margin-bottom: 25px; }
        .form-row > div { flex: 1; }
        .buttons { display: flex; justify-content: space-between; margin-top: 40px; padding-top: 30px; border-top: 1px solid #e2e8f0; }
        button { padding: 14px 30px; border: none; border-radius: 10px; font-weight: 600; font-size: 16px; cursor: pointer; transition: all 0.3s; }
        .btn-prev { background: #f1f5f9; color: #64748b; }
        .btn-next { background: linear-gradient(90deg, #4f46e5, #7c3aed); color: white; }
        .btn-prev:hover { background: #e2e8f0; }
        .btn-next:hover { box-shadow: 0 10px 25px rgba(79, 70, 229, 0.4); transform: translateY(-2px); }
        .firebase-config textarea { font-family: monospace; font-size: 14px; height: 200px; }
        .alert { padding: 15px; border-radius: 10px; margin-bottom: 20px; display: none; }
        .alert-success { background: #d1fae5; color: #065f46; border: 1px solid #a7f3d0; }
        .alert-error { background: #fee2e2; color: #991b1b; border: 1px solid #fecaca; }
        .progress-bar { height: 6px; background: #e2e8f0; border-radius: 3px; margin-top: 10px; overflow: hidden; }
        .progress { height: 100%; background: linear-gradient(90deg, #4f46e5, #7c3aed); width: 0%; transition: width 0.5s; }
        .config-summary { background: #f8fafc; padding: 20px; border-radius: 10px; margin-top: 30px; }
        .summary-item { display: flex; justify-content: space-between; padding: 10px 0; border-bottom: 1px solid #e2e8f0; }
        .summary-item:last-child { border-bottom: none; }
        .loading { text-align: center; padding: 40px; }
        .spinner { border: 5px solid #f3f3f3; border-top: 5px solid #4f46e5; border-radius: 50%; width: 50px; height: 50px; animation: spin 1s linear infinite; margin: 0 auto 20px; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        @media (max-width: 768px) {
            .form-row { flex-direction: column; gap: 0; }
            .content { padding: 20px; }
            .setup-steps { flex-direction: column; }
            .step { margin-bottom: 10px; }
            .step::after { display: none; }
        }
    </style>
</head>
<body>
    <div class="setup-container">
        <div class="header">
            <h1>⚙️ Configuración Inicial del Sistema</h1>
            <p>Configuración única del sistema de facturación (Paso 1 de 5)</p>
            <div class="progress-bar"><div class="progress" id="progress"></div></div>
        </div>
        
        <div class="setup-steps">
            <div class="step active" id="step1">1. Firebase</div>
            <div class="step" id="step2">2. Empresa</div>
            <div class="step" id="step3">3. Sucursal</div>
            <div class="step" id="step4">4. Administrador</div>
            <div class="step" id="step5">5. Completar</div>
        </div>
        
        <div class="content">
            <!-- Paso 1: Configuración Firebase -->
            <div class="step-content active" id="content1">
                <h2>Configuración de Firebase</h2>
                <p class="form-group">Ingresa la configuración de tu proyecto Firebase. Esta configuración es necesaria para conectar el sistema con la base de datos en la nube.</p>
                
                <div class="form-group">
                    <label>Configuración Firebase (desde Firebase Console):</label>
                    <textarea id="firebaseConfig" placeholder='{

  apiKey: "AIzaSyCtOiUy2tUQeixUiJxTdI_ESULY4WpqXzw",
  authDomain: "whatsappau-30dc1.firebaseapp.com",
  projectId: "whatsappau-30dc1",
  storageBucket: "whatsappau-30dc1.firebasestorage.app",
  messagingSenderId: "456068013185",
  appId: "1:456068013185:web:5bdd49337fb622e56f0180"
}'></textarea>
                    <small>Obtén estos datos en: Firebase Console → Configuración del proyecto → Aplicaciones web</small>
                </div>
                
                <div class="form-group">
                    <label>Verificar configuración:</label>
                    <button type="button" onclick="testFirebaseConnection()" style="background: #10b981; color: white; padding: 12px 24px; width: auto;">Probar Conexión Firebase</button>
                    <div id="connectionResult" style="margin-top: 10px;"></div>
                </div>
            </div>
            
            <!-- Paso 2: Datos de la Empresa -->
            <div class="step-content" id="content2">
                <h2>Datos de la Empresa</h2>
                <div class="form-group">
                    <label>Nombre de la Empresa *</label>
                    <input type="text" id="empresaNombre" placeholder="Ej: Mi Comercio S.A." required>
                </div>
                
                <div class="form-row">
                    <div>
                        <label>RUC/CUIT/CIF *</label>
                        <input type="text" id="empresaRuc" placeholder="Ej: 30-12345678-9" required>
                    </div>
                    <div>
                        <label>Teléfono</label>
                        <input type="tel" id="empresaTelefono" placeholder="+54 11 1234-5678">
                    </div>
                </div>
                
                <div class="form-group">
                    <label>Email de Contacto *</label>
                    <input type="email" id="empresaEmail" placeholder="contacto@empresa.com" required>
                </div>
                
                <div class="form-group">
                    <label>Dirección Fiscal</label>
                    <textarea id="empresaDireccion" rows="3" placeholder="Calle Principal 123, Ciudad, Provincia"></textarea>
                </div>
                
                <div class="form-group">
                    <label>Actividad Principal</label>
                    <select id="empresaRubro">
                        <option value="general">Comercio General</option>
                        <option value="alimentos">Alimentos</option>
                        <option value="textil">Textil / Indumentaria</option>
                        <option value="electronica">Electrónica</option>
                        <option value="ferreteria">Ferretería</option>
                        <option value="farmacia">Farmacia</option>
                        <option value="otros">Otros</option>
                    </select>
                </div>
            </div>
            
            <!-- Paso 3: Sucursal Principal -->
            <div class="step-content" id="content3">
                <h2>Sucursal Principal</h2>
                <div class="form-group">
                    <label>Nombre de la Sucursal *</label>
                    <input type="text" id="sucursalNombre" placeholder="Ej: Casa Central" required>
                </div>
                
                <div class="form-row">
                    <div>
                        <label>Teléfono Sucursal</label>
                        <input type="tel" id="sucursalTelefono" placeholder="Local: 4312-3456">
                    </div>
                    <div>
                        <label>Código Sucursal *</label>
                        <input type="text" id="sucursalCodigo" placeholder="001" required maxlength="3">
                    </div>
                </div>
                
                <div class="form-group">
                    <label>Dirección de la Sucursal</label>
                    <textarea id="sucursalDireccion" rows="3" placeholder="Dirección comercial para el ticket"></textarea>
                </div>
                
                <div class="form-row">
                    <div>
                        <label>Prefijo Factura *</label>
                        <input type="text" id="sucursalPrefijo" placeholder="A" required maxlength="2">
                        <small>Letra para la serie (Ej: A, B, C)</small>
                    </div>
                    <div>
                        <label>Próximo N° Factura *</label>
                        <input type="number" id="sucursalNumero" placeholder="1" required min="1">
                        <small>Número inicial para facturas</small>
                    </div>
                </div>
                
                <div class="form-group">
                    <label>Mensaje Personalizado Ticket</label>
                    <textarea id="sucursalMensaje" rows="2" placeholder="¡Gracias por su compra! Visite nuestro sitio web"></textarea>
                </div>
            </div>
            
            <!-- Paso 4: Usuario Administrador -->
            <div class="step-content" id="content4">
                <h2>Usuario Administrador</h2>
                <p class="form-group">Crea la cuenta de administrador principal del sistema. Esta cuenta tendrá acceso completo a todas las funciones.</p>
                
                <div class="form-row">
                    <div>
                        <label>Nombre Completo *</label>
                        <input type="text" id="adminNombre" placeholder="Juan Pérez" required>
                    </div>
                    <div>
                        <label>Nombre de Usuario *</label>
                        <input type="text" id="adminUsuario" placeholder="juan.perez" required>
                    </div>
                </div>
                
                <div class="form-row">
                    <div>
                        <label>Email *</label>
                        <input type="email" id="adminEmail" placeholder="admin@empresa.com" required>
                    </div>
                    <div>
                        <label>Teléfono</label>
                        <input type="tel" id="adminTelefono" placeholder="+54 9 11 1234-5678">
                    </div>
                </div>
                
                <div class="form-row">
                    <div>
                        <label>Contraseña *</label>
                        <input type="password" id="adminPassword" placeholder="Mínimo 8 caracteres" required minlength="8">
                    </div>
                    <div>
                        <label>Confirmar Contraseña *</label>
                        <input type="password" id="adminPassword2" placeholder="Repite la contraseña" required>
                    </div>
                </div>
                
                <div id="passwordError" style="color: #dc2626; margin-top: 10px; display: none;">Las contraseñas no coinciden</div>
            </div>
            
            <!-- Paso 5: Resumen y Completar -->
            <div class="step-content" id="content5">
                <h2>Resumen de Configuración</h2>
                <p class="form-group">Revisa la configuración y completa la instalación. Esta acción creará todas las estructuras necesarias en la base de datos.</p>
                
                <div class="config-summary" id="configSummary">
                    <!-- Se llena dinámicamente -->
                </div>
                
                <div class="form-group">
                    <label>
                        <input type="checkbox" id="confirmBackup" required>
                        Confirmo que he hecho una copia de seguridad de los datos existentes
                    </label>
                </div>
                
                <div class="form-group">
                    <label>
                        <input type="checkbox" id="confirmTerms" required>
                        Acepto los términos de uso y comprendo que esta configuración es irreversible
                    </label>
                </div>
                
                <div class="loading" id="loadingSetup" style="display: none;">
                    <div class="spinner"></div>
                    <h3>Configurando sistema...</h3>
                    <p id="setupStep">Inicializando base de datos</p>
                </div>
                
                <div class="alert" id="setupSuccess" style="display: none;">
                    <h3>✅ Configuración Completada</h3>
                    <p>El sistema ha sido configurado exitosamente. Ahora puedes:</p>
                    <ol style="margin-left: 20px; margin-top: 10px;">
                        <li>Cerrar esta página de configuración</li>
                        <li>Abrir <strong>index.html</strong> para usar el sistema</li>
                        <li>Iniciar sesión con tu cuenta de administrador</li>
                    </ol>
                    <div style="margin-top: 20px; padding: 15px; background: #dbeafe; border-radius: 8px;">
                        <strong>⚠️ IMPORTANTE:</strong> No vuelvas a abrir setup.html. Para evitar configuraciones accidentales, el sistema ahora está bloqueado.
                    </div>
                </div>
                
                <div class="alert" id="setupError" style="display: none;">
                    <h3>❌ Error en la Configuración</h3>
                    <p id="errorMessage">Ha ocurrido un error durante la configuración.</p>
                    <button type="button" onclick="retrySetup()" style="background: #dc2626; color: white; margin-top: 10px;">Reintentar Configuración</button>
                </div>
            </div>
            
            <div class="buttons">
                <button type="button" class="btn-prev" onclick="prevStep()" id="prevBtn" style="display: none;">← Anterior</button>
                <button type="button" class="btn-next" onclick="nextStep()" id="nextBtn">Siguiente →</button>
                <button type="button" class="btn-next" onclick="completeSetup()" id="completeBtn" style="display: none; background: #10b981;">✅ Completar Configuración</button>
            </div>
        </div>
    </div>

    <script>
        // Variables globales
        let currentStep = 1;
        const totalSteps = 5;
        let firebaseApp = null;
        let firestore = null;
        let auth = null;
        let configData = {};
        
        // Inicializar progreso
        document.getElementById('progress').style.width = `${(currentStep/totalSteps)*100}%`;
        
        // Navegación entre pasos
        function updateSteps() {
            // Actualizar progreso
            document.getElementById('progress').style.width = `${(currentStep/totalSteps)*100}%`;
            
            // Actualizar indicadores de paso
            document.querySelectorAll('.step').forEach((step, index) => {
                step.classList.toggle('active', index + 1 === currentStep);
            });
            
            // Mostrar/ocultar contenido
            document.querySelectorAll('.step-content').forEach((content, index) => {
                content.classList.toggle('active', index + 1 === currentStep);
            });
            
            // Mostrar/ocultar botones
            document.getElementById('prevBtn').style.display = currentStep > 1 ? 'block' : 'none';
            document.getElementById('nextBtn').style.display = currentStep < totalSteps ? 'block' : 'none';
            document.getElementById('completeBtn').style.display = currentStep === totalSteps ? 'block' : 'none';
            
            // Actualizar resumen en el último paso
            if (currentStep === totalSteps) {
                updateSummary();
            }
        }
        
        function nextStep() {
            if (!validateStep(currentStep)) return;
            
            if (currentStep < totalSteps) {
                currentStep++;
                updateSteps();
            }
        }
        
        function prevStep() {
            if (currentStep > 1) {
                currentStep--;
                updateSteps();
            }
        }
        
        // Validación por paso
        function validateStep(step) {
            switch(step) {
                case 1:
                    const configText = document.getElementById('firebaseConfig').value;
                    if (!configText.trim()) {
                        alert('Por favor, ingresa la configuración de Firebase');
                        return false;
                    }
                    try {
                        JSON.parse(configText);
                    } catch(e) {
                        alert('La configuración de Firebase no es un JSON válido');
                        return false;
                    }
                    return true;
                    
                case 2:
                    if (!document.getElementById('empresaNombre').value) {
                        alert('Por favor, ingresa el nombre de la empresa');
                        return false;
                    }
                    if (!document.getElementById('empresaRuc').value) {
                        alert('Por favor, ingresa el RUC/CUIT de la empresa');
                        return false;
                    }
                    if (!document.getElementById('empresaEmail').value) {
                        alert('Por favor, ingresa el email de contacto');
                        return false;
                    }
                    return true;
                    
                case 3:
                    if (!document.getElementById('sucursalNombre').value) {
                        alert('Por favor, ingresa el nombre de la sucursal');
                        return false;
                    }
                    if (!document.getElementById('sucursalCodigo').value) {
                        alert('Por favor, ingresa el código de sucursal');
                        return false;
                    }
                    if (!document.getElementById('sucursalPrefijo').value) {
                        alert('Por favor, ingresa el prefijo de factura');
                        return false;
                    }
                    if (!document.getElementById('sucursalNumero').value) {
                        alert('Por favor, ingresa el próximo número de factura');
                        return false;
                    }
                    return true;
                    
                case 4:
                    if (!document.getElementById('adminNombre').value) {
                        alert('Por favor, ingresa el nombre del administrador');
                        return false;
                    }
                    if (!document.getElementById('adminUsuario').value) {
                        alert('Por favor, ingresa el nombre de usuario');
                        return false;
                    }
                    if (!document.getElementById('adminEmail').value) {
                        alert('Por favor, ingresa el email del administrador');
                        return false;
                    }
                    const pass1 = document.getElementById('adminPassword').value;
                    const pass2 = document.getElementById('adminPassword2').value;
                    if (pass1.length < 8) {
                        alert('La contraseña debe tener al menos 8 caracteres');
                        return false;
                    }
                    if (pass1 !== pass2) {
                        document.getElementById('passwordError').style.display = 'block';
                        return false;
                    } else {
                        document.getElementById('passwordError').style.display = 'none';
                    }
                    return true;
                    
                case 5:
                    if (!document.getElementById('confirmBackup').checked) {
                        alert('Por favor, confirma que has hecho una copia de seguridad');
                        return false;
                    }
                    if (!document.getElementById('confirmTerms').checked) {
                        alert('Por favor, acepta los términos de uso');
                        return false;
                    }
                    return true;
                    
                default:
                    return true;
            }
        }
        
        // Probar conexión con Firebase
        async function testFirebaseConnection() {
            const configText = document.getElementById('firebaseConfig').value;
            const resultDiv = document.getElementById('connectionResult');
            
            if (!configText.trim()) {
                resultDiv.innerHTML = '<div style="color: #dc2626;">❌ Por favor, ingresa la configuración de Firebase</div>';
                return;
            }
            
            let config;
            try {
                config = JSON.parse(configText);
            } catch(e) {
                resultDiv.innerHTML = `<div style="color: #dc2626;">❌ JSON inválido: ${e.message}</div>`;
                return;
            }
            
            resultDiv.innerHTML = '<div style="color: #f59e0b;">⏳ Conectando con Firebase...</div>';
            
            try {
                // Intentar inicializar Firebase
                firebaseApp = firebase.initializeApp(config);
                auth = firebase.auth();
                firestore = firebase.firestore();
                
                // Probar autenticación anónima (solo para prueba)
                await firestore.collection('test').doc('test').set({
                    test: true,
                    timestamp: new Date()
                });
                
                await firestore.collection('test').doc('test').delete();
                
                resultDiv.innerHTML = '<div style="color: #10b981;">✅ Conexión exitosa con Firebase</div>';
                
                // Guardar configuración para uso posterior
                configData.firebaseConfig = config;
                
            } catch(error) {
                resultDiv.innerHTML = `<div style="color: #dc2626;">❌ Error de conexión: ${error.message}</div>`;
                console.error('Firebase error:', error);
            }
        }
        
        // Actualizar resumen
        function updateSummary() {
            const summaryDiv = document.getElementById('configSummary');
            
            // Recolectar todos los datos
            const empresa = {
                nombre: document.getElementById('empresaNombre').value,
                ruc: document.getElementById('empresaRuc').value,
                telefono: document.getElementById('empresaTelefono').value,
                email: document.getElementById('empresaEmail').value,
                direccion: document.getElementById('empresaDireccion').value,
                rubro: document.getElementById('empresaRubro').value
            };
            
            const sucursal = {
                nombre: document.getElementById('sucursalNombre').value,
                telefono: document.getElementById('sucursalTelefono').value,
                codigo: document.getElementById('sucursalCodigo').value,
                direccion: document.getElementById('sucursalDireccion').value,
                prefijo: document.getElementById('sucursalPrefijo').value,
                numero: document.getElementById('sucursalNumero').value,
                mensaje: document.getElementById('sucursalMensaje').value
            };
            
            const admin = {
                nombre: document.getElementById('adminNombre').value,
                usuario: document.getElementById('adminUsuario').value,
                email: document.getElementById('adminEmail').value,
                telefono: document.getElementById('adminTelefono').value
            };
            
            summaryDiv.innerHTML = `
                <div class="summary-item">
                    <span><strong>Empresa:</strong></span>
                    <span>${empresa.nombre}</span>
                </div>
                <div class="summary-item">
                    <span><strong>RUC/CUIT:</strong></span>
                    <span>${empresa.ruc}</span>
                </div>
                <div class="summary-item">
                    <span><strong>Sucursal:</strong></span>
                    <span>${sucursal.nombre} (${sucursal.codigo})</span>
                </div>
                <div class="summary-item">
                    <span><strong>Serie Factura:</strong></span>
                    <span>${sucursal.prefijo}-${sucursal.numero.toString().padStart(8, '0')}</span>
                </div>
                <div class="summary-item">
                    <span><strong>Administrador:</strong></span>
                    <span>${admin.nombre} (${admin.usuario})</span>
                </div>
                <div class="summary-item">
                    <span><strong>Email Admin:</strong></span>
                    <span>${admin.email}</span>
                </div>
            `;
            
            // Guardar datos para el setup
            configData.empresa = empresa;
            configData.sucursal = sucursal;
            configData.admin = admin;
        }
        
        // Completar configuración
        async function completeSetup() {
            if (!validateStep(5)) return;
            
            // Mostrar loading
            document.getElementById('loadingSetup').style.display = 'block';
            document.getElementById('completeBtn').style.display = 'none';
            document.getElementById('prevBtn').style.display = 'none';
            
            try {
                // Paso 1: Inicializar Firebase si no está inicializado
                if (!firebaseApp) {
                    updateSetupStep('Inicializando Firebase...');
                    firebaseApp = firebase.initializeApp(configData.firebaseConfig);
                    auth = firebase.auth();
                    firestore = firebase.firestore();
                }
                
                // Paso 2: Crear usuario administrador
                updateSetupStep('Creando usuario administrador...');
                const adminEmail = configData.admin.email;
                const adminPassword = document.getElementById('adminPassword').value;
                
                const userCredential = await auth.createUserWithEmailAndPassword(adminEmail, adminPassword);
                const adminUser = userCredential.user;
                
                // Paso 3: Crear colecciones base
                updateSetupStep('Creando estructura de datos...');
                
                // Crear documento de configuración
                await firestore.collection('config').doc('system').set({
                    version: '1.0',
                    setupDate: new Date(),
                    setupCompleted: true,
                    setupBlocked: true // Bloquear setup futuro
                });
                
                // Crear documento de empresa
                await firestore.collection('empresas').doc('principal').set({
                    ...configData.empresa,
                    createdAt: new Date(),
                    updatedAt: new Date(),
                    status: 'active'
                });
                
                // Crear sucursal principal
                const sucursalRef = firestore.collection('sucursales').doc();
                await sucursalRef.set({
                    ...configData.sucursal,
                    empresaId: 'principal',
                    empresaNombre: configData.empresa.nombre,
                    createdAt: new Date(),
                    updatedAt: new Date(),
                    status: 'active',
                    ultimaFactura: parseInt(configData.sucursal.numero) - 1,
                    cajasActivas: 0,
                    turnoActual: null
                });
                
                // Crear usuario administrador en Firestore
                await firestore.collection('usuarios').doc(adminUser.uid).set({
                    ...configData.admin,
                    uid: adminUser.uid,
                    empresaId: 'principal',
                    sucursalId: sucursalRef.id,
                    rol: 'admin_general',
                    permisos: ['all'],
                    createdAt: new Date(),
                    updatedAt: new Date(),
                    status: 'active',
                    lastLogin: null
                });
                
                // Crear colecciones base vacías con sus estructuras
                const collections = [
                    'productos', 'clientes', 'ventas', 'presupuestos', 
                    'cajas', 'turnos', 'pagos', 'proveedores', 'pedidos',
                    'stock_movimientos', 'notas_internas', 'sync_queue'
                ];
                
                for (const collection of collections) {
                    updateSetupStep(`Creando colección: ${collection}...`);
                    // Solo crear un documento de estructura para cada colección
                    await firestore.collection(collection).doc('_estructura').set({
                        description: `Estructura para ${collection}`,
                        createdAt: new Date(),
                        version: '1.0'
                    });
                }
                
                // Crear configuración de ticket
                await firestore.collection('config_tickets').doc('principal').set({
                    empresaId: 'principal',
                    sucursalId: sucursalRef.id,
                    encabezado: configData.empresa.nombre,
                    direccion: configData.sucursal.direccion || configData.empresa.direccion,
                    telefono: configData.sucursal.telefono || configData.empresa.telefono,
                    mensaje: configData.sucursal.mensaje || '¡Gracias por su compra!',
                    logoUrl: '',
                    createdAt: new Date(),
                    updatedAt: new Date()
                });
                
                // Crear primer turno
                const turnoRef = firestore.collection('turnos').doc();
                await turnoRef.set({
                    sucursalId: sucursalRef.id,
                    usuarioId: adminUser.uid,
                    usuarioNombre: configData.admin.nombre,
                    fecha: new Date(),
                    tipo: 'setup',
                    apertura: new Date(),
                    cierre: null,
                    estado: 'cerrado',
                    ventasCount: 0,
                    totalVentas: 0,
                    efectivoInicial: 0,
                    efectivoFinal: 0,
                    observaciones: 'Turno de configuración inicial'
                });
                
                // Paso 4: Bloquear setup futuro
                updateSetupStep('Bloqueando configuración futura...');
                await firestore.collection('config').doc('system').update({
                    setupBlocked: true,
                    lastUpdate: new Date()
                });
                
                // Crear registro de setup
                await firestore.collection('system_logs').doc().set({
                    tipo: 'setup_completed',
                    mensaje: 'Configuración inicial completada',
                    fecha: new Date(),
                    usuarioId: adminUser.uid,
                    usuarioNombre: configData.admin.nombre,
                    detalles: {
                        empresa: configData.empresa.nombre,
                        sucursal: configData.sucursal.nombre,
                        version: '1.0'
                    }
                });
                
                // Ocultar loading y mostrar éxito
                document.getElementById('loadingSetup').style.display = 'none';
                document.getElementById('setupSuccess').style.display = 'block';
                
                // Deshabilitar todos los inputs y botones
                document.querySelectorAll('input, select, textarea, button').forEach(el => {
                    el.disabled = true;
                });
                
                // Guardar en localStorage que el setup está completo
                localStorage.setItem('pos_system_setup_completed', 'true');
                localStorage.setItem('pos_system_sucursal_id', sucursalRef.id);
                
            } catch(error) {
                console.error('Setup error:', error);
                document.getElementById('loadingSetup').style.display = 'none';
                document.getElementById('setupError').style.display = 'block';
                document.getElementById('errorMessage').textContent = error.message;
                document.getElementById('completeBtn').style.display = 'block';
                document.getElementById('prevBtn').style.display = 'block';
            }
        }
        
        function updateSetupStep(message) {
            document.getElementById('setupStep').textContent = message;
        }
        
        function retrySetup() {
            document.getElementById('setupError').style.display = 'none';
            document.getElementById('completeBtn').style.display = 'block';
            document.getElementById('prevBtn').style.display = 'block';
        }
        
        // Verificar si el setup ya fue completado
        async function checkExistingSetup() {
            try {
                const configText = document.getElementById('firebaseConfig').value;
                if (!configText.trim()) return;
                
                const config = JSON.parse(configText);
                const tempApp = firebase.initializeApp(config, 'TempCheck');
                const tempFirestore = firebase.firestore(tempApp);
                
                const systemConfig = await tempFirestore.collection('config').doc('system').get();
                
                if (systemConfig.exists && systemConfig.data().setupCompleted) {
                    if (confirm('⚠️ El sistema ya ha sido configurado. ¿Deseas continuar de todos modos? Esta acción podría sobrescribir configuraciones existentes.')) {
                        return;
                    } else {
                        window.location.href = 'index.html';
                    }
                }
                
                // Limpiar app temporal
                tempApp.delete();
            } catch(error) {
                // Ignorar errores en la verificación
                console.log('Verificación de setup:', error.message);
            }
        }
        
        // Event listeners
        document.getElementById('firebaseConfig').addEventListener('blur', checkExistingSetup);
        
        // Inicializar
        updateSteps();
    </script>
</body>
</html>
