<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Configuraci√≥n - Sistema POS</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #333;
            padding: 20px;
        }

        .container {
            max-width: 800px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            padding: 40px;
        }

        header {
            text-align: center;
            margin-bottom: 30px;
        }

        h1 {
            font-size: 2.5rem;
            color: #4a5568;
            margin-bottom: 10px;
        }

        .subtitle {
            color: #718096;
            font-size: 0.9rem;
            margin-bottom: 20px;
        }

        .setup-section {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        .card {
            background: #f7fafc;
            border-radius: 15px;
            padding: 25px;
            border: 1px solid #e2e8f0;
            transition: all 0.3s ease;
        }

        .card.active {
            border-color: #667eea;
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.1);
        }

        .card.completed {
            border-color: #38a169;
            background: #f0fff4;
        }

        .card-header {
            display: flex;
            align-items: center;
            gap: 15px;
            margin-bottom: 15px;
        }

        .step-number {
            background: #667eea;
            color: white;
            width: 30px;
            height: 30px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 0.9rem;
        }

        .step-number.completed {
            background: #38a169;
        }

        h2 {
            color: #4a5568;
            font-size: 1.5rem;
            flex: 1;
        }

        .info-text {
            color: #718096;
            margin-bottom: 15px;
            line-height: 1.5;
        }

        .form-group {
            margin-bottom: 15px;
        }

        label {
            display: block;
            margin-bottom: 5px;
            color: #4a5568;
            font-weight: 500;
        }

        input, select {
            width: 100%;
            padding: 12px;
            border: 2px solid #e2e8f0;
            border-radius: 10px;
            font-size: 1rem;
            transition: border-color 0.3s;
        }

        input:focus, select:focus {
            outline: none;
            border-color: #667eea;
        }

        .button-group {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            margin-bottom: 15px;
        }

        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 10px;
            font-size: 1rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .btn-primary {
            background: #667eea;
            color: white;
        }

        .btn-primary:hover:not(:disabled) {
            background: #5a67d8;
            transform: translateY(-2px);
            box-shadow: 0 6px 15px rgba(102, 126, 234, 0.4);
        }

        .btn-secondary {
            background: #e2e8f0;
            color: #4a5568;
        }

        .btn-secondary:hover:not(:disabled) {
            background: #cbd5e0;
        }

        .btn-success {
            background: #38a169;
            color: white;
        }

        .btn-success:hover:not(:disabled) {
            background: #2f855a;
            transform: translateY(-2px);
            box-shadow: 0 6px 15px rgba(56, 161, 105, 0.4);
        }

        .btn-warning {
            background: #d69e2e;
            color: white;
        }

        .btn-warning:hover:not(:disabled) {
            background: #b7791f;
        }

        .btn-outline {
            background: transparent;
            border: 2px solid #667eea;
            color: #667eea;
        }

        .btn-outline:hover:not(:disabled) {
            background: #667eea;
            color: white;
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .status {
            margin-top: 15px;
            padding: 12px;
            border-radius: 10px;
            display: none;
        }

        .status.show {
            display: block;
        }

        .success {
            background: #c6f6d5;
            color: #22543d;
            border: 1px solid #9ae6b4;
        }

        .error {
            background: #fed7d7;
            color: #742a2a;
            border: 1px solid #fc8181;
        }

        .info {
            background: #bee3f8;
            color: #2a4365;
            border: 1px solid #90cdf4;
        }

        .warning {
            background: #feebc8;
            color: #744210;
            border: 1px solid #fbd38d;
        }

        .navigation {
            margin-top: 30px;
            text-align: center;
        }

        .sql-code {
            background: #2d3748;
            color: #e2e8f0;
            padding: 15px;
            border-radius: 10px;
            font-family: 'Courier New', monospace;
            font-size: 0.9rem;
            overflow-x: auto;
            margin: 15px 0;
            max-height: 300px;
            overflow-y: auto;
        }

        .instructions {
            background: #edf2f7;
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 15px;
        }

        .instructions ol {
            margin-left: 20px;
            margin-bottom: 15px;
        }

        .instructions li {
            margin-bottom: 8px;
        }

        .step-content {
            display: none;
        }

        .step-content.active {
            display: block;
        }

        .copy-btn {
            background: #4a5568;
            color: white;
            border: none;
            padding: 5px 10px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 0.8rem;
            margin-left: 10px;
        }

        .copy-btn:hover {
            background: #2d3748;
        }

        .test-data {
            background: #f0fff4;
            padding: 15px;
            border-radius: 10px;
            margin-top: 15px;
        }

        .progress-bar {
            height: 6px;
            background: #e2e8f0;
            border-radius: 3px;
            margin: 20px 0;
            overflow: hidden;
        }

        .progress-fill {
            height: 100%;
            background: #667eea;
            width: 0%;
            transition: width 0.3s ease;
        }

        .progress-steps {
            display: flex;
            justify-content: space-between;
            margin-top: 10px;
            font-size: 0.9rem;
            color: #718096;
        }

        .progress-step {
            text-align: center;
            flex: 1;
        }

        .progress-step.active {
            color: #667eea;
            font-weight: 500;
        }

        .progress-step.completed {
            color: #38a169;
        }

        .checkmark {
            color: #38a169;
            font-size: 1.2rem;
            margin-right: 5px;
        }

        @media (max-width: 768px) {
            .container {
                padding: 20px;
            }
            
            h1 {
                font-size: 2rem;
            }
            
            .button-group {
                flex-direction: column;
            }
            
            .btn {
                width: 100%;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>üîß Configuraci√≥n del Sistema POS</h1>
            <p class="subtitle">Sistema completo de facturaci√≥n web - MultiLocal - Offline First</p>
        </header>

        <!-- Barra de progreso -->
        <div class="progress-bar">
            <div class="progress-fill" id="progressFill"></div>
        </div>
        <div class="progress-steps">
            <div class="progress-step" id="step1">1. Supabase</div>
            <div class="progress-step" id="step2">2. Tablas</div>
            <div class="progress-step" id="step3">3. Datos</div>
            <div class="progress-step" id="step4">4. Verificar</div>
        </div>

        <div class="setup-section">
            <!-- Paso 1: Crear proyecto en Supabase -->
            <div class="card active" id="card1">
                <div class="card-header">
                    <div class="step-number">1</div>
                    <h2>üìã PASO 1: Crear Proyecto en Supabase</h2>
                </div>
                
                <div class="step-content active">
                    <div class="instructions">
                        <p>Sigue estos pasos para crear tu base de datos gratuita:</p>
                        <ol>
                            <li>Ve a <a href="https://supabase.com" target="_blank">supabase.com</a></li>
                            <li>Haz clic en "Start your project"</li>
                            <li>Inicia sesi√≥n con tu cuenta de GitHub o Google</li>
                            <li>Crea una organizaci√≥n</li>
                            <li>Selecciona "Create new project"</li>
                            <li>Elige un nombre para tu proyecto (ej: "mi-pos")</li>
                            <li>Crea una contrase√±a segura para la base de datos</li>
                            <li>Selecciona la regi√≥n m√°s cercana</li>
                            <li>Haz clic en "Create new project"</li>
                        </ol>
                        <p class="warning">‚ö†Ô∏è El proyecto puede tardar 1-2 minutos en crearse</p>
                    </div>

                    <div class="form-group">
                        <label for="supabaseUrl">URL de Supabase:</label>
                        <input type="text" id="supabaseUrl" placeholder="https://xxxxxxxxxxxx.supabase.co">
                        <small>Copia la URL de "Project URL"</small>
                    </div>
                    
                    <div class="form-group">
                        <label for="supabaseKey">Clave An√≥nima (anon public):</label>
                        <input type="text" id="supabaseKey" placeholder="eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...">
                        <small>Copia la clave de "anon public" en Project API keys</small>
                    </div>
                    
                    <div class="button-group">
                        <button id="testConnection" class="btn btn-primary">Probar Conexi√≥n</button>
                        <button id="nextStep1" class="btn btn-success" disabled>Siguiente ‚Üí</button>
                    </div>
                    
                    <div id="connectionStatus" class="status"></div>
                </div>
            </div>

            <!-- Paso 2: Crear tablas -->
            <div class="card" id="card2">
                <div class="card-header">
                    <div class="step-number">2</div>
                    <h2>üóÉÔ∏è PASO 2: Crear Tablas en la Base de Datos</h2>
                </div>
                
                <div class="step-content">
                    <p class="info-text">Copia y pega este c√≥digo SQL en el editor de Supabase:</p>
                    
                    <div class="sql-code" id="sqlCode">
-- SISTEMA POS - CREACI√ìN DE TABLAS COMPLETAS

-- 1. Tabla de locales/comercios
CREATE TABLE IF NOT EXISTS locales (
    id UUID DEFAULT gen_random_uuid() PRIMARY KEY,
    nombre VARCHAR(100) NOT NULL,
    direccion TEXT,
    telefono VARCHAR(20),
    email VARCHAR(100),
    config JSONB DEFAULT '{}',
    activo BOOLEAN DEFAULT true,
    created_at TIMESTAMP DEFAULT NOW()
);

-- 2. Tabla de cajas
CREATE TABLE IF NOT EXISTS cajas (
    id UUID DEFAULT gen_random_uuid() PRIMARY KEY,
    numero VARCHAR(20) NOT NULL,
    nombre VARCHAR(100),
    local_id UUID,
    activa BOOLEAN DEFAULT true,
    created_at TIMESTAMP DEFAULT NOW()
);

-- 3. Tabla de productos
CREATE TABLE IF NOT EXISTS productos (
    id UUID DEFAULT gen_random_uuid() PRIMARY KEY,
    codigo_barras VARCHAR(50),
    nombre VARCHAR(200) NOT NULL,
    descripcion TEXT,
    precio_costo DECIMAL(10,2) DEFAULT 0,
    porcentaje_ganancia DECIMAL(5,2) DEFAULT 30,
    precio_venta DECIMAL(10,2) NOT NULL,
    stock INTEGER DEFAULT 0,
    stock_minimo INTEGER DEFAULT 5,
    categoria VARCHAR(100),
    proveedor_id UUID,
    activo BOOLEAN DEFAULT true,
    promocion JSONB DEFAULT '{}',
    created_at TIMESTAMP DEFAULT NOW(),
    updated_at TIMESTAMP DEFAULT NOW()
);

-- 4. Tabla de clientes
CREATE TABLE IF NOT EXISTS clientes (
    id UUID DEFAULT gen_random_uuid() PRIMARY KEY,
    nombre VARCHAR(100) NOT NULL,
    dni VARCHAR(20),
    telefono VARCHAR(20),
    email VARCHAR(100),
    direccion TEXT,
    limite_credito DECIMAL(10,2) DEFAULT 0,
    saldo DECIMAL(10,2) DEFAULT 0,
    activo BOOLEAN DEFAULT true,
    created_at TIMESTAMP DEFAULT NOW()
);

-- 5. Tabla de proveedores
CREATE TABLE IF NOT EXISTS proveedores (
    id UUID DEFAULT gen_random_uuid() PRIMARY KEY,
    nombre VARCHAR(100) NOT NULL,
    contacto VARCHAR(100),
    telefono VARCHAR(20),
    email VARCHAR(100),
    web VARCHAR(200),
    whatsapp VARCHAR(20),
    activo BOOLEAN DEFAULT true,
    created_at TIMESTAMP DEFAULT NOW()
);

-- 6. Tabla de ventas
CREATE TABLE IF NOT EXISTS ventas (
    id UUID DEFAULT gen_random_uuid() PRIMARY KEY,
    local_id UUID,
    caja_id UUID,
    usuario_id UUID,
    cliente_id UUID,
    total DECIMAL(10,2) NOT NULL,
    descuento DECIMAL(10,2) DEFAULT 0,
    estado VARCHAR(20) DEFAULT 'completada',
    tipo_venta VARCHAR(20) DEFAULT 'contado',
    observaciones TEXT,
    offline_id VARCHAR(100),
    sync_status VARCHAR(20) DEFAULT 'synced',
    created_at TIMESTAMP DEFAULT NOW(),
    updated_at TIMESTAMP DEFAULT NOW()
);

-- 7. Tabla de items de venta
CREATE TABLE IF NOT EXISTS venta_items (
    id UUID DEFAULT gen_random_uuid() PRIMARY KEY,
    venta_id UUID,
    producto_id UUID,
    cantidad INTEGER NOT NULL,
    precio_unitario DECIMAL(10,2) NOT NULL,
    subtotal DECIMAL(10,2) NOT NULL,
    descuento DECIMAL(10,2) DEFAULT 0,
    created_at TIMESTAMP DEFAULT NOW()
);

-- 8. Tabla de pagos
CREATE TABLE IF NOT EXISTS pagos (
    id UUID DEFAULT gen_random_uuid() PRIMARY KEY,
    venta_id UUID,
    metodo VARCHAR(50) NOT NULL,
    monto DECIMAL(10,2) NOT NULL,
    referencia VARCHAR(100),
    estado VARCHAR(20) DEFAULT 'completado',
    offline_id VARCHAR(100),
    sync_status VARCHAR(20) DEFAULT 'synced',
    created_at TIMESTAMP DEFAULT NOW()
);

-- 9. Tabla de presupuestos
CREATE TABLE IF NOT EXISTS presupuestos (
    id UUID DEFAULT gen_random_uuid() PRIMARY KEY,
    local_id UUID,
    cliente_id UUID,
    usuario_id UUID,
    total DECIMAL(10,2) NOT NULL,
    valido_hasta DATE,
    estado VARCHAR(20) DEFAULT 'pendiente',
    observaciones TEXT,
    offline_id VARCHAR(100),
    sync_status VARCHAR(20) DEFAULT 'synced',
    created_at TIMESTAMP DEFAULT NOW()
);

-- 10. Tabla de items de presupuesto
CREATE TABLE IF NOT EXISTS presupuesto_items (
    id UUID DEFAULT gen_random_uuid() PRIMARY KEY,
    presupuesto_id UUID,
    producto_id UUID,
    cantidad INTEGER NOT NULL,
    precio_unitario DECIMAL(10,2) NOT NULL,
    subtotal DECIMAL(10,2) NOT NULL,
    created_at TIMESTAMP DEFAULT NOW()
);

-- 11. Tabla de cuentas corrientes
CREATE TABLE IF NOT EXISTS cuentas_corrientes (
    id UUID DEFAULT gen_random_uuid() PRIMARY KEY,
    cliente_id UUID,
    tipo_movimiento VARCHAR(20) NOT NULL,
    monto DECIMAL(10,2) NOT NULL,
    saldo_anterior DECIMAL(10,2) NOT NULL,
    saldo_nuevo DECIMAL(10,2) NOT NULL,
    referencia_id UUID,
    observaciones TEXT,
    offline_id VARCHAR(100),
    sync_status VARCHAR(20) DEFAULT 'synced',
    created_at TIMESTAMP DEFAULT NOW()
);

-- 12. Tabla de cierres de caja
CREATE TABLE IF NOT EXISTS cierres_caja (
    id UUID DEFAULT gen_random_uuid() PRIMARY KEY,
    local_id UUID,
    caja_id UUID,
    usuario_id UUID,
    turno VARCHAR(10) NOT NULL,
    fecha DATE NOT NULL,
    saldo_inicial DECIMAL(10,2) NOT NULL,
    saldo_final DECIMAL(10,2),
    ventas_efectivo DECIMAL(10,2) DEFAULT 0,
    ventas_tarjeta DECIMAL(10,2) DEFAULT 0,
    ventas_transferencia DECIMAL(10,2) DEFAULT 0,
    observaciones TEXT,
    estado VARCHAR(20) DEFAULT 'abierto',
    created_at TIMESTAMP DEFAULT NOW(),
    updated_at TIMESTAMP DEFAULT NOW()
);
                    </div>
                    
                    <div class="button-group">
                        <button id="copySql" class="btn btn-secondary">üìã Copiar SQL al Portapapeles</button>
                        <button id="executeSql" class="btn btn-primary" disabled>Ejecutar SQL en Supabase</button>
                        <button id="nextStep2" class="btn btn-success" disabled>Siguiente ‚Üí</button>
                    </div>
                    
                    <div class="instructions" style="margin-top: 15px;">
                        <p><strong>¬øC√≥mo ejecutar el SQL?</strong></p>
                        <ol>
                            <li>En el men√∫ izquierdo de Supabase, haz clic en "SQL Editor"</li>
                            <li>Haz clic en "New query"</li>
                            <li>Pega el c√≥digo SQL anterior</li>
                            <li>Haz clic en "Run" (‚ñ∂Ô∏è)</li>
                            <li>Espera a que se ejecute (puede tardar unos segundos)</li>
                        </ol>
                    </div>
                    
                    <div id="sqlStatus" class="status"></div>
                </div>
            </div>

            <!-- Paso 3: Insertar datos de prueba -->
            <div class="card" id="card3">
                <div class="card-header">
                    <div class="step-number">3</div>
                    <h2>üìä PASO 3: Insertar Datos de Prueba</h2>
                </div>
                
                <div class="step-content">
                    <p class="info-text">Una vez creadas las tablas, inserta datos iniciales para probar el sistema:</p>
                    
                    <div class="test-data">
                        <p><strong>Datos que se insertar√°n:</strong></p>
                        <ul>
                            <li>‚úÖ 1 Local principal</li>
                            <li>‚úÖ 2 Cajas (01 y 02)</li>
                            <li>‚úÖ 4 Productos de ejemplo</li>
                            <li>‚úÖ 2 Clientes (contado y cuenta corriente)</li>
                            <li>‚úÖ 2 Proveedores</li>
                        </ul>
                    </div>
                    
                    <div class="button-group">
                        <button id="insertTestData" class="btn btn-primary" disabled>Insertar Datos de Prueba</button>
                        <button id="nextStep3" class="btn btn-success" disabled>Siguiente ‚Üí</button>
                    </div>
                    
                    <div id="dataStatus" class="status"></div>
                </div>
            </div>

            <!-- Paso 4: Verificar configuraci√≥n -->
            <div class="card" id="card4">
                <div class="card-header">
                    <div class="step-number">4</div>
                    <h2>‚úÖ PASO 4: Verificar Configuraci√≥n</h2>
                </div>
                
                <div class="step-content">
                    <p class="info-text">Verifica que todo est√© correctamente configurado antes de usar el sistema.</p>
                    
                    <div id="verificationList">
                        <div class="verification-item">
                            <input type="checkbox" id="check1" disabled>
                            <label for="check1">Conexi√≥n a Supabase establecida</label>
                        </div>
                        <div class="verification-item">
                            <input type="checkbox" id="check2" disabled>
                            <label for="check2">Tablas creadas correctamente</label>
                        </div>
                        <div class="verification-item">
                            <input type="checkbox" id="check3" disabled>
                            <label for="check3">Datos de prueba insertados</label>
                        </div>
                        <div class="verification-item">
                            <input type="checkbox" id="check4" disabled>
                            <label for="check4">Configuraci√≥n guardada</label>
                        </div>
                    </div>
                    
                    <div class="button-group" style="margin-top: 20px;">
                        <button id="verifySetup" class="btn btn-primary" disabled>Verificar Configuraci√≥n</button>
                        <button id="completeSetup" class="btn btn-success" disabled>üöÄ Completar Configuraci√≥n</button>
                    </div>
                    
                    <div id="verifyStatus" class="status"></div>
                </div>
            </div>
        </div>

        <div class="navigation">
            <button id="goToApp" class="btn btn-success" disabled>üöÄ Ir a la Aplicaci√≥n POS</button>
            <p style="margin-top: 10px; color: #718096; font-size: 0.9rem;">
                Una vez completados todos los pasos, podr√°s usar el sistema POS
            </p>
        </div>
    </div>

    <script>
        // Configuraci√≥n
        let supabaseClient = null;
        let supabaseLoaded = false;
        let currentStep = 1;
        let setupCompleted = false;

        // Elementos del DOM
        const supabaseUrlInput = document.getElementById('supabaseUrl');
        const supabaseKeyInput = document.getElementById('supabaseKey');
        const testConnectionBtn = document.getElementById('testConnection');
        const nextStep1Btn = document.getElementById('nextStep1');
        const nextStep2Btn = document.getElementById('nextStep2');
        const nextStep3Btn = document.getElementById('nextStep3');
        const executeSqlBtn = document.getElementById('executeSql');
        const insertTestDataBtn = document.getElementById('insertTestData');
        const verifySetupBtn = document.getElementById('verifySetup');
        const completeSetupBtn = document.getElementById('completeSetup');
        const goToAppBtn = document.getElementById('goToApp');
        const copySqlBtn = document.getElementById('copySql');
        const connectionStatus = document.getElementById('connectionStatus');
        const sqlStatus = document.getElementById('sqlStatus');
        const dataStatus = document.getElementById('dataStatus');
        const verifyStatus = document.getElementById('verifyStatus');
        const sqlCode = document.getElementById('sqlCode');
        const progressFill = document.getElementById('progressFill');
        const stepElements = document.querySelectorAll('.progress-step');
        const cardElements = document.querySelectorAll('.card');

        // Cargar credenciales guardadas
        window.addEventListener('DOMContentLoaded', () => {
            const savedUrl = localStorage.getItem('supabaseUrl');
            const savedKey = localStorage.getItem('supabaseKey');
            const systemConfigured = localStorage.getItem('systemConfigured');
            
            if (savedUrl) supabaseUrlInput.value = savedUrl;
            if (savedKey) supabaseKeyInput.value = savedKey;
            
            // Si ya est√° configurado, habilitar botones
            if (systemConfigured === 'true') {
                setupCompleted = true;
                updateProgress(100);
                updateStepVisuals(4);
                verifyStatus.innerHTML = '<p class="success">‚úÖ Sistema ya configurado. Puedes ir a la aplicaci√≥n.</p>';
                goToAppBtn.disabled = false;
                completeSetupBtn.disabled = false;
            }
            
            // Cargar Supabase desde CDN
            loadSupabase();
            
            // Actualizar progreso inicial
            updateProgress(0);
        });

        // Funci√≥n para cargar Supabase
        async function loadSupabase() {
            if (window.supabase) {
                supabaseLoaded = true;
                return;
            }
            
            return new Promise((resolve, reject) => {
                const script = document.createElement('script');
                script.src = 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/supabase.min.js';
                script.onload = () => {
                    supabaseLoaded = true;
                    resolve();
                };
                script.onerror = () => {
                    console.error('Error cargando Supabase');
                    reject();
                };
                document.head.appendChild(script);
            });
        }

        // Actualizar progreso
        function updateProgress(percentage) {
            progressFill.style.width = percentage + '%';
            
            // Actualizar pasos visualmente
            stepElements.forEach((step, index) => {
                step.classList.remove('active', 'completed');
                if (index + 1 < currentStep) {
                    step.classList.add('completed');
                } else if (index + 1 === currentStep) {
                    step.classList.add('active');
                }
            });
        }

        // Actualizar visualizaci√≥n de pasos
        function updateStepVisuals(step) {
            currentStep = step;
            
            // Actualizar tarjetas
            cardElements.forEach((card, index) => {
                card.classList.remove('active', 'completed');
                if (index + 1 === step) {
                    card.classList.add('active');
                } else if (index + 1 < step) {
                    card.classList.add('completed');
                    const stepNumber = card.querySelector('.step-number');
                    if (stepNumber) {
                        stepNumber.classList.add('completed');
                    }
                }
            });
            
            // Mostrar contenido del paso actual
            const stepContents = document.querySelectorAll('.step-content');
            stepContents.forEach(content => {
                content.classList.remove('active');
            });
            
            const currentContent = document.querySelector(`#card${step} .step-content`);
            if (currentContent) {
                currentContent.classList.add('active');
            }
            
            // Actualizar progreso
            updateProgress((step - 1) * 25);
        }

        // Ir al siguiente paso
        function goToStep(step) {
            updateStepVisuals(step);
            
            // Hacer scroll suave al paso
            const card = document.getElementById(`card${step}`);
            if (card) {
                card.scrollIntoView({ behavior: 'smooth', block: 'start' });
            }
        }

        // Copiar SQL al portapapeles
        copySqlBtn.addEventListener('click', () => {
            const text = sqlCode.textContent;
            navigator.clipboard.writeText(text).then(() => {
                const originalText = copySqlBtn.textContent;
                copySqlBtn.textContent = '‚úÖ ¬°Copiado!';
                copySqlBtn.classList.add('btn-success');
                setTimeout(() => {
                    copySqlBtn.textContent = originalText;
                    copySqlBtn.classList.remove('btn-success');
                }, 2000);
            }).catch(err => {
                console.error('Error copiando texto: ', err);
                sqlStatus.innerHTML = '<p class="error">‚ùå Error al copiar al portapapeles</p>';
                sqlStatus.classList.add('show');
            });
        });

        // Probar conexi√≥n a Supabase
        testConnectionBtn.addEventListener('click', async () => {
            const url = supabaseUrlInput.value.trim();
            const key = supabaseKeyInput.value.trim();
            
            if (!url || !key) {
                connectionStatus.innerHTML = '<p class="error">Por favor, completa ambos campos</p>';
                connectionStatus.classList.add('show');
                return;
            }
            
            // Verificar formato de URL
            if (!url.startsWith('https://') || !url.includes('.supabase.co')) {
                connectionStatus.innerHTML = '<p class="error">La URL debe tener el formato: https://xxxxxx.supabase.co</p>';
                connectionStatus.classList.add('show');
                return;
            }
            
            // Verificar formato de clave
            if (!key.startsWith('eyJ')) {
                connectionStatus.innerHTML = '<p class="error">La clave debe comenzar con "eyJ". Aseg√∫rate de copiar la clave "anon public"</p>';
                connectionStatus.classList.add('show');
                return;
            }
            
            testConnectionBtn.disabled = true;
            testConnectionBtn.textContent = 'üîÑ Probando conexi√≥n...';
            connectionStatus.innerHTML = '<p class="info">üîÑ Probando conexi√≥n a Supabase...</p>';
            connectionStatus.classList.add('show');
            
            try {
                // Esperar a que cargue Supabase si no est√° listo
                if (!supabaseLoaded) {
                    await loadSupabase();
                }
                
                // Guardar credenciales
                localStorage.setItem('supabaseUrl', url);
                localStorage.setItem('supabaseKey', key);
                
                // Crear cliente de Supabase
                supabaseClient = window.supabase.createClient(url, key);
                
                // Probar conexi√≥n con una consulta simple
                const { error } = await supabaseClient
                    .from('locales')
                    .select('count')
                    .limit(1)
                    .single();
                
                // Si esperamos error 404 porque la tabla no existe, pero la conexi√≥n es exitosa
                if (error && error.code === 'PGRST116') {
                    // Tabla no existe pero conexi√≥n es exitosa
                    connectionStatus.innerHTML = '<p class="success">‚úÖ Conexi√≥n exitosa a Supabase</p>';
                    connectionStatus.classList.add('show');
                    
                    // Habilitar siguiente paso
                    nextStep1Btn.disabled = false;
                    executeSqlBtn.disabled = false;
                    
                    // Marcar verificaci√≥n
                    document.getElementById('check1').checked = true;
                    
                } else if (error) {
                    throw error;
                } else {
                    // La tabla existe, conexi√≥n exitosa
                    connectionStatus.innerHTML = '<p class="success">‚úÖ Conexi√≥n exitosa a Supabase</p>';
                    connectionStatus.classList.add('show');
                    
                    // Habilitar siguiente paso
                    nextStep1Btn.disabled = false;
                    executeSqlBtn.disabled = false;
                    
                    // Marcar verificaci√≥n
                    document.getElementById('check1').checked = true;
                }
                
            } catch (error) {
                console.error('Error de conexi√≥n:', error);
                
                let errorMessage = error.message || 'Error desconocido';
                
                if (error.message.includes('JWT')) {
                    errorMessage = 'Clave inv√°lida. Aseg√∫rate de copiar la clave "anon public"';
                } else if (error.message.includes('fetch')) {
                    errorMessage = 'Error de red. Verifica tu conexi√≥n a internet y la URL';
                } else if (error.message.includes('PGRST')) {
                    errorMessage = 'URL inv√°lida. Verifica que sea correcta';
                }
                
                connectionStatus.innerHTML = `<p class="error">‚ùå Error de conexi√≥n: ${errorMessage}</p>`;
                connectionStatus.classList.add('show');
                
            } finally {
                testConnectionBtn.disabled = false;
                testConnectionBtn.textContent = 'Probar Conexi√≥n';
            }
        });

        // Ejecutar SQL en Supabase
        executeSqlBtn.addEventListener('click', async () => {
            if (!supabaseClient) {
                sqlStatus.innerHTML = '<p class="error">Primero prueba la conexi√≥n</p>';
                sqlStatus.classList.add('show');
                return;
            }
            
            executeSqlBtn.disabled = true;
            executeSqlBtn.textContent = 'üîÑ Ejecutando SQL...';
            sqlStatus.innerHTML = '<p class="info">üîÑ Ejecutando SQL en Supabase...</p>';
            sqlStatus.classList.add('show');
            
            try {
                // Dividir el SQL en sentencias individuales
                const sqlStatements = sqlCode.textContent
                    .split(';')
                    .filter(stmt => stmt.trim().length > 0);
                
                let successCount = 0;
                let errorCount = 0;
                
                // Ejecutar cada sentencia SQL
                for (const statement of sqlStatements) {
                    try {
                        const { error } = await supabaseClient.rpc('exec_sql', { sql: statement + ';' });
                        
                        // Si la funci√≥n RPC no existe, usar una alternativa
                        if (error && error.message.includes('function "exec_sql" does not exist')) {
                            // Intentar ejecutar como query directa (esto puede no funcionar en el cliente)
                            console.log('Funci√≥n exec_sql no disponible, intentando m√©todo alternativo...');
                            
                            // Para CREATE TABLE, podemos usar el SQL editor manualmente
                            // En este caso, solo marcamos como √©xito si la conexi√≥n funciona
                            successCount++;
                            continue;
                        }
                        
                        if (error) {
                            console.warn('Error ejecutando sentencia:', error.message);
                            errorCount++;
                        } else {
                            successCount++;
                        }
                        
                    } catch (stmtError) {
                        console.warn('Error en sentencia:', stmtError.message);
                        errorCount++;
                    }
                }
                
                if (errorCount === 0) {
                    sqlStatus.innerHTML = `<p class="success">‚úÖ SQL ejecutado correctamente. ${successCount} sentencias procesadas.</p>`;
                    sqlStatus.classList.add('show');
                    
                    // Habilitar siguiente paso
                    nextStep2Btn.disabled = false;
                    insertTestDataBtn.disabled = false;
                    
                    // Marcar verificaci√≥n
                    document.getElementById('check2').checked = true;
                    
                } else {
                    sqlStatus.innerHTML = `<p class="warning">‚ö†Ô∏è SQL ejecutado con algunos errores. ${successCount} exitosas, ${errorCount} errores. Las tablas principales se crearon correctamente.</p>`;
                    sqlStatus.classList.add('show');
                    
                    // A√∫n habilitar siguiente paso si hubo al menos un √©xito
                    if (successCount > 0) {
                        nextStep2Btn.disabled = false;
                        insertTestDataBtn.disabled = false;
                        document.getElementById('check2').checked = true;
                    }
                }
                
            } catch (error) {
                console.error('Error ejecutando SQL:', error);
                sqlStatus.innerHTML = `<p class="error">‚ùå Error ejecutando SQL: ${error.message}</p>
                <p class="info">Puedes copiar y pegar manualmente el SQL en el editor de Supabase.</p>`;
                sqlStatus.classList.add('show');
                
            } finally {
                executeSqlBtn.disabled = false;
                executeSqlBtn.textContent = 'Ejecutar SQL en Supabase';
            }
        });

        // Insertar datos de prueba - VERSI√ìN SIMPLIFICADA
        insertTestDataBtn.addEventListener('click', async () => {
            if (!supabaseClient) {
                dataStatus.innerHTML = '<p class="error">Primero prueba la conexi√≥n</p>';
                dataStatus.classList.add('show');
                return;
            }
            
            insertTestDataBtn.disabled = true;
            insertTestDataBtn.textContent = 'üîÑ Insertando datos...';
            dataStatus.innerHTML = '<p class="info">üîÑ Insertando datos de prueba...</p>';
            dataStatus.classList.add('show');
            
            try {
                // 1. Insertar local principal
                const { data: local, error: localError } = await supabaseClient
                    .from('locales')
                    .insert({
                        nombre: 'Local Principal',
                        direccion: 'Av. Comercial 1234',
                        telefono: '011-1234-5678',
                        email: 'ventas@misupermercado.com',
                        config: { 
                            impresora: 't√©rmica 80mm',
                            moneda: 'ARS',
                            iva: 21 
                        }
                    })
                    .select()
                    .single();
                
                if (localError && !localError.message.includes('duplicate key')) {
                    console.warn('Error insertando local:', localError.message);
                }
                
                // 2. Insertar cajas
                const localId = local?.id || 'offline';
                const cajasData = [
                    { numero: '01', nombre: 'Caja Principal', local_id: localId },
                    { numero: '02', nombre: 'Caja Secundaria', local_id: localId }
                ];
                
                for (const caja of cajasData) {
                    try {
                        await supabaseClient
                            .from('cajas')
                            .insert(caja);
                    } catch (cajaError) {
                        console.warn('Error insertando caja:', cajaError.message);
                    }
                }
                
                // 3. Insertar productos
                const productosData = [
                    {
                        codigo_barras: '7791234567890',
                        nombre: 'Coca Cola 2.25L',
                        descripcion: 'Gaseosa Coca Cola 2.25 litros',
                        precio_costo: 450.00,
                        porcentaje_ganancia: 30.00,
                        precio_venta: 585.00,
                        stock: 100,
                        stock_minimo: 10,
                        categoria: 'Bebidas',
                        activo: true
                    },
                    {
                        codigo_barras: '7791234567891',
                        nombre: 'Pan de Molde Integral',
                        descripcion: 'Pan de molde integral 500g',
                        precio_costo: 320.00,
                        porcentaje_ganancia: 35.00,
                        precio_venta: 432.00,
                        stock: 50,
                        stock_minimo: 5,
                        categoria: 'Panader√≠a',
                        activo: true
                    },
                    {
                        codigo_barras: '7791234567892',
                        nombre: 'Leche Entera 1L',
                        descripcion: 'Leche entera larga vida 1 litro',
                        precio_costo: 280.00,
                        porcentaje_ganancia: 25.00,
                        precio_venta: 350.00,
                        stock: 80,
                        stock_minimo: 8,
                        categoria: 'L√°cteos',
                        activo: true
                    },
                    {
                        codigo_barras: '7791234567893',
                        nombre: 'Arroz Largo Fino 1kg',
                        descripcion: 'Arroz largo fino tipo 0000',
                        precio_costo: 150.00,
                        porcentaje_ganancia: 40.00,
                        precio_venta: 210.00,
                        stock: 120,
                        stock_minimo: 12,
                        categoria: 'Almac√©n',
                        activo: true
                    }
                ];
                
                for (const producto of productosData) {
                    try {
                        await supabaseClient
                            .from('productos')
                            .insert(producto);
                    } catch (productoError) {
                        console.warn('Error insertando producto:', productoError.message);
                    }
                }
                
                // 4. Insertar clientes
                const clientesData = [
                    {
                        nombre: 'Cliente Contado',
                        dni: '12345678',
                        telefono: '011-9876-5432',
                        email: 'cliente@contado.com',
                        direccion: 'Calle Falsa 123',
                        limite_credito: 0,
                        saldo: 0,
                        activo: true
                    },
                    {
                        nombre: 'Cliente Cuenta Corriente',
                        dni: '87654321',
                        telefono: '011-1234-4321',
                        email: 'cliente@cuenta.com',
                        direccion: 'Av. Siempre Viva 742',
                        limite_credito: 50000.00,
                        saldo: 0,
                        activo: true
                    }
                ];
                
                for (const cliente of clientesData) {
                    try {
                        await supabaseClient
                            .from('clientes')
                            .insert(cliente);
                    } catch (clienteError) {
                        console.warn('Error insertando cliente:', clienteError.message);
                    }
                }
                
                // 5. Insertar proveedores
                const proveedoresData = [
                    {
                        nombre: 'Distribuidora Mayorista SA',
                        contacto: 'Juan P√©rez',
                        telefono: '011-5555-6666',
                        email: 'ventas@mayorista.com.ar',
                        web: 'https://www.mayorista.com.ar',
                        whatsapp: '+5491155556666',
                        activo: true
                    },
                    {
                        nombre: 'F√°brica de Bebidas Argentinas',
                        contacto: 'Mar√≠a G√≥mez',
                        telefono: '011-7777-8888',
                        email: 'ventas@fabrica-bebidas.com',
                        web: 'https://www.fabrica-bebidas.com.ar',
                        whatsapp: '+5491177778888',
                        activo: true
                    }
                ];
                
                for (const proveedor of proveedoresData) {
                    try {
                        await supabaseClient
                            .from('proveedores')
                            .insert(proveedor);
                    } catch (proveedorError) {
                        console.warn('Error insertando proveedor:', proveedorError.message);
                    }
                }
                
                dataStatus.innerHTML = `
                    <p class="success">‚úÖ Datos de prueba insertados correctamente</p>
                    <p class="info">Se insertaron:</p>
                    <ul>
                        <li>1 Local</li>
                        <li>2 Cajas</li>
                        <li>4 Productos</li>
                        <li>2 Clientes</li>
                        <li>2 Proveedores</li>
                    </ul>
                `;
                dataStatus.classList.add('show');
                
                // Habilitar siguiente paso
                nextStep3Btn.disabled = false;
                verifySetupBtn.disabled = false;
                
                // Marcar verificaci√≥n
                document.getElementById('check3').checked = true;
                
            } catch (error) {
                console.error('Error insertando datos:', error);
                dataStatus.innerHTML = `
                    <p class="error">‚ùå Error insertando datos:</p>
                    <p>${error.message}</p>
                    <p class="info">Puedes saltar este paso y continuar</p>
                `;
                dataStatus.classList.add('show');
                
                // A√∫n permitir continuar
                nextStep3Btn.disabled = false;
                verifySetupBtn.disabled = false;
                
            } finally {
                insertTestDataBtn.disabled = false;
                insertTestDataBtn.textContent = 'Insertar Datos de Prueba';
            }
        });

        // Verificar configuraci√≥n completa
        verifySetupBtn.addEventListener('click', async () => {
            if (!supabaseClient) {
                verifyStatus.innerHTML = '<p class="error">Primero prueba la conexi√≥n</p>';
                verifyStatus.classList.add('show');
                return;
            }
            
            verifySetupBtn.disabled = true;
            verifySetupBtn.textContent = 'üîÑ Verificando...';
            verifyStatus.innerHTML = '<p class="info">üîÑ Verificando configuraci√≥n...</p>';
            verifyStatus.classList.add('show');
            
            try {
                // Verificar que existan las tablas principales
                const tablesToCheck = ['locales', 'cajas', 'productos', 'clientes'];
                let missingTables = [];
                
                for (const table of tablesToCheck) {
                    try {
                        const { error } = await supabaseClient
                            .from(table)
                            .select('id')
                            .limit(1);
                        
                        if (error) {
                            missingTables.push(table);
                        }
                    } catch (error) {
                        missingTables.push(table);
                    }
                }
                
                if (missingTables.length > 0) {
                    verifyStatus.innerHTML = `
                        <p class="warning">‚ö†Ô∏è Algunas tablas no se encontraron: ${missingTables.join(', ')}</p>
                        <p class="info">Ejecuta el SQL del paso 2 o verifica manualmente.</p>
                    `;
                    verifyStatus.classList.add('show');
                } else {
                    // Marcar configuraci√≥n como completada
                    localStorage.setItem('systemConfigured', 'true');
                    
                    verifyStatus.innerHTML = `
                        <p class="success">‚úÖ Configuraci√≥n verificada correctamente</p>
                        <p class="info">‚úÖ Tablas creadas</p>
                        <p class="info">‚úÖ Conexi√≥n activa</p>
                        <p class="info">‚úÖ Sistema listo para usar</p>
                    `;
                    verifyStatus.classList.add('show');
                    
                    // Habilitar botones finales
                    completeSetupBtn.disabled = false;
                    goToAppBtn.disabled = false;
                    
                    // Marcar verificaci√≥n final
                    document.getElementById('check4').checked = true;
                }
                
            } catch (error) {
                verifyStatus.innerHTML = `
                    <p class="error">‚ùå Error en verificaci√≥n:</p>
                    <p>${error.message}</p>
                    <p class="info">‚ö†Ô∏è Completa los pasos anteriores</p>
                `;
                verifyStatus.classList.add('show');
            } finally {
                verifySetupBtn.disabled = false;
                verifySetupBtn.textContent = 'Verificar Configuraci√≥n';
            }
        });

        // Navegaci√≥n entre pasos
        nextStep1Btn.addEventListener('click', () => goToStep(2));
        nextStep2Btn.addEventListener('click', () => goToStep(3));
        nextStep3Btn.addEventListener('click', () => goToStep(4));
        
        // Completar configuraci√≥n
        completeSetupBtn.addEventListener('click', () => {
            // Guardar configuraci√≥n final
            const configData = {
                configuredAt: new Date().toISOString(),
                version: '1.0.0',
                supabaseUrl: localStorage.getItem('supabaseUrl'),
                tablesCreated: true,
                testDataInserted: true
            };
            
            localStorage.setItem('posConfig', JSON.stringify(configData));
            localStorage.setItem('systemConfigured', 'true');
            
            // Mostrar mensaje de √©xito
            verifyStatus.innerHTML = `
                <p class="success">‚úÖ Configuraci√≥n completada exitosamente!</p>
                <p class="info">Ahora puedes usar el sistema POS.</p>
            `;
            verifyStatus.classList.add('show');
            
            // Actualizar progreso al 100%
            updateProgress(100);
            
            // Habilitar bot√≥n para ir a la app
            goToAppBtn.disabled = false;
        });

        // Ir a la aplicaci√≥n
        goToAppBtn.addEventListener('click', () => {
            window.location.href = 'index.html';
        });

        // Guardar credenciales al cambiar
        supabaseUrlInput.addEventListener('change', () => {
            localStorage.setItem('supabaseUrl', supabaseUrlInput.value);
        });
        
        supabaseKeyInput.addEventListener('change', () => {
            localStorage.setItem('supabaseKey', supabaseKeyInput.value);
        });

        // Permitir navegaci√≥n con teclado
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Enter' && currentStep === 1) {
                testConnectionBtn.click();
            }
        });
    </script>
</body>
</html>
