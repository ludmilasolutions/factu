<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema de Facturaci√≥n POS</title>
    <!-- PWA Config -->
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#4f46e5">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    
    <!-- Iconos -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- HTML2PDF para impresi√≥n -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    
    <!-- SheetJS para Excel -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    
    <!-- QuaggaJS para escaneo de c√≥digos de barras -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/quagga/0.12.1/quagga.min.js"></script>
    
    <!-- ChartJS para reportes -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <!-- Favicon -->
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>üè™</text></svg>">
    
    <style>
        /* ESTILOS PRINCIPALES - Sistema completo */
        :root {
            --primary: #4f46e5;
            --primary-dark: #4338ca;
            --secondary: #10b981;
            --danger: #ef4444;
            --warning: #f59e0b;
            --dark: #1f2937;
            --light: #f8fafc;
            --gray: #6b7280;
            --border: #e5e7eb;
            --shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
            --radius: 12px;
        }
        
        * { box-sizing: border-box; margin: 0; padding: 0; font-family: 'Segoe UI', system-ui, sans-serif; }
        
        body { background: #f1f5f9; color: var(--dark); overflow-x: hidden; }
        
        /* Layout Principal */
        .app-container { display: flex; min-height: 100vh; }
        
        /* Sidebar */
        .sidebar { width: 280px; background: white; box-shadow: var(--shadow); transition: transform 0.3s; z-index: 1000; }
        .sidebar-header { padding: 20px; border-bottom: 1px solid var(--border); background: linear-gradient(90deg, var(--primary), var(--primary-dark)); color: white; }
        .sidebar-menu { padding: 20px 0; }
        .menu-item { display: flex; align-items: center; padding: 14px 24px; color: var(--dark); text-decoration: none; transition: all 0.3s; border-left: 4px solid transparent; }
        .menu-item:hover { background: #f3f4f6; color: var(--primary); }
        .menu-item.active { background: #eef2ff; color: var(--primary); border-left-color: var(--primary); font-weight: 600; }
        .menu-item i { width: 24px; margin-right: 12px; font-size: 18px; }
        .menu-badge { margin-left: auto; background: var(--primary); color: white; padding: 2px 8px; border-radius: 10px; font-size: 12px; }
        
        /* Contenido Principal */
        .main-content { flex: 1; display: flex; flex-direction: column; }
        .top-nav { background: white; padding: 16px 24px; border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center; box-shadow: 0 2px 4px rgba(0,0,0,0.05); }
        .user-info { display: flex; align-items: center; gap: 12px; }
        .user-avatar { width: 40px; height: 40px; border-radius: 50%; background: var(--primary); color: white; display: flex; align-items: center; justify-content: center; font-weight: bold; }
        .system-status { display: flex; align-items: center; gap: 20px; }
        .status-item { display: flex; align-items: center; gap: 8px; font-size: 14px; }
        .status-online { color: var(--secondary); }
        .status-offline { color: var(--danger); }
        
        /* POS Principal */
        .pos-container { display: flex; flex: 1; padding: 20px; gap: 20px; }
        .pos-left { flex: 3; display: flex; flex-direction: column; gap: 20px; }
        .pos-right { flex: 2; display: flex; flex-direction: column; gap: 20px; }
        
        /* Tarjetas */
        .card { background: white; border-radius: var(--radius); box-shadow: var(--shadow); overflow: hidden; }
        .card-header { padding: 18px 24px; border-bottom: 1px solid var(--border); background: #f8fafc; display: flex; justify-content: space-between; align-items: center; }
        .card-title { font-size: 18px; font-weight: 600; color: var(--dark); }
        .card-body { padding: 24px; }
        
        /* Productos Grid */
        .productos-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 16px; max-height: 400px; overflow-y: auto; padding: 10px; }
        .producto-card { border: 1px solid var(--border); border-radius: 10px; padding: 16px; cursor: pointer; transition: all 0.2s; position: relative; }
        .producto-card:hover { transform: translateY(-2px); box-shadow: 0 10px 25px rgba(0,0,0,0.1); border-color: var(--primary); }
        .producto-codigo { font-size: 12px; color: var(--gray); margin-bottom: 4px; }
        .producto-nombre { font-weight: 600; margin-bottom: 8px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
        .producto-precio { color: var(--primary); font-weight: bold; font-size: 18px; }
        .producto-stock { position: absolute; top: 12px; right: 12px; font-size: 11px; padding: 2px 8px; border-radius: 10px; }
        .stock-bajo { background: #fef2f2; color: var(--danger); }
        .stock-normal { background: #f0f9ff; color: #0ea5e9; }
        
        /* Carrito de Ventas */
        .carrito-items { max-height: 300px; overflow-y: auto; }
        .carrito-item { display: flex; align-items: center; padding: 12px; border-bottom: 1px solid var(--border); }
        .carrito-item-info { flex: 1; }
        .carrito-item-nombre { font-weight: 600; }
        .carrito-item-precio { color: var(--gray); font-size: 14px; }
        .carrito-item-cantidad { display: flex; align-items: center; gap: 8px; margin: 0 16px; }
        .cantidad-btn { width: 28px; height: 28px; border-radius: 50%; background: #f3f4f6; border: none; display: flex; align-items: center; justify-content: center; cursor: pointer; }
        .carrito-totales { padding: 20px; border-top: 1px solid var(--border); }
        .total-line { display: flex; justify-content: space-between; margin-bottom: 12px; }
        .total-final { font-size: 24px; font-weight: bold; color: var(--primary); border-top: 2px solid var(--border); padding-top: 16px; margin-top: 16px; }
        
        /* Botones */
        .btn { padding: 12px 24px; border-radius: 10px; border: none; font-weight: 600; cursor: pointer; transition: all 0.3s; display: inline-flex; align-items: center; justify-content: center; gap: 8px; }
        .btn-primary { background: linear-gradient(90deg, var(--primary), var(--primary-dark)); color: white; }
        .btn-primary:hover { transform: translateY(-2px); box-shadow: 0 10px 25px rgba(79, 70, 229, 0.4); }
        .btn-success { background: linear-gradient(90deg, var(--secondary), #059669); color: white; }
        .btn-danger { background: linear-gradient(90deg, var(--danger), #dc2626); color: white; }
        .btn-outline { background: transparent; border: 2px solid var(--primary); color: var(--primary); }
        .btn-warning { background: linear-gradient(90deg, var(--warning), #d97706); color: white; }
        .btn-sm { padding: 6px 12px; font-size: 14px; }
        
        /* Modal */
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 2000; align-items: center; justify-content: center; }
        .modal-content { background: white; border-radius: var(--radius); max-width: 800px; width: 90%; max-height: 90vh; overflow-y: auto; }
        .modal-header { padding: 20px 24px; border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center; }
        .modal-body { padding: 24px; }
        .modal-close { background: none; border: none; font-size: 24px; cursor: pointer; color: var(--gray); }
        
        /* Formularios */
        .form-control {
            width: 100%;
            padding: 10px 14px;
            border: 2px solid var(--border);
            border-radius: 8px;
            font-size: 16px;
            transition: border-color 0.3s;
            margin-bottom: 16px;
        }
        
        .form-control:focus {
            outline: none;
            border-color: var(--primary);
        }
        
        .form-group {
            margin-bottom: 20px;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: var(--dark);
        }
        
        /* Tabs */
        .tabs { display: flex; border-bottom: 2px solid var(--border); margin-bottom: 20px; }
        .tab { padding: 12px 24px; cursor: pointer; border-bottom: 2px solid transparent; margin-bottom: -2px; }
        .tab.active { border-bottom-color: var(--primary); color: var(--primary); font-weight: 600; }
        
        /* Responsive */
        @media (max-width: 1200px) {
            .pos-container { flex-direction: column; }
            .sidebar { transform: translateX(-100%); position: fixed; height: 100vh; }
            .sidebar.active { transform: translateX(0); }
            .menu-toggle { display: block !important; }
        }
        
        @media (max-width: 768px) {
            .productos-grid { grid-template-columns: repeat(auto-fill, minmax(150px, 1fr)); }
            .top-nav { flex-direction: column; gap: 16px; align-items: flex-start; }
            .system-status { flex-wrap: wrap; }
            .modal-content { width: 95%; }
        }
        
        /* PWA optimizaciones */
        @media (display-mode: standalone) {
            .top-nav { padding-top: 40px; }
        }
        
        /* Estilos espec√≠ficos para vistas */
        .view { display: none; }
        .view.active { display: block; }
        
        /* Tablas */
        .table-container { overflow-x: auto; margin-bottom: 20px; }
        .data-table { width: 100%; border-collapse: collapse; }
        .data-table th { background: #f8fafc; padding: 16px; text-align: left; font-weight: 600; color: var(--dark); border-bottom: 2px solid var(--border); }
        .data-table td { padding: 14px 16px; border-bottom: 1px solid var(--border); }
        .data-table tr:hover { background: #f9fafb; }
        
        /* B√∫squeda */
        .search-box { position: relative; }
        .search-input { width: 100%; padding: 12px 16px 12px 44px; border: 2px solid var(--border); border-radius: 10px; font-size: 16px; }
        .search-icon { position: absolute; left: 16px; top: 50%; transform: translateY(-50%); color: var(--gray); }
        
        /* C√≥digo de barras */
        .barcode-scanner { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: black; z-index: 3000; display: none; }
        .barcode-video { width: 100%; height: 100%; object-fit: cover; }
        .barcode-overlay { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); width: 300px; height: 200px; border: 4px solid white; }
        
        /* Turno y Caja */
        .turno-indicator { background: linear-gradient(90deg, #fbbf24, #f59e0b); color: white; padding: 8px 16px; border-radius: 20px; font-size: 14px; font-weight: 600; }
        
        /* Impresi√≥n */
        @media print {
            .no-print { display: none !important; }
            .ticket { width: 80mm !important; padding: 0 !important; margin: 0 !important; }
        }
        
        .ticket { width: 80mm; background: white; padding: 20px; font-family: monospace; }
        .ticket-header { text-align: center; margin-bottom: 16px; }
        .ticket-empresa { font-weight: bold; font-size: 18px; }
        .ticket-items { width: 100%; margin: 16px 0; }
        .ticket-item { display: flex; justify-content: space-between; margin-bottom: 8px; }
        .ticket-total { border-top: 2px dashed black; padding-top: 16px; margin-top: 16px; text-align: right; font-weight: bold; }
        .ticket-footer { text-align: center; font-size: 12px; margin-top: 20px; color: var(--gray); }
        
        /* Modo Emergencia */
        .emergency-mode { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #fef3c7; z-index: 4000; display: none; flex-direction: column; align-items: center; justify-content: center; }
        .emergency-icon { font-size: 64px; color: #f59e0b; margin-bottom: 24px; }
        .emergency-actions { display: flex; gap: 16px; margin-top: 32px; }
        
        /* Reportes */
        .charts-container { display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px; margin-top: 20px; }
        .chart-card { padding: 20px; }
        
        /* Animaciones */
        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.5; }
            100% { opacity: 1; }
        }
        
        .pulse { animation: pulse 1.5s infinite; }
        
        /* Scrollbar personalizado */
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #f1f1f1; }
        ::-webkit-scrollbar-thumb { background: #c1c1c1; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #a1a1a1; }
        
        /* Badges */
        .badge { display: inline-block; padding: 4px 8px; border-radius: 4px; font-size: 12px; font-weight: 600; }
        .badge-success { background: #d1fae5; color: #065f46; }
        .badge-danger { background: #fee2e2; color: #991b1b; }
        .badge-warning { background: #fef3c7; color: #92400e; }
        .badge-info { background: #dbeafe; color: #1e40af; }
        
        /* Paginaci√≥n */
        .pagination { display: flex; gap: 8px; margin-top: 20px; }
        .page-item { padding: 8px 12px; border: 1px solid var(--border); border-radius: 6px; cursor: pointer; }
        .page-item.active { background: var(--primary); color: white; border-color: var(--primary); }
        
        /* Alertas */
        .alert { padding: 16px; border-radius: 8px; margin-bottom: 16px; }
        .alert-success { background: #d1fae5; color: #065f46; border: 1px solid #a7f3d0; }
        .alert-warning { background: #fef3c7; color: #92400e; border: 1px solid #fde68a; }
        .alert-danger { background: #fee2e2; color: #991b1b; border: 1px solid #fecaca; }
        
        /* Filtros */
        .filters { display: flex; gap: 12px; margin-bottom: 20px; flex-wrap: wrap; }
        .filter-group { display: flex; flex-direction: column; }
        
        /* Loader */
        .loader { border: 4px solid #f3f3f3; border-top: 4px solid var(--primary); border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; margin: 20px auto; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body>
    <!-- Contenedor Principal -->
    <div class="app-container">
        <!-- Sidebar -->
        <div class="sidebar" id="sidebar">
            <div class="sidebar-header">
                <h2 id="empresaNombre">üè™ Mi Comercio</h2>
                <small id="sucursalNombre">Cargando...</small>
            </div>
            
            <div class="sidebar-menu">
                <a href="#" class="menu-item active" data-view="pos">
                    <i class="fas fa-cash-register"></i> POS / Facturaci√≥n
                </a>
                
                <a href="#" class="menu-item" data-view="productos">
                    <i class="fas fa-boxes"></i> Productos
                    <span class="menu-badge" id="productosCount">0</span>
                </a>
                
                <a href="#" class="menu-item" data-view="clientes">
                    <i class="fas fa-users"></i> Clientes
                    <span class="menu-badge" id="clientesCount">0</span>
                </a>
                
                <a href="#" class="menu-item" data-view="ventas">
                    <i class="fas fa-chart-line"></i> Ventas
                </a>
                
                <a href="#" class="menu-item" data-view="caja">
                    <i class="fas fa-cash-register"></i> Caja y Turnos
                </a>
                
                <a href="#" class="menu-item" data-view="reportes">
                    <i class="fas fa-chart-bar"></i> Reportes
                </a>
                
                <a href="#" class="menu-item" data-view="proveedores">
                    <i class="fas fa-truck"></i> Proveedores
                </a>
                
                <a href="#" class="menu-item" data-view="configuracion">
                    <i class="fas fa-cog"></i> Configuraci√≥n
                </a>
                
                <div style="margin-top: 40px; padding: 0 24px;">
                    <button class="btn btn-outline" style="width: 100%; margin-bottom: 10px;" onclick="exportarBackup()">
                        <i class="fas fa-download"></i> Exportar Backup
                    </button>
                    <button class="btn btn-outline" style="width: 100%;" onclick="importarBackup()">
                        <i class="fas fa-upload"></i> Importar Backup
                    </button>
                </div>
            </div>
        </div>
        
        <!-- Contenido Principal -->
        <div class="main-content">
            <!-- Top Navigation -->
            <div class="top-nav no-print">
                <div style="display: flex; align-items: center; gap: 16px;">
                    <button class="menu-toggle" id="menuToggle" style="background: none; border: none; font-size: 20px; cursor: pointer; display: none;">
                        <i class="fas fa-bars"></i>
                    </button>
                    
                    <div class="turno-indicator" id="turnoIndicator">
                        <i class="fas fa-user-clock"></i> <span id="turnoActual">Sin turno activo</span>
                    </div>
                    
                    <div class="system-status">
                        <div class="status-item">
                            <i class="fas fa-wifi" id="connectionStatusIcon"></i>
                            <span id="connectionStatus">Conectado</span>
                        </div>
                        <div class="status-item">
                            <i class="fas fa-database"></i>
                            <span id="syncStatus">Sincronizado</span>
                        </div>
                        <div class="status-item">
                            <i class="fas fa-store"></i>
                            <span id="localStatus">Local: <span id="localCount">0</span></span>
                        </div>
                    </div>
                </div>
                
                <div class="user-info">
                    <div>
                        <div id="userName">Cargando...</div>
                        <small id="userRole" style="color: var(--gray);">Cargando rol...</small>
                    </div>
                    <div class="user-avatar" id="userAvatar">U</div>
                    <button class="btn btn-outline" onclick="logout()">
                        <i class="fas fa-sign-out-alt"></i> Salir
                    </button>
                </div>
            </div>
            
            <!-- Vistas Din√°micas -->
            <div id="viewContainer">
                <!-- Vista POS (Principal) -->
                <div class="view active" id="posView">
                    <div class="pos-container">
                        <!-- Columna Izquierda: Productos -->
                        <div class="pos-left">
                            <!-- B√∫squeda y Filtros -->
                            <div class="card">
                                <div class="card-header">
                                    <div class="card-title">
                                        <i class="fas fa-search"></i> B√∫squeda de Productos
                                    </div>
                                    <div style="display: flex; gap: 10px;">
                                        <button class="btn btn-outline" onclick="abrirScanner()">
                                            <i class="fas fa-barcode"></i> Escanear
                                        </button>
                                        <button class="btn btn-outline" onclick="mostrarModal('modalProductos')">
                                            <i class="fas fa-list"></i> Todos
                                        </button>
                                    </div>
                                </div>
                                <div class="card-body">
                                    <div class="search-box">
                                        <i class="fas fa-search search-icon"></i>
                                        <input type="text" class="search-input" id="buscarProducto" 
                                               placeholder="C√≥digo, nombre o categor√≠a..." 
                                               onkeyup="buscarProductos()">
                                    </div>
                                    
                                    <div class="productos-grid" id="productosGrid">
                                        <!-- Productos cargados din√°micamente -->
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Carrito de Ventas -->
                            <div class="card">
                                <div class="card-header">
                                    <div class="card-title">
                                        <i class="fas fa-shopping-cart"></i> Carrito de Venta
                                        <span id="carritoCount">(0 items)</span>
                                    </div>
                                    <div style="display: flex; gap: 10px;">
                                        <button class="btn btn-outline" onclick="aplicarDescuentoGlobal()">
                                            <i class="fas fa-percentage"></i> Descuento
                                        </button>
                                        <button class="btn btn-danger" onclick="vaciarCarrito()">
                                            <i class="fas fa-trash"></i> Vaciar
                                        </button>
                                    </div>
                                </div>
                                <div class="card-body">
                                    <div class="carrito-items" id="carritoItems">
                                        <!-- Items del carrito -->
                                    </div>
                                    
                                    <div class="carrito-totales">
                                        <div class="total-line">
                                            <span>Subtotal:</span>
                                            <span id="subtotal">$0.00</span>
                                        </div>
                                        <div class="total-line">
                                            <span>Descuento Global:</span>
                                            <input type="number" id="descuentoGlobal" value="0" min="0" max="100" 
                                                   style="width: 60px; text-align: center; border: 1px solid #ddd; border-radius: 4px;"
                                                   onchange="aplicarDescuentoGlobal()"> %
                                        </div>
                                        <div class="total-line">
                                            <span>Descuento Total:</span>
                                            <span id="descuentoTotal">$0.00</span>
                                        </div>
                                        <div class="total-line">
                                            <span>IVA (21%):</span>
                                            <span id="iva">$0.00</span>
                                        </div>
                                        <div class="total-line total-final">
                                            <span>TOTAL:</span>
                                            <span id="total">$0.00</span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Columna Derecha: Cliente y Pago -->
                        <div class="pos-right">
                            <!-- Datos del Cliente -->
                            <div class="card">
                                <div class="card-header">
                                    <div class="card-title">
                                        <i class="fas fa-user"></i> Cliente
                                    </div>
                                    <button class="btn btn-outline" onclick="mostrarModal('modalClientes')">
                                        <i class="fas fa-plus"></i> Nuevo
                                    </button>
                                </div>
                                <div class="card-body">
                                    <div class="form-group">
                                        <label>Seleccionar Cliente</label>
                                        <select class="form-control" id="selectCliente" onchange="actualizarCliente()">
                                            <option value="">Cliente General (Consumidor Final)</option>
                                            <!-- Clientes cargados din√°micamente -->
                                        </select>
                                    </div>
                                    
                                    <div id="clienteInfo" style="display: none; margin-top: 16px; padding: 16px; background: #f8fafc; border-radius: 8px;">
                                        <div style="display: flex; justify-content: space-between;">
                                            <div>
                                                <strong id="clienteNombre"></strong>
                                                <div id="clienteDocumento" style="font-size: 14px; color: var(--gray);"></div>
                                            </div>
                                            <div style="text-align: right;">
                                                <div>Saldo Actual:</div>
                                                <strong id="clienteSaldo" style="color: var(--primary);"></strong>
                                            </div>
                                        </div>
                                        <div style="margin-top: 8px; font-size: 14px;">
                                            <span id="clienteLimiteCredito"></span>
                                        </div>
                                    </div>
                                    
                                    <div class="form-group" style="margin-top: 16px;">
                                        <label>Nota Interna (opcional)</label>
                                        <textarea id="notaVenta" rows="2" placeholder="Nota para esta venta..." class="form-control"></textarea>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- M√©todos de Pago -->
                            <div class="card">
                                <div class="card-header">
                                    <div class="card-title">
                                        <i class="fas fa-credit-card"></i> M√©todos de Pago
                                    </div>
                                </div>
                                <div class="card-body">
                                    <div class="form-group">
                                        <label>Forma de Pago</label>
                                        <select class="form-control" id="selectPago" onchange="actualizarPago()">
                                            <option value="efectivo">Efectivo</option>
                                            <option value="tarjeta">Tarjeta D√©bito/Cr√©dito</option>
                                            <option value="transferencia">Transferencia Bancaria</option>
                                            <option value="qr">QR / Mercado Pago</option>
                                            <option value="mixto">Pago Mixto</option>
                                            <option value="cuenta_corriente">Cuenta Corriente</option>
                                        </select>
                                    </div>
                                    
                                    <div id="pagoEfectivo" class="metodo-pago">
                                        <div class="form-group">
                                            <label>Monto Recibido</label>
                                            <input type="number" id="montoRecibido" class="form-control" 
                                                   placeholder="0.00" oninput="calcularCambio()">
                                        </div>
                                        <div class="form-group">
                                            <label>Cambio</label>
                                            <input type="number" id="cambio" class="form-control" 
                                                   placeholder="0.00" readonly style="background: #f8fafc;">
                                        </div>
                                    </div>
                                    
                                    <div id="pagoTarjeta" class="metodo-pago" style="display: none;">
                                        <div class="form-group">
                                            <label>√öltimos 4 d√≠gitos</label>
                                            <input type="text" id="tarjetaNumero" class="form-control" placeholder="1234" maxlength="4">
                                        </div>
                                        <div class="form-group">
                                            <label>Tipo</label>
                                            <select id="tarjetaTipo" class="form-control">
                                                <option value="debito">D√©bito</option>
                                                <option value="credito">Cr√©dito</option>
                                            </select>
                                        </div>
                                        <div class="form-group">
                                            <label>Cuotas</label>
                                            <select id="tarjetaCuotas" class="form-control">
                                                <option value="1">1 cuota</option>
                                                <option value="3">3 cuotas</option>
                                                <option value="6">6 cuotas</option>
                                                <option value="12">12 cuotas</option>
                                            </select>
                                        </div>
                                    </div>
                                    
                                    <div id="pagoTransferencia" class="metodo-pago" style="display: none;">
                                        <div class="form-group">
                                            <label>N√∫mero de Comprobante</label>
                                            <input type="text" id="transferenciaComprobante" class="form-control" placeholder="ABC123456">
                                        </div>
                                        <div class="form-group">
                                            <label>Banco</label>
                                            <input type="text" id="transferenciaBanco" class="form-control" placeholder="Nombre del banco">
                                        </div>
                                    </div>
                                    
                                    <div id="pagoQR" class="metodo-pago" style="display: none;">
                                        <div class="form-group">
                                            <label>Plataforma</label>
                                            <select id="qrPlataforma" class="form-control">
                                                <option value="mercadopago">Mercado Pago</option>
                                                <option value="mpago">MODO</option>
                                                <option value="otra">Otra</option>
                                            </select>
                                        </div>
                                        <div class="form-group">
                                            <label>ID Transacci√≥n</label>
                                            <input type="text" id="qrTransaccion" class="form-control" placeholder="ID de transacci√≥n">
                                        </div>
                                    </div>
                                    
                                    <div id="pagoMixto" class="metodo-pago" style="display: none;">
                                        <div class="form-group">
                                            <label>Efectivo</label>
                                            <input type="number" id="mixtoEfectivo" class="form-control" placeholder="0.00" oninput="calcularMixto()">
                                        </div>
                                        <div class="form-group">
                                            <label>Tarjeta</label>
                                            <input type="number" id="mixtoTarjeta" class="form-control" placeholder="0.00" oninput="calcularMixto()">
                                        </div>
                                        <div class="form-group">
                                            <label>Transferencia</label>
                                            <input type="number" id="mixtoTransferencia" class="form-control" placeholder="0.00" oninput="calcularMixto()">
                                        </div>
                                        <div class="form-group">
                                            <label>QR</label>
                                            <input type="number" id="mixtoQR" class="form-control" placeholder="0.00" oninput="calcularMixto()">
                                        </div>
                                        <div class="form-group">
                                            <label>Total Mixto</label>
                                            <input type="number" id="totalMixto" class="form-control" placeholder="0.00" readonly style="background: #f8fafc;">
                                        </div>
                                    </div>
                                    
                                    <div id="pagoCuentaCorriente" class="metodo-pago" style="display: none;">
                                        <div class="alert alert-warning">
                                            <i class="fas fa-exclamation-triangle"></i>
                                            Se registrar√° como deuda en la cuenta corriente del cliente.
                                        </div>
                                        <div class="form-group">
                                            <label>L√≠mite de Cr√©dito Disponible</label>
                                            <input type="number" id="limiteDisponible" class="form-control" readonly style="background: #f8fafc;">
                                        </div>
                                    </div>
                                    
                                    <div style="margin-top: 24px;">
                                        <button class="btn btn-success" style="width: 100%; padding: 16px; font-size: 18px;" onclick="procesarVenta()">
                                            <i class="fas fa-check-circle"></i> FINALIZAR VENTA
                                        </button>
                                    </div>
                                    
                                    <div style="margin-top: 16px; display: flex; gap: 10px;">
                                        <button class="btn btn-outline" style="flex: 1;" onclick="crearPresupuesto()">
                                            <i class="fas fa-file-invoice-dollar"></i> Presupuesto
                                        </button>
                                        <button class="btn btn-outline" style="flex: 1;" onclick="reimprimirUltimo()">
                                            <i class="fas fa-print"></i> Reimprimir
                                        </button>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Acciones R√°pidas -->
                            <div class="card">
                                <div class="card-header">
                                    <div class="card-title">
                                        <i class="fas fa-bolt"></i> Acciones R√°pidas
                                    </div>
                                </div>
                                <div class="card-body">
                                    <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 12px;">
                                        <button class="btn btn-outline" onclick="mostrarModal('modalAnulacion')">
                                            <i class="fas fa-ban"></i> Anular
                                        </button>
                                        <button class="btn btn-outline" onclick="congelarPrecios()">
                                            <i class="fas fa-snowflake"></i> Congelar
                                        </button>
                                        <button class="btn btn-outline" onclick="mostrarModal('modalNotas')">
                                            <i class="fas fa-sticky-note"></i> Notas
                                        </button>
                                        <button class="btn btn-outline" onclick="exportarVentaPDF()">
                                            <i class="fas fa-file-pdf"></i> PDF
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Vista Productos -->
                <div class="view" id="productosView">
                    <div style="padding: 20px;">
                        <div class="card">
                            <div class="card-header">
                                <h2><i class="fas fa-boxes"></i> Gesti√≥n de Productos</h2>
                                <div style="display: flex; gap: 10px;">
                                    <button class="btn btn-primary" onclick="mostrarModal('modalNuevoProducto')">
                                        <i class="fas fa-plus"></i> Nuevo Producto
                                    </button>
                                    <button class="btn btn-outline" onclick="mostrarModal('modalImportarProductos')">
                                        <i class="fas fa-file-import"></i> Importar Excel
                                    </button>
                                    <button class="btn btn-outline" onclick="exportarProductosExcel()">
                                        <i class="fas fa-file-export"></i> Exportar Excel
                                    </button>
                                    <button class="btn btn-warning" onclick="mostrarModal('modalCambioMasivoPrecios')">
                                        <i class="fas fa-money-bill-wave"></i> Cambio Masivo
                                    </button>
                                </div>
                            </div>
                            <div class="card-body">
                                <div class="filters">
                                    <div class="filter-group">
                                        <label>B√∫squeda</label>
                                        <input type="text" id="buscarProductosGestion" class="form-control" placeholder="Nombre, c√≥digo..." 
                                               onkeyup="filtrarProductosGestion()" style="width: 300px;">
                                    </div>
                                    <div class="filter-group">
                                        <label>Categor√≠a</label>
                                        <select id="filtroCategoria" class="form-control" onchange="filtrarProductosGestion()">
                                            <option value="">Todas las categor√≠as</option>
                                            <!-- Cargado din√°micamente -->
                                        </select>
                                    </div>
                                    <div class="filter-group">
                                        <label>Proveedor</label>
                                        <select id="filtroProveedor" class="form-control" onchange="filtrarProductosGestion()">
                                            <option value="">Todos los proveedores</option>
                                            <!-- Cargado din√°micamente -->
                                        </select>
                                    </div>
                                    <div class="filter-group">
                                        <label>Stock</label>
                                        <select id="filtroStock" class="form-control" onchange="filtrarProductosGestion()">
                                            <option value="">Todos</option>
                                            <option value="bajo">Stock Bajo</option>
                                            <option value="sin">Sin Stock</option>
                                            <option value="con">Con Stock</option>
                                        </select>
                                    </div>
                                </div>
                                
                                <div class="table-container">
                                    <table class="data-table">
                                        <thead>
                                            <tr>
                                                <th>C√≥digo</th>
                                                <th>Producto</th>
                                                <th>Categor√≠a</th>
                                                <th>Precio Costo</th>
                                                <th>Precio Venta</th>
                                                <th>Stock</th>
                                                <th>Proveedor</th>
                                                <th>Estado</th>
                                                <th>Acciones</th>
                                            </tr>
                                        </thead>
                                        <tbody id="tablaProductosGestion">
                                            <!-- Productos cargados din√°micamente -->
                                        </tbody>
                                    </table>
                                </div>
                                
                                <div class="pagination" id="paginacionProductos">
                                    <!-- Paginaci√≥n din√°mica -->
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Vista Clientes -->
                <div class="view" id="clientesView">
                    <div style="padding: 20px;">
                        <div class="card">
                            <div class="card-header">
                                <h2><i class="fas fa-users"></i> Gesti√≥n de Clientes</h2>
                                <div style="display: flex; gap: 10px;">
                                    <button class="btn btn-primary" onclick="mostrarModal('modalNuevoCliente')">
                                        <i class="fas fa-plus"></i> Nuevo Cliente
                                    </button>
                                    <button class="btn btn-outline" onclick="mostrarModal('modalImportarClientes')">
                                        <i class="fas fa-file-import"></i> Importar Excel
                                    </button>
                                    <button class="btn btn-outline" onclick="exportarClientesExcel()">
                                        <i class="fas fa-file-export"></i> Exportar Excel
                                    </button>
                                    <button class="btn btn-warning" onclick="mostrarModal('modalPagosClientes')">
                                        <i class="fas fa-money-check"></i> Registrar Pago
                                    </button>
                                </div>
                            </div>
                            <div class="card-body">
                                <div class="filters">
                                    <div class="filter-group">
                                        <label>B√∫squeda</label>
                                        <input type="text" id="buscarClientes" class="form-control" placeholder="Nombre, documento..." 
                                               onkeyup="filtrarClientes()" style="width: 300px;">
                                    </div>
                                    <div class="filter-group">
                                        <label>Tipo</label>
                                        <select id="filtroTipoCliente" class="form-control" onchange="filtrarClientes()">
                                            <option value="">Todos</option>
                                            <option value="consumidor_final">Consumidor Final</option>
                                            <option value="responsable_inscripto">Responsable Inscripto</option>
                                            <option value="monotributista">Monotributista</option>
                                            <option value="exento">Exento</option>
                                        </select>
                                    </div>
                                    <div class="filter-group">
                                        <label>Estado</label>
                                        <select id="filtroEstadoCliente" class="form-control" onchange="filtrarClientes()">
                                            <option value="">Todos</option>
                                            <option value="activo">Activo</option>
                                            <option value="inactivo">Inactivo</option>
                                            <option value="moroso">Moroso</option>
                                        </select>
                                    </div>
                                </div>
                                
                                <div class="table-container">
                                    <table class="data-table">
                                        <thead>
                                            <tr>
                                                <th>Nombre</th>
                                                <th>Documento</th>
                                                <th>Email</th>
                                                <th>Tel√©fono</th>
                                                <th>Saldo</th>
                                                <th>L√≠mite Cr√©dito</th>
                                                <th>√öltima Compra</th>
                                                <th>Estado</th>
                                                <th>Acciones</th>
                                            </tr>
                                        </thead>
                                        <tbody id="tablaClientesGestion">
                                            <!-- Clientes cargados din√°micamente -->
                                        </tbody>
                                    </table>
                                </div>
                                
                                <div class="pagination" id="paginacionClientes">
                                    <!-- Paginaci√≥n din√°mica -->
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Vista Ventas -->
                <div class="view" id="ventasView">
                    <div style="padding: 20px;">
                        <div class="card">
                            <div class="card-header">
                                <h2><i class="fas fa-chart-line"></i> Historial de Ventas</h2>
                                <div style="display: flex; gap: 10px;">
                                    <button class="btn btn-outline" onclick="exportarVentasExcel()">
                                        <i class="fas fa-file-export"></i> Exportar Excel
                                    </button>
                                    <button class="btn btn-warning" onclick="filtrarVentasHoy()">
                                        <i class="fas fa-calendar-day"></i> Hoy
                                    </button>
                                    <button class="btn btn-outline" onclick="filtrarVentasMes()">
                                        <i class="fas fa-calendar-alt"></i> Este Mes
                                    </button>
                                </div>
                            </div>
                            <div class="card-body">
                                <div class="filters">
                                    <div class="filter-group">
                                        <label>Fecha Desde</label>
                                        <input type="date" id="fechaDesde" class="form-control" onchange="filtrarVentas()">
                                    </div>
                                    <div class="filter-group">
                                        <label>Fecha Hasta</label>
                                        <input type="date" id="fechaHasta" class="form-control" onchange="filtrarVentas()">
                                    </div>
                                    <div class="filter-group">
                                        <label>Cliente</label>
                                        <select id="filtroClienteVentas" class="form-control" onchange="filtrarVentas()">
                                            <option value="">Todos los clientes</option>
                                            <!-- Cargado din√°micamente -->
                                        </select>
                                    </div>
                                    <div class="filter-group">
                                        <label>Estado</label>
                                        <select id="filtroEstadoVenta" class="form-control" onchange="filtrarVentas()">
                                            <option value="">Todas</option>
                                            <option value="completada">Completadas</option>
                                            <option value="anulada">Anuladas</option>
                                            <option value="presupuesto">Presupuestos</option>
                                        </select>
                                    </div>
                                    <div class="filter-group">
                                        <label>M√©todo Pago</label>
                                        <select id="filtroMetodoPago" class="form-control" onchange="filtrarVentas()">
                                            <option value="">Todos</option>
                                            <option value="efectivo">Efectivo</option>
                                            <option value="tarjeta">Tarjeta</option>
                                            <option value="transferencia">Transferencia</option>
                                            <option value="cuenta_corriente">Cuenta Corriente</option>
                                        </select>
                                    </div>
                                </div>
                                
                                <div class="table-container">
                                    <table class="data-table">
                                        <thead>
                                            <tr>
                                                <th>Factura</th>
                                                <th>Fecha</th>
                                                <th>Cliente</th>
                                                <th>Items</th>
                                                <th>Subtotal</th>
                                                <th>IVA</th>
                                                <th>Total</th>
                                                <th>M√©todo Pago</th>
                                                <th>Vendedor</th>
                                                <th>Estado</th>
                                                <th>Acciones</th>
                                            </tr>
                                        </thead>
                                        <tbody id="tablaVentas">
                                            <!-- Ventas cargadas din√°micamente -->
                                        </tbody>
                                    </table>
                                </div>
                                
                                <div class="pagination" id="paginacionVentas">
                                    <!-- Paginaci√≥n din√°mica -->
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Vista Caja y Turnos -->
                <div class="view" id="cajaView">
                    <div style="padding: 20px;">
                        <div class="card">
                            <div class="card-header">
                                <h2><i class="fas fa-cash-register"></i> Caja y Turnos</h2>
                                <div style="display: flex; gap: 10px;">
                                    <button class="btn btn-primary" onclick="abrirTurno()" id="btnAbrirTurno">
                                        <i class="fas fa-door-open"></i> Abrir Turno
                                    </button>
                                    <button class="btn btn-danger" onclick="cerrarTurno()" id="btnCerrarTurno" disabled>
                                        <i class="fas fa-door-closed"></i> Cerrar Turno
                                    </button>
                                    <button class="btn btn-outline" onclick="mostrarModal('modalArqueoCaja')">
                                        <i class="fas fa-calculator"></i> Arqueo de Caja
                                    </button>
                                </div>
                            </div>
                            <div class="card-body">
                                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px; margin-bottom: 30px;">
                                    <div class="card">
                                        <div class="card-header">
                                            <h3><i class="fas fa-info-circle"></i> Informaci√≥n Turno Actual</h3>
                                        </div>
                                        <div class="card-body">
                                            <div id="infoTurnoActual">
                                                <p>No hay turno activo</p>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <div class="card">
                                        <div class="card-header">
                                            <h3><i class="fas fa-chart-pie"></i> Resumen del D√≠a</h3>
                                        </div>
                                        <div class="card-body">
                                            <div id="resumenDia">
                                                <p>Cargando...</p>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <div class="card">
                                        <div class="card-header">
                                            <h3><i class="fas fa-money-bill-wave"></i> M√©todos de Pago</h3>
                                        </div>
                                        <div class="card-body">
                                            <div id="resumenPagos">
                                                <p>Cargando...</p>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                
                                <h3 style="margin-bottom: 20px;">Historial de Turnos</h3>
                                <div class="table-container">
                                    <table class="data-table">
                                        <thead>
                                            <tr>
                                                <th>Fecha</th>
                                                <th>Turno</th>
                                                <th>Usuario</th>
                                                <th>Apertura</th>
                                                <th>Cierre</th>
                                                <th>Ventas</th>
                                                <th>Total</th>
                                                <th>Efectivo Inicial</th>
                                                <th>Efectivo Final</th>
                                                <th>Estado</th>
                                                <th>Acciones</th>
                                            </tr>
                                        </thead>
                                        <tbody id="tablaTurnos">
                                            <!-- Turnos cargados din√°micamente -->
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Vista Reportes -->
                <div class="view" id="reportesView">
                    <div style="padding: 20px;">
                        <div class="card">
                            <div class="card-header">
                                <h2><i class="fas fa-chart-bar"></i> Reportes y Estad√≠sticas</h2>
                                <div style="display: flex; gap: 10px;">
                                    <button class="btn btn-outline" onclick="generarReporteDiario()">
                                        <i class="fas fa-calendar-day"></i> Diario
                                    </button>
                                    <button class="btn btn-outline" onclick="generarReporteMensual()">
                                        <i class="fas fa-calendar-alt"></i> Mensual
                                    </button>
                                    <button class="btn btn-outline" onclick="generarReporteAnual()">
                                        <i class="fas fa-calendar"></i> Anual
                                    </button>
                                    <button class="btn btn-primary" onclick="exportarReporteExcel()">
                                        <i class="fas fa-file-excel"></i> Exportar Excel
                                    </button>
                                </div>
                            </div>
                            <div class="card-body">
                                <div class="filters">
                                    <div class="filter-group">
                                        <label>Fecha Desde</label>
                                        <input type="date" id="reporteFechaDesde" class="form-control" onchange="actualizarReportes()">
                                    </div>
                                    <div class="filter-group">
                                        <label>Fecha Hasta</label>
                                        <input type="date" id="reporteFechaHasta" class="form-control" onchange="actualizarReportes()">
                                    </div>
                                    <div class="filter-group">
                                        <label>Sucursal</label>
                                        <select id="reporteSucursal" class="form-control" onchange="actualizarReportes()">
                                            <option value="">Todas las sucursales</option>
                                            <!-- Cargado din√°micamente -->
                                        </select>
                                    </div>
                                    <div class="filter-group">
                                        <label>Vendedor</label>
                                        <select id="reporteVendedor" class="form-control" onchange="actualizarReportes()">
                                            <option value="">Todos los vendedores</option>
                                            <!-- Cargado din√°micamente -->
                                        </select>
                                    </div>
                                </div>
                                
                                <div class="charts-container">
                                    <div class="card chart-card">
                                        <h3>Ventas por D√≠a</h3>
                                        <canvas id="chartVentasDia"></canvas>
                                    </div>
                                    
                                    <div class="card chart-card">
                                        <h3>Ventas por Categor√≠a</h3>
                                        <canvas id="chartVentasCategoria"></canvas>
                                    </div>
                                    
                                    <div class="card chart-card">
                                        <h3>M√©todos de Pago</h3>
                                        <canvas id="chartMetodosPago"></canvas>
                                    </div>
                                    
                                    <div class="card chart-card">
                                        <h3>Top 10 Productos</h3>
                                        <canvas id="chartTopProductos"></canvas>
                                    </div>
                                </div>
                                
                                <div class="card" style="margin-top: 30px;">
                                    <div class="card-header">
                                        <h3>Detalle de Ventas</h3>
                                    </div>
                                    <div class="card-body">
                                        <div class="table-container">
                                            <table class="data-table">
                                                <thead>
                                                    <tr>
                                                        <th>Fecha</th>
                                                        <th>Factura</th>
                                                        <th>Cliente</th>
                                                        <th>Productos</th>
                                                        <th>Cantidad</th>
                                                        <th>Subtotal</th>
                                                        <th>Descuento</th>
                                                        <th>IVA</th>
                                                        <th>Total</th>
                                                        <th>Vendedor</th>
                                                        <th>M√©todo Pago</th>
                                                    </tr>
                                                </thead>
                                                <tbody id="tablaReporteVentas">
                                                    <!-- Ventas del reporte -->
                                                </tbody>
                                            </table>
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="card" style="margin-top: 30px;">
                                    <div class="card-header">
                                        <h3>Resumen General</h3>
                                    </div>
                                    <div class="card-body">
                                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px;">
                                            <div class="card">
                                                <div class="card-body">
                                                    <h4>Total Ventas</h4>
                                                    <h2 id="reporteTotalVentas">$0.00</h2>
                                                </div>
                                            </div>
                                            <div class="card">
                                                <div class="card-body">
                                                    <h4>Cantidad Ventas</h4>
                                                    <h2 id="reporteCantidadVentas">0</h2>
                                                </div>
                                            </div>
                                            <div class="card">
                                                <div class="card-body">
                                                    <h4>Promedio por Venta</h4>
                                                    <h2 id="reportePromedioVenta">$0.00</h2>
                                                </div>
                                            </div>
                                            <div class="card">
                                                <div class="card-body">
                                                    <h4>Productos Vendidos</h4>
                                                    <h2 id="reporteProductosVendidos">0</h2>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Vista Proveedores -->
                <div class="view" id="proveedoresView">
                    <div style="padding: 20px;">
                        <div class="card">
                            <div class="card-header">
                                <h2><i class="fas fa-truck"></i> Gesti√≥n de Proveedores</h2>
                                <div style="display: flex; gap: 10px;">
                                    <button class="btn btn-primary" onclick="mostrarModal('modalNuevoProveedor')">
                                        <i class="fas fa-plus"></i> Nuevo Proveedor
                                    </button>
                                    <button class="btn btn-outline" onclick="mostrarModal('modalNuevoPedido')">
                                        <i class="fas fa-clipboard-list"></i> Nuevo Pedido
                                    </button>
                                    <button class="btn btn-success" onclick="enviarPedidosWhatsApp()">
                                        <i class="fab fa-whatsapp"></i> Enviar por WhatsApp
                                    </button>
                                </div>
                            </div>
                            <div class="card-body">
                                <div class="tabs">
                                    <div class="tab active" onclick="cambiarTabProveedores('proveedores')">Proveedores</div>
                                    <div class="tab" onclick="cambiarTabProveedores('pedidos')">Pedidos</div>
                                    <div class="tab" onclick="cambiarTabProveedores('recepciones')">Recepciones</div>
                                </div>
                                
                                <div id="tabProveedores">
                                    <div class="filters">
                                        <div class="filter-group">
                                            <label>B√∫squeda</label>
                                            <input type="text" id="buscarProveedores" class="form-control" placeholder="Nombre, contacto..." 
                                                   onkeyup="filtrarProveedores()" style="width: 300px;">
                                        </div>
                                        <div class="filter-group">
                                            <label>Categor√≠a</label>
                                            <select id="filtroCategoriaProveedor" class="form-control" onchange="filtrarProveedores()">
                                                <option value="">Todas las categor√≠as</option>
                                                <option value="alimentos">Alimentos</option>
                                                <option value="bebidas">Bebidas</option>
                                                <option value="limpieza">Limpieza</option>
                                                <option value="otros">Otros</option>
                                            </select>
                                        </div>
                                    </div>
                                    
                                    <div class="table-container">
                                        <table class="data-table">
                                            <thead>
                                                <tr>
                                                    <th>Nombre</th>
                                                    <th>Contacto</th>
                                                    <th>Tel√©fono</th>
                                                    <th>Email</th>
                                                    <th>Productos</th>
                                                    <th>√öltimo Pedido</th>
                                                    <th>Estado</th>
                                                    <th>Acciones</th>
                                                </tr>
                                            </thead>
                                            <tbody id="tablaProveedores">
                                                <!-- Proveedores cargados din√°micamente -->
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                                
                                <div id="tabPedidos" style="display: none;">
                                    <div class="table-container">
                                        <table class="data-table">
                                            <thead>
                                                <tr>
                                                    <th>Pedido #</th>
                                                    <th>Proveedor</th>
                                                    <th>Fecha</th>
                                                    <th>Productos</th>
                                                    <th>Total</th>
                                                    <th>Estado</th>
                                                    <th>Entrega Estimada</th>
                                                    <th>Acciones</th>
                                                </tr>
                                            </thead>
                                            <tbody id="tablaPedidos">
                                                <!-- Pedidos cargados din√°micamente -->
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                                
                                <div id="tabRecepciones" style="display: none;">
                                    <div class="table-container">
                                        <table class="data-table">
                                            <thead>
                                                <tr>
                                                    <th>Recepci√≥n #</th>
                                                    <th>Pedido</th>
                                                    <th>Proveedor</th>
                                                    <th>Fecha Recepci√≥n</th>
                                                    <th>Productos Recibidos</th>
                                                    <th>Factura</th>
                                                    <th>Estado</th>
                                                    <th>Acciones</th>
                                                </tr>
                                            </thead>
                                            <tbody id="tablaRecepciones">
                                                <!-- Recepciones cargadas din√°micamente -->
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Vista Configuraci√≥n -->
                <div class="view" id="configuracionView">
                    <div style="padding: 20px;">
                        <div class="card">
                            <div class="card-header">
                                <h2><i class="fas fa-cog"></i> Configuraci√≥n del Sistema</h2>
                            </div>
                            <div class="card-body">
                                <div class="tabs">
                                    <div class="tab active" onclick="cambiarTabConfiguracion('empresa')">Empresa</div>
                                    <div class="tab" onclick="cambiarTabConfiguracion('facturacion')">Facturaci√≥n</div>
                                    <div class="tab" onclick="cambiarTabConfiguracion('impresion')">Impresi√≥n</div>
                                    <div class="tab" onclick="cambiarTabConfiguracion('usuarios')">Usuarios</div>
                                    <div class="tab" onclick="cambiarTabConfiguracion('sucursales')">Sucursales</div>
                                    <div class="tab" onclick="cambiarTabConfiguracion('backup')">Backup</div>
                                </div>
                                
                                <div id="tabEmpresa">
                                    <form id="formConfigEmpresa">
                                        <div class="form-group">
                                            <label>Nombre del Comercio *</label>
                                            <input type="text" id="configEmpresaNombre" class="form-control" required>
                                        </div>
                                        <div class="form-group">
                                            <label>Raz√≥n Social</label>
                                            <input type="text" id="configEmpresaRazonSocial" class="form-control">
                                        </div>
                                        <div class="form-group">
                                            <label>CUIT/CUIL</label>
                                            <input type="text" id="configEmpresaCuit" class="form-control">
                                        </div>
                                        <div class="form-group">
                                            <label>Direcci√≥n</label>
                                            <input type="text" id="configEmpresaDireccion" class="form-control">
                                        </div>
                                        <div class="form-group">
                                            <label>Tel√©fono</label>
                                            <input type="text" id="configEmpresaTelefono" class="form-control">
                                        </div>
                                        <div class="form-group">
                                            <label>Email</label>
                                            <input type="email" id="configEmpresaEmail" class="form-control">
                                        </div>
                                        <div class="form-group">
                                            <label>Condici√≥n IVA</label>
                                            <select id="configEmpresaCondicionIva" class="form-control">
                                                <option value="responsable_inscripto">Responsable Inscripto</option>
                                                <option value="monotributista">Monotributista</option>
                                                <option value="consumidor_final">Consumidor Final</option>
                                                <option value="exento">Exento</option>
                                            </select>
                                        </div>
                                        <div class="form-group">
                                            <label>Ingresos Brutos</label>
                                            <input type="text" id="configEmpresaIngresosBrutos" class="form-control">
                                        </div>
                                        <div class="form-group">
                                            <label>Fecha Inicio Actividades</label>
                                            <input type="date" id="configEmpresaInicioActividades" class="form-control">
                                        </div>
                                        <button type="submit" class="btn btn-primary">Guardar Configuraci√≥n</button>
                                    </form>
                                </div>
                                
                                <div id="tabFacturacion" style="display: none;">
                                    <form id="formConfigFacturacion">
                                        <div class="form-group">
                                            <label>Punto de Venta (PV)</label>
                                            <input type="number" id="configFacturacionPuntoVenta" class="form-control" min="1" max="9999">
                                        </div>
                                        <div class="form-group">
                                            <label>Pr√≥ximo N√∫mero Factura A</label>
                                            <input type="number" id="configFacturacionProximoNumeroA" class="form-control">
                                        </div>
                                        <div class="form-group">
                                            <label>Pr√≥ximo N√∫mero Factura B</label>
                                            <input type="number" id="configFacturacionProximoNumeroB" class="form-control">
                                        </div>
                                        <div class="form-group">
                                            <label>Pr√≥ximo N√∫mero Factura C</label>
                                            <input type="number" id="configFacturacionProximoNumeroC" class="form-control">
                                        </div>
                                        <div class="form-group">
                                            <label>IVA (%)</label>
                                            <input type="number" id="configFacturacionIva" class="form-control" value="21" step="0.1">
                                        </div>
                                        <div class="form-group">
                                            <label>Mensaje en Facturas</label>
                                            <textarea id="configFacturacionMensaje" class="form-control" rows="3"></textarea>
                                        </div>
                                        <div class="form-group">
                                            <label>
                                                <input type="checkbox" id="configFacturacionAutoImprimir"> Auto-imprimir facturas
                                            </label>
                                        </div>
                                        <div class="form-group">
                                            <label>
                                                <input type="checkbox" id="configFacturacionAutoEnviarEmail"> Auto-enviar por email
                                            </label>
                                        </div>
                                        <button type="submit" class="btn btn-primary">Guardar Configuraci√≥n</button>
                                    </form>
                                </div>
                                
                                <div id="tabImpresion" style="display: none;">
                                    <form id="formConfigImpresion">
                                        <div class="form-group">
                                            <label>Tipo de Impresora</label>
                                            <select id="configImpresionTipo" class="form-control">
                                                <option value="termica">T√©rmica 80mm</option>
                                                <option value="a4">A4 Normal</option>
                                                <option value="pdf">Solo PDF</option>
                                            </select>
                                        </div>
                                        <div class="form-group">
                                            <label>Nombre Impresora</label>
                                            <input type="text" id="configImpresionNombre" class="form-control" placeholder="Nombre de la impresora">
                                        </div>
                                        <div class="form-group">
                                            <label>Copias del Ticket</label>
                                            <input type="number" id="configImpresionCopias" class="form-control" value="1" min="1" max="3">
                                        </div>
                                        <div class="form-group">
                                            <label>Encabezado del Ticket</label>
                                            <textarea id="configImpresionEncabezado" class="form-control" rows="3" placeholder="Texto que aparece en el encabezado"></textarea>
                                        </div>
                                        <div class="form-group">
                                            <label>Pie del Ticket</label>
                                            <textarea id="configImpresionPie" class="form-control" rows="3" placeholder="Texto que aparece en el pie"></textarea>
                                        </div>
                                        <div class="form-group">
                                            <label>Logo (URL)</label>
                                            <input type="text" id="configImpresionLogo" class="form-control" placeholder="URL del logo">
                                        </div>
                                        <div class="form-group">
                                            <label>Test de Impresi√≥n</label>
                                            <button type="button" class="btn btn-outline" onclick="testImpresion()">
                                                <i class="fas fa-print"></i> Probar Impresi√≥n
                                            </button>
                                        </div>
                                        <button type="submit" class="btn btn-primary">Guardar Configuraci√≥n</button>
                                    </form>
                                </div>
                                
                                <div id="tabUsuarios" style="display: none;">
                                    <div style="margin-bottom: 20px;">
                                        <button class="btn btn-primary" onclick="mostrarModal('modalNuevoUsuario')">
                                            <i class="fas fa-plus"></i> Nuevo Usuario
                                        </button>
                                    </div>
                                    <div class="table-container">
                                        <table class="data-table">
                                            <thead>
                                                <tr>
                                                    <th>Nombre</th>
                                                    <th>Email</th>
                                                    <th>Rol</th>
                                                    <th>Sucursal</th>
                                                    <th>√öltimo Acceso</th>
                                                    <th>Estado</th>
                                                    <th>Acciones</th>
                                                </tr>
                                            </thead>
                                            <tbody id="tablaUsuarios">
                                                <!-- Usuarios cargados din√°micamente -->
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                                
                                <div id="tabSucursales" style="display: none;">
                                    <div style="margin-bottom: 20px;">
                                        <button class="btn btn-primary" onclick="mostrarModal('modalNuevaSucursal')">
                                            <i class="fas fa-plus"></i> Nueva Sucursal
                                        </button>
                                    </div>
                                    <div class="table-container">
                                        <table class="data-table">
                                            <thead>
                                                <tr>
                                                    <th>Nombre</th>
                                                    <th>C√≥digo</th>
                                                    <th>Direcci√≥n</th>
                                                    <th>Tel√©fono</th>
                                                    <th>Responsable</th>
                                                    <th>Estado</th>
                                                    <th>Acciones</th>
                                                </tr>
                                            </thead>
                                            <tbody id="tablaSucursales">
                                                <!-- Sucursales cargadas din√°micamente -->
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                                
                                <div id="tabBackup" style="display: none;">
                                    <div style="margin-bottom: 30px;">
                                        <h3>Backup Autom√°tico</h3>
                                        <div class="form-group">
                                            <label>
                                                <input type="checkbox" id="configBackupAuto"> Realizar backup autom√°tico diario
                                            </label>
                                        </div>
                                        <div class="form-group">
                                            <label>Hora del Backup</label>
                                            <input type="time" id="configBackupHora" class="form-control">
                                        </div>
                                        <div class="form-group">
                                            <label>Guardar en:</label>
                                            <select id="configBackupDestino" class="form-control">
                                                <option value="local">Solo localmente</option>
                                                <option value="email">Enviar por email</option>
                                                <option value="drive">Google Drive</option>
                                                <option value="dropbox">Dropbox</option>
                                            </select>
                                        </div>
                                    </div>
                                    
                                    <div style="margin-bottom: 30px;">
                                        <h3>Restaurar Sistema</h3>
                                        <div class="alert alert-warning">
                                            <i class="fas fa-exclamation-triangle"></i>
                                            Advertencia: Restaurar un backup sobrescribir√° todos los datos actuales.
                                        </div>
                                        <div class="form-group">
                                            <label>Seleccionar Archivo Backup</label>
                                            <input type="file" id="fileRestoreBackup" class="form-control" accept=".json,.zip">
                                        </div>
                                        <button class="btn btn-danger" onclick="restaurarBackup()">
                                            <i class="fas fa-history"></i> Restaurar Backup
                                        </button>
                                    </div>
                                    
                                    <div>
                                        <h3>Historial de Backups</h3>
                                        <div class="table-container">
                                            <table class="data-table">
                                                <thead>
                                                    <tr>
                                                        <th>Fecha</th>
                                                        <th>Tama√±o</th>
                                                        <th>Tipo</th>
                                                        <th>Estado</th>
                                                        <th>Acciones</th>
                                                    </tr>
                                                </thead>
                                                <tbody id="tablaBackups">
                                                    <!-- Backups cargados din√°micamente -->
                                                </tbody>
                                            </table>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- MODALES -->
    
    <!-- Modal Productos -->
    <div class="modal" id="modalProductos">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Gesti√≥n de Productos</h3>
                <button class="modal-close" onclick="cerrarModal('modalProductos')">&times;</button>
            </div>
            <div class="modal-body">
                <div id="modalProductosContent"></div>
            </div>
        </div>
    </div>
    
    <!-- Modal Nuevo Producto -->
    <div class="modal" id="modalNuevoProducto">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Nuevo Producto</h3>
                <button class="modal-close" onclick="cerrarModal('modalNuevoProducto')">&times;</button>
            </div>
            <div class="modal-body">
                <form id="formNuevoProducto">
                    <div class="form-group">
                        <label>C√≥digo *</label>
                        <input type="text" id="nuevoProductoCodigo" class="form-control" required>
                    </div>
                    <div class="form-group">
                        <label>Nombre *</label>
                        <input type="text" id="nuevoProductoNombre" class="form-control" required>
                    </div>
                    <div class="form-group">
                        <label>Descripci√≥n</label>
                        <textarea id="nuevoProductoDescripcion" class="form-control" rows="2"></textarea>
                    </div>
                    <div class="form-group">
                        <label>Categor√≠a</label>
                        <input type="text" id="nuevoProductoCategoria" class="form-control" list="categoriasList">
                        <datalist id="categoriasList"></datalist>
                    </div>
                    <div class="form-group">
                        <label>Proveedor</label>
                        <select id="nuevoProductoProveedor" class="form-control">
                            <option value="">Seleccionar proveedor</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Precio Costo</label>
                        <input type="number" id="nuevoProductoPrecioCosto" class="form-control" step="0.01" min="0">
                    </div>
                    <div class="form-group">
                        <label>Precio Venta *</label>
                        <input type="number" id="nuevoProductoPrecioVenta" class="form-control" step="0.01" min="0" required>
                    </div>
                    <div class="form-group">
                        <label>Margen de Ganancia (%)</label>
                        <input type="number" id="nuevoProductoMargen" class="form-control" step="0.1" oninput="calcularPrecioDesdeMargen()">
                    </div>
                    <div class="form-group">
                        <label>Stock Inicial</label>
                        <input type="number" id="nuevoProductoStock" class="form-control" min="0" value="0">
                    </div>
                    <div class="form-group">
                        <label>Stock M√≠nimo</label>
                        <input type="number" id="nuevoProductoStockMinimo" class="form-control" min="0" value="5">
                    </div>
                    <div class="form-group">
                        <label>
                            <input type="checkbox" id="nuevoProductoControlStock" checked> Controlar stock
                        </label>
                    </div>
                    <div class="form-group">
                        <label>
                            <input type="checkbox" id="nuevoProductoActivo" checked> Activo
                        </label>
                    </div>
                    <div class="form-group">
                        <button type="submit" class="btn btn-primary">
                            <i class="fas fa-save"></i> Guardar Producto
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
    
    <!-- Modal Importar Productos -->
    <div class="modal" id="modalImportarProductos">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Importar Productos desde Excel</h3>
                <button class="modal-close" onclick="cerrarModal('modalImportarProductos')">&times;</button>
            </div>
            <div class="modal-body">
                <div class="alert alert-info">
                    <i class="fas fa-info-circle"></i>
                    El archivo Excel debe tener las columnas: C√≥digo, Nombre, Categor√≠a, Precio Costo, Precio Venta, Stock
                </div>
                <div class="form-group">
                    <label>Seleccionar archivo Excel</label>
                    <input type="file" id="fileImportarProductos" class="form-control" accept=".xlsx,.xls,.csv">
                </div>
                <div class="form-group">
                    <label>Proveedor (opcional)</label>
                    <select id="importarProductosProveedor" class="form-control">
                        <option value="">Seleccionar proveedor</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>
                        <input type="checkbox" id="importarSobrescribir"> Sobrescribir productos existentes
                    </label>
                </div>
                <div class="form-group">
                    <button class="btn btn-primary" onclick="procesarImportacionProductos()">
                        <i class="fas fa-upload"></i> Importar Productos
                    </button>
                </div>
                <div id="importacionResultado" style="display: none; margin-top: 20px; padding: 15px; background: #f8fafc; border-radius: 8px;"></div>
            </div>
        </div>
    </div>
    
    <!-- Modal Cambio Masivo de Precios -->
    <div class="modal" id="modalCambioMasivoPrecios">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Cambio Masivo de Precios</h3>
                <button class="modal-close" onclick="cerrarModal('modalCambioMasivoPrecios')">&times;</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label>Tipo de Ajuste</label>
                    <select id="tipoAjustePrecios" class="form-control" onchange="actualizarOpcionesAjuste()">
                        <option value="porcentaje">Porcentaje</option>
                        <option value="monto">Monto Fijo</option>
                        <option value="redondeo">Redondeo</option>
                        <option value="margen">Margen de Ganancia</option>
                    </select>
                </div>
                <div id="opcionesAjustePorcentaje" class="opciones-ajuste">
                    <div class="form-group">
                        <label>Porcentaje de Aumento (%)</label>
                        <input type="number" id="ajustePorcentaje" class="form-control" step="0.1" value="10">
                    </div>
                    <div class="form-group">
                        <label>Aplicar a:</label>
                        <select id="aplicarPorcentajeA" class="form-control">
                            <option value="precio_venta">Precio de Venta</option>
                            <option value="precio_costo">Precio de Costo</option>
                            <option value="ambos">Ambos</option>
                        </select>
                    </div>
                </div>
                <div id="opcionesAjusteMonto" class="opciones-ajuste" style="display: none;">
                    <div class="form-group">
                        <label>Monto a Sumar</label>
                        <input type="number" id="ajusteMonto" class="form-control" step="0.01" value="0">
                    </div>
                    <div class="form-group">
                        <label>Aplicar a:</label>
                        <select id="aplicarMontoA" class="form-control">
                            <option value="precio_venta">Precio de Venta</option>
                            <option value="precio_costo">Precio de Costo</option>
                        </select>
                    </div>
                </div>
                <div id="opcionesAjusteMargen" class="opciones-ajuste" style="display: none;">
                    <div class="form-group">
                        <label>Margen de Ganancia Deseado (%)</label>
                        <input type="number" id="ajusteMargen" class="form-control" step="0.1" value="30">
                    </div>
                </div>
                <div class="form-group">
                    <label>Filtrar por:</label>
                    <select id="filtroAjuste" class="form-control" onchange="actualizarFiltroAjuste()">
                        <option value="todos">Todos los productos</option>
                        <option value="categoria">Categor√≠a</option>
                        <option value="proveedor">Proveedor</option>
                        <option value="stock">Stock</option>
                    </select>
                </div>
                <div id="filtroCategoriaAjuste" class="filtro-ajuste" style="display: none;">
                    <div class="form-group">
                        <label>Seleccionar Categor√≠a</label>
                        <select id="categoriaAjuste" class="form-control"></select>
                    </div>
                </div>
                <div class="form-group">
                    <label>Productos a Afectar: <span id="contadorProductosAjuste">0</span></label>
                </div>
                <div class="form-group">
                    <button class="btn btn-warning" onclick="calcularPrevisualizacionAjuste()">
                        <i class="fas fa-calculator"></i> Previsualizar Cambios
                    </button>
                </div>
                <div id="previsualizacionAjuste" style="display: none; margin-top: 20px;"></div>
                <div class="form-group" style="margin-top: 20px;">
                    <button class="btn btn-danger" id="btnAplicarAjuste" onclick="aplicarCambioMasivoPrecios()" disabled>
                        <i class="fas fa-exclamation-triangle"></i> Aplicar Cambios Masivos
                    </button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Modal Clientes -->
    <div class="modal" id="modalClientes">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Gesti√≥n de Clientes</h3>
                <button class="modal-close" onclick="cerrarModal('modalClientes')">&times;</button>
            </div>
            <div class="modal-body">
                <div id="modalClientesContent"></div>
            </div>
        </div>
    </div>
    
    <!-- Modal Nuevo Cliente -->
    <div class="modal" id="modalNuevoCliente">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Nuevo Cliente</h3>
                <button class="modal-close" onclick="cerrarModal('modalNuevoCliente')">&times;</button>
            </div>
            <div class="modal-body">
                <form id="formNuevoCliente">
                    <div class="form-group">
                        <label>Nombre/Raz√≥n Social *</label>
                        <input type="text" id="nuevoClienteNombre" class="form-control" required>
                    </div>
                    <div class="form-group">
                        <label>Tipo de Documento</label>
                        <select id="nuevoClienteTipoDocumento" class="form-control">
                            <option value="dni">DNI</option>
                            <option value="cuit">CUIT</option>
                            <option value="cuil">CUIL</option>
                            <option value="pasaporte">Pasaporte</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>N√∫mero de Documento</label>
                        <input type="text" id="nuevoClienteDocumento" class="form-control">
                    </div>
                    <div class="form-group">
                        <label>Condici√≥n IVA</label>
                        <select id="nuevoClienteCondicionIva" class="form-control">
                            <option value="consumidor_final">Consumidor Final</option>
                            <option value="responsable_inscripto">Responsable Inscripto</option>
                            <option value="monotributista">Monotributista</option>
                            <option value="exento">Exento</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Email</label>
                        <input type="email" id="nuevoClienteEmail" class="form-control">
                    </div>
                    <div class="form-group">
                        <label>Tel√©fono</label>
                        <input type="text" id="nuevoClienteTelefono" class="form-control">
                    </div>
                    <div class="form-group">
                        <label>Direcci√≥n</label>
                        <input type="text" id="nuevoClienteDireccion" class="form-control">
                    </div>
                    <div class="form-group">
                        <label>Ciudad</label>
                        <input type="text" id="nuevoClienteCiudad" class="form-control">
                    </div>
                    <div class="form-group">
                        <label>C√≥digo Postal</label>
                        <input type="text" id="nuevoClienteCodigoPostal" class="form-control">
                    </div>
                    <div class="form-group">
                        <label>L√≠mite de Cr√©dito</label>
                        <input type="number" id="nuevoClienteLimiteCredito" class="form-control" step="0.01" min="0" value="0">
                    </div>
                    <div class="form-group">
                        <label>D√≠as de Cr√©dito</label>
                        <input type="number" id="nuevoClienteDiasCredito" class="form-control" min="0" value="0">
                    </div>
                    <div class="form-group">
                        <label>Categor√≠a</label>
                        <select id="nuevoClienteCategoria" class="form-control">
                            <option value="normal">Normal</option>
                            <option value="preferencial">Preferencial</option>
                            <option value="corporativo">Corporativo</option>
                            <option value="distribuidor">Distribuidor</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>
                            <input type="checkbox" id="nuevoClienteActivo" checked> Activo
                        </label>
                    </div>
                    <div class="form-group">
                        <label>
                            <input type="checkbox" id="nuevoClienteRecibirEmail"> Recibir emails promocionales
                        </label>
                    </div>
                    <div class="form-group">
                        <button type="submit" class="btn btn-primary">
                            <i class="fas fa-save"></i> Guardar Cliente
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
    
    <!-- Modal Pagos Clientes -->
    <div class="modal" id="modalPagosClientes">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Registrar Pago de Cliente</h3>
                <button class="modal-close" onclick="cerrarModal('modalPagosClientes')">&times;</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label>Seleccionar Cliente *</label>
                    <select id="pagoClienteSeleccion" class="form-control" onchange="cargarDeudaCliente()" required>
                        <option value="">Seleccionar cliente</option>
                    </select>
                </div>
                <div id="infoDeudaCliente" style="display: none; margin-bottom: 20px; padding: 15px; background: #f8fafc; border-radius: 8px;">
                    <h4>Informaci√≥n de Deuda</h4>
                    <p>Saldo Actual: <strong id="pagoSaldoActual">$0.00</strong></p>
                    <p>L√≠mite de Cr√©dito: <span id="pagoLimiteCredito">$0.00</span></p>
                    <p>Disponible: <span id="pagoDisponibleCredito">$0.00</span></p>
                </div>
                <div class="form-group">
                    <label>Monto del Pago *</label>
                    <input type="number" id="pagoMonto" class="form-control" step="0.01" min="0.01" required>
                </div>
                <div class="form-group">
                    <label>Fecha del Pago</label>
                    <input type="date" id="pagoFecha" class="form-control">
                </div>
                <div class="form-group">
                    <label>M√©todo de Pago</label>
                    <select id="pagoMetodo" class="form-control">
                        <option value="efectivo">Efectivo</option>
                        <option value="transferencia">Transferencia</option>
                        <option value="cheque">Cheque</option>
                        <option value="otros">Otros</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Referencia/Comprobante</label>
                    <input type="text" id="pagoReferencia" class="form-control" placeholder="N√∫mero de comprobante">
                </div>
                <div class="form-group">
                    <label>Notas</label>
                    <textarea id="pagoNotas" class="form-control" rows="3" placeholder="Notas adicionales"></textarea>
                </div>
                <div class="form-group">
                    <button class="btn btn-success" onclick="registrarPagoCliente()">
                        <i class="fas fa-money-check"></i> Registrar Pago
                    </button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Modal Anulaci√≥n -->
    <div class="modal" id="modalAnulacion">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Anular Venta</h3>
                <button class="modal-close" onclick="cerrarModal('modalAnulacion')">&times;</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label>N√∫mero de Factura *</label>
                    <input type="text" id="anulacionNumeroFactura" class="form-control" placeholder="Ej: 001-00012345" required>
                </div>
                <div class="form-group">
                    <label>Motivo de Anulaci√≥n *</label>
                    <select id="anulacionMotivo" class="form-control" required>
                        <option value="">Seleccionar motivo</option>
                        <option value="error_precio">Error en precio</option>
                        <option value="error_producto">Producto incorrecto</option>
                        <option value="devolucion">Devoluci√≥n del cliente</option>
                        <option value="error_sistema">Error del sistema</option>
                        <option value="otros">Otros</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Detalle del Motivo</label>
                    <textarea id="anulacionDetalle" class="form-control" rows="3" required></textarea>
                </div>
                <div class="form-group">
                    <label>
                        <input type="checkbox" id="anulacionDevolverStock" checked> Devolver productos al stock
                    </label>
                </div>
                <div class="alert alert-danger">
                    <i class="fas fa-exclamation-triangle"></i>
                    Advertencia: Esta acci√≥n no se puede deshacer. Se generar√° una nota de cr√©dito.
                </div>
                <div class="form-group">
                    <button class="btn btn-danger" onclick="procesarAnulacion()">
                        <i class="fas fa-ban"></i> Confirmar Anulaci√≥n
                    </button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Modal Arqueo de Caja -->
    <div class="modal" id="modalArqueoCaja">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Arqueo de Caja</h3>
                <button class="modal-close" onclick="cerrarModal('modalArqueoCaja')">&times;</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label>Fecha</label>
                    <input type="date" id="arqueoFecha" class="form-control" value="">
                </div>
                <div class="form-group">
                    <label>Efectivo en Caja (Seg√∫n Sistema)</label>
                    <input type="number" id="arqueoEfectivoSistema" class="form-control" readonly style="background: #f8fafc;">
                </div>
                <div class="form-group">
                    <label>Efectivo Contado F√≠sicamente *</label>
                    <input type="number" id="arqueoEfectivoFisico" class="form-control" step="0.01" required oninput="calcularDiferenciaArqueo()">
                </div>
                <div class="form-group">
                    <label>Diferencia</label>
                    <input type="number" id="arqueoDiferencia" class="form-control" readonly style="background: #f8fafc;">
                </div>
                <div class="form-group">
                    <label>Desglose por Denominaciones</label>
                    <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px; margin-top: 10px;">
                        <div><label>$1000 x <input type="number" id="denom1000" class="form-control" min="0" value="0" oninput="calcularDesglose()"> = $<span id="total1000">0.00</span></label></div>
                        <div><label>$500 x <input type="number" id="denom500" class="form-control" min="0" value="0" oninput="calcularDesglose()"> = $<span id="total500">0.00</span></label></div>
                        <div><label>$200 x <input type="number" id="denom200" class="form-control" min="0" value="0" oninput="calcularDesglose()"> = $<span id="total200">0.00</span></label></div>
                        <div><label>$100 x <input type="number" id="denom100" class="form-control" min="0" value="0" oninput="calcularDesglose()"> = $<span id="total100">0.00</span></label></div>
                        <div><label>$50 x <input type="number" id="denom50" class="form-control" min="0" value="0" oninput="calcularDesglose()"> = $<span id="total50">0.00</span></label></div>
                        <div><label>$20 x <input type="number" id="denom20" class="form-control" min="0" value="0" oninput="calcularDesglose()"> = $<span id="total20">0.00</span></label></div>
                        <div><label>$10 x <input type="number" id="denom10" class="form-control" min="0" value="0" oninput="calcularDesglose()"> = $<span id="total10">0.00</span></label></div>
                        <div><label>Monedas <input type="number" id="denomMonedas" class="form-control" step="0.01" min="0" value="0" oninput="calcularDesglose()"></label></div>
                    </div>
                    <div style="margin-top: 10px; font-weight: bold;">
                        Total Desglose: $<span id="totalDesglose">0.00</span>
                    </div>
                </div>
                <div class="form-group">
                    <label>Observaciones</label>
                    <textarea id="arqueoObservaciones" class="form-control" rows="3" placeholder="Observaciones del arqueo"></textarea>
                </div>
                <div class="form-group">
                    <button class="btn btn-primary" onclick="guardarArqueoCaja()">
                        <i class="fas fa-save"></i> Guardar Arqueo
                    </button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Modal Nuevo Proveedor -->
    <div class="modal" id="modalNuevoProveedor">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Nuevo Proveedor</h3>
                <button class="modal-close" onclick="cerrarModal('modalNuevoProveedor')">&times;</button>
            </div>
            <div class="modal-body">
                <form id="formNuevoProveedor">
                    <div class="form-group">
                        <label>Nombre/Raz√≥n Social *</label>
                        <input type="text" id="nuevoProveedorNombre" class="form-control" required>
                    </div>
                    <div class="form-group">
                        <label>CUIT</label>
                        <input type="text" id="nuevoProveedorCuit" class="form-control">
                    </div>
                    <div class="form-group">
                        <label>Contacto</label>
                        <input type="text" id="nuevoProveedorContacto" class="form-control">
                    </div>
                    <div class="form-group">
                        <label>Tel√©fono</label>
                        <input type="text" id="nuevoProveedorTelefono" class="form-control">
                    </div>
                    <div class="form-group">
                        <label>Email</label>
                        <input type="email" id="nuevoProveedorEmail" class="form-control">
                    </div>
                    <div class="form-group">
                        <label>Direcci√≥n</label>
                        <input type="text" id="nuevoProveedorDireccion" class="form-control">
                    </div>
                    <div class="form-group">
                        <label>Categor√≠a</label>
                        <select id="nuevoProveedorCategoria" class="form-control">
                            <option value="alimentos">Alimentos</option>
                            <option value="bebidas">Bebidas</option>
                            <option value="limpieza">Limpieza</option>
                            <option value="otros">Otros</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Plazo de Entrega (d√≠as)</label>
                        <input type="number" id="nuevoProveedorPlazoEntrega" class="form-control" min="1" value="7">
                    </div>
                    <div class="form-group">
                        <label>T√©rminos de Pago</label>
                        <select id="nuevoProveedorTerminosPago" class="form-control">
                            <option value="contado">Contado</option>
                            <option value="7dias">7 d√≠as</option>
                            <option value="15dias">15 d√≠as</option>
                            <option value="30dias">30 d√≠as</option>
                            <option value="60dias">60 d√≠as</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>
                            <input type="checkbox" id="nuevoProveedorActivo" checked> Activo
                        </label>
                    </div>
                    <div class="form-group">
                        <label>Notas</label>
                        <textarea id="nuevoProveedorNotas" class="form-control" rows="3" placeholder="Notas adicionales"></textarea>
                    </div>
                    <div class="form-group">
                        <button type="submit" class="btn btn-primary">
                            <i class="fas fa-save"></i> Guardar Proveedor
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
    
    <!-- Modal Nuevo Pedido -->
    <div class="modal" id="modalNuevoPedido">
        <div class="modal-content" style="max-width: 1000px;">
            <div class="modal-header">
                <h3>Nuevo Pedido a Proveedor</h3>
                <button class="modal-close" onclick="cerrarModal('modalNuevoPedido')">&times;</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label>Proveedor *</label>
                    <select id="pedidoProveedor" class="form-control" onchange="cargarProductosProveedor()" required>
                        <option value="">Seleccionar proveedor</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Fecha Estimada de Entrega</label>
                    <input type="date" id="pedidoFechaEntrega" class="form-control">
                </div>
                <div class="form-group">
                    <label>Notas</label>
                    <textarea id="pedidoNotas" class="form-control" rows="2" placeholder="Notas para el proveedor"></textarea>
                </div>
                
                <h4 style="margin-top: 30px; margin-bottom: 15px;">Productos del Pedido</h4>
                <div style="margin-bottom: 15px;">
                    <button class="btn btn-outline" onclick="agregarFilaPedido()">
                        <i class="fas fa-plus"></i> Agregar Producto
                    </button>
                    <button class="btn btn-outline" onclick="sugerirPedidoStockBajo()">
                        <i class="fas fa-lightbulb"></i> Sugerir por Stock Bajo
                    </button>
                </div>
                
                <div class="table-container">
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>Producto</th>
                                <th>Cantidad</th>
                                <th>Precio Unitario</th>
                                <th>Subtotal</th>
                                <th>Acciones</th>
                            </tr>
                        </thead>
                        <tbody id="tablaItemsPedido">
                            <tr id="filaPedidoTemplate" style="display: none;">
                                <td>
                                    <select class="form-control producto-pedido" onchange="actualizarPrecioPedido(this)">
                                        <option value="">Seleccionar producto</option>
                                    </select>
                                </td>
                                <td><input type="number" class="form-control cantidad-pedido" min="1" value="1" oninput="calcularSubtotalPedido(this)"></td>
                                <td><input type="number" class="form-control precio-pedido" step="0.01" min="0" oninput="calcularSubtotalPedido(this)"></td>
                                <td class="subtotal-pedido">$0.00</td>
                                <td><button type="button" class="btn btn-danger btn-sm" onclick="eliminarFilaPedido(this)"><i class="fas fa-trash"></i></button></td>
                            </tr>
                        </tbody>
                        <tfoot>
                            <tr>
                                <td colspan="3" style="text-align: right; font-weight: bold;">Total:</td>
                                <td style="font-weight: bold; font-size: 18px;" id="totalPedido">$0.00</td>
                                <td></td>
                            </tr>
                        </tfoot>
                    </table>
                </div>
                
                <div class="form-group" style="margin-top: 30px;">
                    <button class="btn btn-primary" onclick="guardarPedido()">
                        <i class="fas fa-save"></i> Guardar Pedido
                    </button>
                    <button class="btn btn-success" onclick="guardarYEnviarPedidoWhatsApp()" style="margin-left: 10px;">
                        <i class="fab fa-whatsapp"></i> Guardar y Enviar por WhatsApp
                    </button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Modal Notas -->
    <div class="modal" id="modalNotas">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Notas del Sistema</h3>
                <button class="modal-close" onclick="cerrarModal('modalNotas')">&times;</button>
            </div>
            <div class="modal-body">
                <div id="contenidoNotas"></div>
            </div>
        </div>
    </div>
    
    <!-- Scanner de C√≥digo de Barras -->
    <div class="barcode-scanner" id="barcodeScanner">
        <video class="barcode-video" id="barcodeVideo"></video>
        <div class="barcode-overlay"></div>
        <button class="btn btn-danger" style="position: absolute; bottom: 20px; left: 50%; transform: translateX(-50%);" onclick="cerrarScanner()">
            <i class="fas fa-times"></i> Cerrar Scanner
        </button>
    </div>
    
    <!-- Modo Emergencia -->
    <div class="emergency-mode" id="emergencyMode">
        <div class="emergency-icon">
            <i class="fas fa-exclamation-triangle"></i>
        </div>
        <h2>Modo Emergencia Activado</h2>
        <p>No hay conexi√≥n a internet. Trabajando con datos locales.</p>
        <p><strong>Ventas pendientes:</strong> <span id="pendingSalesCount">0</span></p>
        
        <div class="emergency-actions">
            <button class="btn btn-primary" onclick="continuarSinConexion()">
                <i class="fas fa-play"></i> Continuar
            </button>
            <button class="btn btn-outline" onclick="verVentasPendientes()">
                <i class="fas fa-list"></i> Ver Pendientes
            </button>
        </div>
    </div>
    
    <!-- Ticket de Venta (oculto para impresi√≥n) -->
    <div id="ticketContainer" style="display: none;"></div>
    
    <!-- File input oculto para importaciones -->
    <input type="file" id="fileBackupImport" style="display: none;" accept=".json,.zip">
    
    <script>
        // ============================================
        // CONFIGURACI√ìN PRINCIPAL Y VARIABLES GLOBALES
        // ============================================
        
        // Firebase configuration
        const firebaseConfig = JSON.parse(localStorage.getItem('firebase_config')) || {
            apiKey: "AIzaSyCtOiUy2tUQeixUiJxTdI_ESULY4WpqXzw",
            authDomain: "whatsappau-30dc1.firebaseapp.com",
            projectId: "whatsappau-30dc1",
            storageBucket: "whatsappau-30dc1.firebasestorage.app",
            messagingSenderId: "456068013185",
            appId: "1:456068013185:web:5bdd49337fb622e56f0180"
        };
        
        // Inicializar Firebase
        const app = firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();
        
        // Variables globales del sistema
        let usuarioActual = null;
        let sucursalActual = null;
        let turnoActual = null;
        let carrito = [];
        let productosCache = new Map();
        let clientesCache = new Map();
        let proveedoresCache = new Map();
        let modoEmergencia = false;
        let ventasPendientes = [];
        let ultimaVenta = null;
        let configuracionSistema = {};
        let listenersActivos = [];
        
        // Configuraci√≥n IndexedDB para modo offline
        const DB_NAME = 'pos_offline_db';
        const DB_VERSION = 2;
        let offlineDB = null;
        
        // Constantes del sistema
        const IVA_PORCENTAJE = 0.21;
        const LIMITE_PRODUCTOS_PAGINA = 50;
        const LIMITE_VENTAS_PAGINA = 30;
        const ROLES = {
            ADMIN: 'admin',
            VENDEDOR: 'vendedor',
            CAJERO: 'cajero',
            SUPERVISOR: 'supervisor'
        };
        
        // ============================================
        // INICIALIZACI√ìN DEL SISTEMA
        // ============================================
        
        document.addEventListener('DOMContentLoaded', async function() {
            // Inicializar IndexedDB
            await initIndexedDB();
            
            // Cargar configuraci√≥n local
            await cargarConfiguracionLocal();
            
            // Verificar estado de conexi√≥n
            initConnectionMonitor();
            
            // Configurar eventos de autenticaci√≥n
            auth.onAuthStateChanged(async (user) => {
                if (user) {
                    await iniciarSistema(user);
                } else {
                    mostrarLogin();
                }
            });
            
            // Configurar navegaci√≥n del sidebar
            document.querySelectorAll('.menu-item').forEach(item => {
                item.addEventListener('click', function(e) {
                    e.preventDefault();
                    const viewId = this.getAttribute('data-view');
                    cambiarVista(viewId);
                });
            });
            
            // Configurar toggle del men√∫ en m√≥viles
            document.getElementById('menuToggle').addEventListener('click', function() {
                document.getElementById('sidebar').classList.toggle('active');
            });
            
            // Configurar cierre de sesi√≥n por inactividad (30 minutos)
            setupInactivityTimer(30 * 60 * 1000);
            
            // Configurar formularios
            configurarFormularios();
            
            // Inicializar listeners de tiempo real
            inicializarListenersTiempoReal();
            
            // Configurar eventos de PWA
            if ('serviceWorker' in navigator) {
                window.addEventListener('load', function() {
                    navigator.serviceWorker.register('/sw.js').then(function(registration) {
                        console.log('ServiceWorker registration successful with scope: ', registration.scope);
                    }, function(err) {
                        console.log('ServiceWorker registration failed: ', err);
                    });
                });
            }
            
            // Configurar eventos antes de recargar/cerrar p√°gina
            window.addEventListener('beforeunload', function (e) {
                if (carrito.length > 0 || modoEmergencia) {
                    e.preventDefault();
                    e.returnValue = '';
                    guardarCarritoLocal();
                    guardarEstadoSistema();
                }
            });
            
            console.log('Sistema POS inicializado correctamente');
        });
        
        // ============================================
        // FUNCIONES PRINCIPALES DEL SISTEMA
        // ============================================
        
        // 1. Sistema de Autenticaci√≥n y Usuarios
        async function iniciarSistema(user) {
            try {
                usuarioActual = user;
                
                // Obtener datos del usuario desde Firestore
                const userDoc = await db.collection('usuarios').doc(user.uid).get();
                if (userDoc.exists) {
                    const userData = userDoc.data();
                    document.getElementById('userName').textContent = userData.nombre || user.email;
                    document.getElementById('userRole').textContent = userData.rol || 'Usuario';
                    document.getElementById('userAvatar').textContent = (userData.nombre || user.email).charAt(0).toUpperCase();
                    
                    // Cargar configuraci√≥n del sistema
                    await cargarConfiguracionSistema();
                    
                    // Obtener sucursal
                    if (userData.sucursalId) {
                        const sucursalDoc = await db.collection('sucursales').doc(userData.sucursalId).get();
                        if (sucursalDoc.exists) {
                            sucursalActual = {
                                id: sucursalDoc.id,
                                data: () => sucursalDoc.data()
                            };
                            document.getElementById('sucursalNombre').textContent = sucursalDoc.data().nombre || 'Sin sucursal';
                        }
                    }
                    
                    // Verificar turno activo
                    await verificarTurnoActivo();
                    
                    // Cargar datos iniciales
                    await cargarDatosIniciales();
                    
                    // Actualizar contadores
                    actualizarContadores();
                    
                } else {
                    // Si no existe documento, crear uno b√°sico
                    await db.collection('usuarios').doc(user.uid).set({
                        email: user.email,
                        nombre: user.email.split('@')[0],
                        rol: ROLES.VENDEDOR,
                        fechaRegistro: new Date(),
                        estado: 'activo',
                        sucursalId: null
                    });
                    
                    document.getElementById('userName').textContent = user.email;
                    document.getElementById('userRole').textContent = 'Vendedor';
                    document.getElementById('userAvatar').textContent = user.email.charAt(0).toUpperCase();
                    document.getElementById('sucursalNombre').textContent = 'Sin sucursal asignada';
                }
            } catch (error) {
                console.error('Error al iniciar sistema:', error);
                mostrarError('Error al cargar datos del usuario');
            }
        }
        
        async function cargarDatosIniciales() {
            try {
                // Cargar productos en cache
                await cargarProductosCache();
                
                // Cargar clientes
                await cargarClientesCache();
                
                // Cargar proveedores
                await cargarProveedoresCache();
                
                // Cargar categor√≠as
                await cargarCategoriasCache();
                
                // Actualizar UI
                cargarProductosEnVista();
                cargarClientesEnSelect();
                cargarProveedoresEnSelect();
                cargarCategoriasEnSelect();
                
                // Cargar carrito al iniciar
                cargarCarritoLocal();
                
            } catch (error) {
                console.error('Error cargando datos iniciales:', error);
            }
        }
        
        // 2. Gesti√≥n de Turnos y Caja
        async function verificarTurnoActivo() {
            try {
                if (!sucursalActual) {
                    console.warn('No hay sucursal configurada');
                    return;
                }
                
                const turnosRef = db.collection('turnos')
                    .where('sucursalId', '==', sucursalActual.id)
                    .where('estado', '==', 'abierto')
                    .where('usuarioId', '==', usuarioActual.uid)
                    .limit(1);
                
                const snapshot = await turnosRef.get();
                
                if (snapshot.empty) {
                    // No hay turno activo
                    document.getElementById('turnoActual').textContent = 'Sin turno activo';
                    document.getElementById('btnAbrirTurno').disabled = false;
                    document.getElementById('btnCerrarTurno').disabled = true;
                    actualizarInfoTurno(null);
                } else {
                    turnoActual = snapshot.docs[0];
                    const turnoData = turnoActual.data();
                    document.getElementById('turnoActual').textContent = 
                        `Turno ${turnoData.tipo} - ${formatFecha(turnoData.apertura)}`;
                    document.getElementById('btnAbrirTurno').disabled = true;
                    document.getElementById('btnCerrarTurno').disabled = false;
                    actualizarInfoTurno(turnoData);
                    
                    // Cargar resumen del turno
                    await cargarResumenTurno(turnoActual.id);
                }
            } catch (error) {
                console.error('Error verificando turno:', error);
            }
        }
        
        async function abrirTurno() {
            try {
                // Verificar si ya hay un turno abierto en esta caja
                const turnoExistente = await db.collection('turnos')
                    .where('sucursalId', '==', sucursalActual.id)
                    .where('caja', '==', configuracionSistema.caja || '1')
                    .where('estado', '==', 'abierto')
                    .limit(1)
                    .get();
                
                if (!turnoExistente.empty) {
                    mostrarError('Ya hay un turno abierto en esta caja');
                    return;
                }
                
                const efectivoInicial = prompt('Ingrese efectivo inicial en caja:', '0');
                if (efectivoInicial === null) return;
                
                const tipoTurno = new Date().getHours() < 14 ? 'ma√±ana' : 'tarde';
                
                const turnoData = {
                    sucursalId: sucursalActual.id,
                    sucursalNombre: sucursalActual.data().nombre,
                    usuarioId: usuarioActual.uid,
                    usuarioNombre: usuarioActual.displayName || usuarioActual.email,
                    fecha: new Date(),
                    tipo: tipoTurno,
                    caja: configuracionSistema.caja || '1',
                    apertura: new Date(),
                    cierre: null,
                    estado: 'abierto',
                    ventasCount: 0,
                    totalVentas: 0,
                    efectivoInicial: parseFloat(efectivoInicial),
                    efectivoFinal: 0,
                    desglosePagos: {},
                    observaciones: '',
                    diferenciaCaja: 0
                };
                
                const turnoRef = await db.collection('turnos').add(turnoData);
                turnoActual = await turnoRef.get();
                
                // Actualizar interfaz
                document.getElementById('turnoActual').textContent = 
                    `Turno ${tipoTurno} - ${formatFecha(turnoData.apertura)}`;
                document.getElementById('btnAbrirTurno').disabled = true;
                document.getElementById('btnCerrarTurno').disabled = false;
                
                actualizarInfoTurno(turnoData);
                
                mostrarExito('Turno abierto correctamente');
                
                // Cargar resumen del turno
                await cargarResumenTurno(turnoRef.id);
                
            } catch (error) {
                console.error('Error abriendo turno:', error);
                mostrarError('Error al abrir turno: ' + error.message);
            }
        }
        
        async function cerrarTurno() {
            if (!turnoActual) {
                mostrarError('No hay turno activo');
                return;
            }
            
            const efectivoFinal = prompt('Ingrese efectivo final en caja:', '0');
            if (efectivoFinal === null) return;
            
            try {
                // Obtener ventas del turno para desglose
                const ventasTurno = await db.collection('ventas')
                    .where('turnoId', '==', turnoActual.id)
                    .where('anulada', '==', false)
                    .where('estado', '==', 'completada')
                    .get();
                
                let desglose = {};
                let totalVentas = 0;
                
                ventasTurno.forEach(doc => {
                    const venta = doc.data();
                    totalVentas += venta.total;
                    
                    if (!desglose[venta.metodoPago]) {
                        desglose[venta.metodoPago] = 0;
                    }
                    desglose[venta.metodoPago] += venta.total;
                });
                
                // Calcular diferencia de caja
                const efectivoInicial = turnoActual.data().efectivoInicial || 0;
                const ventasEfectivo = desglose.efectivo || 0;
                const diferencia = parseFloat(efectivoFinal) - (efectivoInicial + ventasEfectivo);
                
                await db.collection('turnos').doc(turnoActual.id).update({
                    cierre: new Date(),
                    estado: 'cerrado',
                    efectivoFinal: parseFloat(efectivoFinal),
                    desglosePagos: desglose,
                    totalVentas: totalVentas,
                    ventasCount: ventasTurno.size,
                    diferenciaCaja: diferencia,
                    observaciones: `Cierre normal - Diferencia: $${diferencia.toFixed(2)}`
                });
                
                // Limpiar turno actual
                turnoActual = null;
                document.getElementById('turnoActual').textContent = 'Sin turno activo';
                document.getElementById('btnAbrirTurno').disabled = false;
                document.getElementById('btnCerrarTurno').disabled = true;
                
                actualizarInfoTurno(null);
                
                mostrarExito('Turno cerrado correctamente');
                
                // Recargar historial de turnos
                if (document.getElementById('cajaView').classList.contains('active')) {
                    await cargarHistorialTurnos();
                }
                
            } catch (error) {
                console.error('Error cerrando turno:', error);
                mostrarError('Error al cerrar turno: ' + error.message);
            }
        }
        
        // 3. Sistema POS - Carrito y Ventas
        function agregarAlCarrito(producto) {
            // Verificar stock
            if (producto.controlStock && producto.stock <= 0) {
                mostrarError('Producto sin stock disponible');
                return;
            }
            
            // Verificar si ya est√° en el carrito
            const index = carrito.findIndex(item => item.id === producto.id);
            
            if (index !== -1) {
                // Verificar stock para cantidad adicional
                if (producto.controlStock && (producto.stock < carrito[index].cantidad + 1)) {
                    mostrarError(`Stock insuficiente. Solo quedan ${producto.stock} unidades.`);
                    return;
                }
                
                // Incrementar cantidad
                carrito[index].cantidad += 1;
                carrito[index].subtotal = carrito[index].cantidad * carrito[index].precioVenta;
            } else {
                // Agregar nuevo item
                carrito.push({
                    id: producto.id,
                    codigo: producto.codigo,
                    nombre: producto.nombre,
                    precioVenta: producto.precioVenta,
                    precioCosto: producto.precioCosto,
                    cantidad: 1,
                    descuento: 0,
                    descuentoPorcentaje: 0,
                    subtotal: producto.precioVenta,
                    stock: producto.stock,
                    controlStock: producto.controlStock,
                    congelado: false,
                    impuestos: producto.impuestos || 0
                });
            }
            
            actualizarCarrito();
            guardarCarritoLocal();
        }
        
        function actualizarCarrito() {
            const carritoItems = document.getElementById('carritoItems');
            const subtotalElement = document.getElementById('subtotal');
            const descuentoTotalElement = document.getElementById('descuentoTotal');
            const totalElement = document.getElementById('total');
            const carritoCount = document.getElementById('carritoCount');
            
            // Limpiar carrito
            carritoItems.innerHTML = '';
            
            let subtotal = 0;
            let descuentoTotal = 0;
            
            // Generar items del carrito
            carrito.forEach((item, index) => {
                const itemTotal = item.cantidad * item.precioVenta;
                const itemDescuento = item.descuento;
                const itemSubtotal = itemTotal - itemDescuento;
                
                subtotal += itemSubtotal;
                descuentoTotal += itemDescuento;
                
                const itemHTML = `
                    <div class="carrito-item">
                        <div class="carrito-item-info">
                            <div class="carrito-item-nombre">${item.nombre}</div>
                            <div class="carrito-item-precio">$${item.precioVenta.toFixed(2)} c/u</div>
                            <small style="color: var(--gray);">${item.codigo}</small>
                            ${item.congelado ? '<small style="color: var(--warning);"><i class="fas fa-snowflake"></i> Precio congelado</small>' : ''}
                        </div>
                        <div class="carrito-item-cantidad">
                            <button class="cantidad-btn" onclick="modificarCantidad(${index}, -1)">
                                <i class="fas fa-minus"></i>
                            </button>
                            <span style="min-width: 30px; text-align: center;">${item.cantidad}</span>
                            <button class="cantidad-btn" onclick="modificarCantidad(${index}, 1)">
                                <i class="fas fa-plus"></i>
                            </button>
                        </div>
                        <div style="min-width: 120px; text-align: right;">
                            <div style="font-weight: bold;">$${itemSubtotal.toFixed(2)}</div>
                            ${itemDescuento > 0 ? 
                                `<small style="color: var(--danger);">-$${itemDescuento.toFixed(2)} (${item.descuentoPorcentaje}%)</small>` : ''}
                        </div>
                        <div style="margin-left: 12px;">
                            <input type="number" value="${item.descuentoPorcentaje}" min="0" max="100" 
                                   style="width: 60px; text-align: center; border: 1px solid #ddd; border-radius: 4px;"
                                   onchange="aplicarDescuentoItem(${index}, this.value)">
                            <small>%</small>
                        </div>
                        <button class="cantidad-btn" onclick="eliminarDelCarrito(${index})" 
                                style="margin-left: 12px; background: #fee2e2; color: var(--danger);">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                `;
                
                carritoItems.innerHTML += itemHTML;
            });
            
            // Aplicar descuento global si existe
            const descuentoGlobal = parseFloat(document.getElementById('descuentoGlobal').value) || 0;
            if (descuentoGlobal > 0) {
                const descuentoGlobalMonto = (subtotal * descuentoGlobal) / 100;
                descuentoTotal += descuentoGlobalMonto;
                subtotal -= descuentoGlobalMonto;
            }
            
            // Calcular impuestos (IVA)
            const iva = subtotal * IVA_PORCENTAJE;
            const total = subtotal + iva;
            
            // Actualizar UI
            subtotalElement.textContent = `$${subtotal.toFixed(2)}`;
            descuentoTotalElement.textContent = `$${descuentoTotal.toFixed(2)}`;
            document.getElementById('iva').textContent = `$${iva.toFixed(2)}`;
            totalElement.textContent = `$${total.toFixed(2)}`;
            carritoCount.textContent = `(${carrito.length} items)`;
            
            // Actualizar cambio si hay monto recibido
            calcularCambio();
            
            // Actualizar pago mixto si est√° activo
            if (document.getElementById('selectPago').value === 'mixto') {
                calcularMixto();
            }
        }
        
        // 4. Procesamiento de Ventas con Transacciones
        async function procesarVenta() {
            if (carrito.length === 0) {
                mostrarError('El carrito est√° vac√≠o');
                return;
            }
            
            // Validar turno activo
            if (!turnoActual) {
                mostrarError('No hay turno activo. Abre un turno primero.');
                return;
            }
            
            // Calcular totales
            const subtotal = carrito.reduce((sum, item) => sum + (item.cantidad * item.precioVenta - item.descuento), 0);
            const descuentoGlobal = parseFloat(document.getElementById('descuentoGlobal').value) || 0;
            const descuentoGlobalMonto = (subtotal * descuentoGlobal) / 100;
            const subtotalConDescuento = subtotal - descuentoGlobalMonto;
            const iva = subtotalConDescuento * IVA_PORCENTAJE;
            const total = subtotalConDescuento + iva;
            
            // Obtener datos del cliente
            const clienteSelect = document.getElementById('selectCliente');
            const clienteId = clienteSelect.value;
            let clienteData = null;
            let clienteNombre = 'Consumidor Final';
            
            if (clienteId) {
                clienteData = clientesCache.get(clienteId);
                clienteNombre = clienteData ? clienteData.nombre : clienteSelect.options[clienteSelect.selectedIndex].text;
            }
            
            // Obtener m√©todo de pago
            const metodoPago = document.getElementById('selectPago').value;
            
            // Validar pago seg√∫n m√©todo
            let validacionPago = validarPago(metodoPago, total);
            if (!validacionPago.valido) {
                mostrarError(validacionPago.mensaje);
                return;
            }
            
            // Validar l√≠mite de cr√©dito si es cuenta corriente
            if (metodoPago === 'cuenta_corriente' && clienteData) {
                const limiteCredito = clienteData.limiteCredito || 0;
                const saldoActual = clienteData.saldo || 0;
                const nuevoSaldo = saldoActual + total;
                
                if (limiteCredito > 0 && nuevoSaldo > limiteCredito) {
                    mostrarError(`L√≠mite de cr√©dito excedido. L√≠mite: $${limiteCredito.toFixed(2)}, Saldo actual: $${saldoActual.toFixed(2)}`);
                    return;
                }
            }
            
            // Confirmar venta
            if (!confirm(`¬øConfirmar venta por $${total.toFixed(2)}?`)) {
                return;
            }
            
            try {
                // Iniciar transacci√≥n
                const resultado = await db.runTransaction(async (transaction) => {
                    // Generar n√∫mero de factura
                    const numeroFactura = await generarNumeroFacturaTransaccion(transaction);
                    
                    // Verificar stock antes de proceder
                    for (const item of carrito) {
                        if (item.controlStock) {
                            const productoRef = db.collection('productos').doc(item.id);
                            const productoDoc = await transaction.get(productoRef);
                            
                            if (productoDoc.exists) {
                                const productoData = productoDoc.data();
                                const stockActual = productoData.stock || 0;
                                
                                if (stockActual < item.cantidad) {
                                    throw new Error(`Stock insuficiente para ${item.nombre}. Stock actual: ${stockActual}`);
                                }
                            }
                        }
                    }
                    
                    // Crear objeto de venta
                    const ventaData = {
                        sucursalId: sucursalActual.id,
                        sucursalNombre: sucursalActual.data().nombre,
                        numeroFactura: numeroFactura,
                        fecha: new Date(),
                        clienteId: clienteId || null,
                        clienteNombre: clienteNombre,
                        clienteDocumento: clienteData ? clienteData.documento : null,
                        subtotal: subtotal,
                        descuentoGlobal: descuentoGlobalMonto,
                        descuentoItems: carrito.reduce((sum, item) => sum + item.descuento, 0),
                        descuentoTotal: descuentoGlobalMonto + carrito.reduce((sum, item) => sum + item.descuento, 0),
                        iva: iva,
                        total: total,
                        metodoPago: metodoPago,
                        datosPago: obtenerDatosPago(metodoPago),
                        items: carrito.map(item => ({
                            productoId: item.id,
                            codigo: item.codigo,
                            nombre: item.nombre,
                            cantidad: item.cantidad,
                            precioUnitario: item.precioVenta,
                            descuento: item.descuento,
                            descuentoPorcentaje: item.descuentoPorcentaje,
                            subtotal: item.cantidad * item.precioVenta - item.descuento,
                            costo: item.precioCosto,
                            controlStock: item.controlStock
                        })),
                        usuarioId: usuarioActual.uid,
                        usuarioNombre: usuarioActual.displayName || usuarioActual.email,
                        turnoId: turnoActual.id,
                        nota: document.getElementById('notaVenta').value,
                        estado: 'completada',
                        syncStatus: 'synced',
                        anulada: false,
                        fechaAnulacion: null,
                        reimpresiones: 0,
                        caja: configuracionSistema.caja || '1'
                    };
                    
                    // Guardar venta
                    const ventaRef = db.collection('ventas').doc();
                    transaction.set(ventaRef, ventaData);
                    
                    // Actualizar stock de productos
                    for (const item of carrito) {
                        if (item.controlStock) {
                            const productoRef = db.collection('productos').doc(item.id);
                            transaction.update(productoRef, {
                                stock: firebase.firestore.FieldValue.increment(-item.cantidad),
                                ultimaVenta: new Date(),
                                vendidosTotal: firebase.firestore.FieldValue.increment(item.cantidad)
                            });
                        }
                    }
                    
                    // Actualizar turno
                    const turnoRef = db.collection('turnos').doc(turnoActual.id);
                    transaction.update(turnoRef, {
                        ventasCount: firebase.firestore.FieldValue.increment(1),
                        totalVentas: firebase.firestore.FieldValue.increment(total),
                        [`desglosePagos.${metodoPago}`]: firebase.firestore.FieldValue.increment(total)
                    });
                    
                    // Actualizar saldo del cliente si es cuenta corriente
                    if (metodoPago === 'cuenta_corriente' && clienteId) {
                        const clienteRef = db.collection('clientes').doc(clienteId);
                        transaction.update(clienteRef, {
                            saldo: firebase.firestore.FieldValue.increment(total),
                            ultimaCompra: new Date(),
                            comprasTotal: firebase.firestore.FieldValue.increment(1)
                        });
                    }
                    
                    // Actualizar contadores
                    await actualizarContadoresTransaccion(transaction);
                    
                    return {
                        ventaId: ventaRef.id,
                        ventaData: ventaData
                    };
                });
                
                // Guardar √∫ltima venta
                ultimaVenta = {
                    id: resultado.ventaId,
                    ...resultado.ventaData
                };
                
                // Imprimir ticket
                await imprimirTicket(ultimaVenta);
                
                // Limpiar carrito
                carrito = [];
                document.getElementById('descuentoGlobal').value = '0';
                document.getElementById('notaVenta').value = '';
                document.getElementById('montoRecibido').value = '';
                document.getElementById('cambio').value = '';
                actualizarCarrito();
                
                // Limpiar m√©todo de pago mixto
                if (document.getElementById('selectPago').value === 'mixto') {
                    document.getElementById('mixtoEfectivo').value = '';
                    document.getElementById('mixtoTarjeta').value = '';
                    document.getElementById('mixtoTransferencia').value = '';
                    document.getElementById('mixtoQR').value = '';
                    document.getElementById('totalMixto').value = '';
                }
                
                // Mostrar confirmaci√≥n
                mostrarExito(`Venta #${ultimaVenta.numeroFactura} procesada correctamente`);
                
                // Actualizar resumen del turno
                if (turnoActual) {
                    await cargarResumenTurno(turnoActual.id);
                }
                
                // Sincronizar si estaba en modo offline
                if (modoEmergencia) {
                    await intentarSincronizar();
                }
                
            } catch (error) {
                console.error('Error procesando venta:', error);
                mostrarError('Error al procesar la venta: ' + error.message);
            }
        }
        
        async function generarNumeroFacturaTransaccion(transaction) {
            // Obtener prefijo de sucursal
            const sucursalPrefijo = sucursalActual.data().codigo || '001';
            
            // Obtener contador de facturas
            const contadorRef = db.collection('contadores_facturas').doc(`sucursal_${sucursalActual.id}`);
            const contadorDoc = await transaction.get(contadorRef);
            
            let proximoNumero = 1;
            
            if (contadorDoc.exists) {
                const contadorData = contadorDoc.data();
                proximoNumero = (contadorData.proximo || 0) + 1;
                transaction.update(contadorRef, { proximo: proximoNumero });
            } else {
                transaction.set(contadorRef, { proximo: 1 });
            }
            
            // Formato: PuntoVenta-N√∫mero (ej: 0001-00000001)
            const puntoVenta = configuracionSistema.puntoVenta || '0001';
            const numeroFactura = proximoNumero.toString().padStart(8, '0');
            
            return `${puntoVenta}-${numeroFactura}`;
        }
        
        // 5. Sistema Offline con IndexedDB
        async function initIndexedDB() {
            return new Promise((resolve, reject) => {
                const request = indexedDB.open(DB_NAME, DB_VERSION);
                
                request.onerror = () => reject(request.error);
                request.onsuccess = () => {
                    offlineDB = request.result;
                    resolve();
                };
                
                request.onupgradeneeded = (event) => {
                    const db = event.target.result;
                    
                    // Crear object stores
                    if (!db.objectStoreNames.contains('ventas_pendientes')) {
                        const ventasStore = db.createObjectStore('ventas_pendientes', { keyPath: 'id' });
                        ventasStore.createIndex('fecha', 'fecha', { unique: false });
                        ventasStore.createIndex('syncStatus', 'syncStatus', { unique: false });
                    }
                    
                    if (!db.objectStoreNames.contains('productos_cache')) {
                        const productosStore = db.createObjectStore('productos_cache', { keyPath: 'id' });
                        productosStore.createIndex('codigo', 'codigo', { unique: true });
                        productosStore.createIndex('categoria', 'categoria', { unique: false });
                    }
                    
                    if (!db.objectStoreNames.contains('clientes_cache')) {
                        const clientesStore = db.createObjectStore('clientes_cache', { keyPath: 'id' });
                        clientesStore.createIndex('documento', 'documento', { unique: true });
                    }
                    
                    if (!db.objectStoreNames.contains('proveedores_cache')) {
                        db.createObjectStore('proveedores_cache', { keyPath: 'id' });
                    }
                    
                    if (!db.objectStoreNames.contains('config_local')) {
                        db.createObjectStore('config_local', { keyPath: 'key' });
                    }
                    
                    if (!db.objectStoreNames.contains('backups')) {
                        const backupsStore = db.createObjectStore('backups', { keyPath: 'id' });
                        backupsStore.createIndex('fecha', 'fecha', { unique: false });
                    }
                };
            });
        }
        
        async function guardarVentaOffline(ventaData) {
            return new Promise((resolve, reject) => {
                const transaction = offlineDB.transaction(['ventas_pendientes'], 'readwrite');
                const store = transaction.objectStore('ventas_pendientes');
                const request = store.add(ventaData);
                
                request.onsuccess = () => resolve();
                request.onerror = () => reject(request.error);
            });
        }
        
        async function intentarSincronizar() {
            if (modoEmergencia) return;
            
            try {
                const ventasPendientes = await obtenerVentasPendientes();
                
                for (const venta of ventasPendientes) {
                    // Verificar si la venta ya existe online (por n√∫mero de factura)
                    const ventaExistente = await db.collection('ventas')
                        .where('numeroFactura', '==', venta.numeroFactura)
                        .where('sucursalId', '==', venta.sucursalId)
                        .limit(1)
                        .get();
                    
                    if (!ventaExistente.empty) {
                        // Venta ya existe, eliminar del offline
                        await eliminarVentaOffline(venta.id);
                        continue;
                    }
                    
                    // Intentar subir a Firestore
                    try {
                        const { id, syncStatus, ...ventaData } = venta;
                        
                        // Verificar stock antes de subir
                        let stockValido = true;
                        for (const item of ventaData.items) {
                            if (item.controlStock) {
                                const productoDoc = await db.collection('productos').doc(item.productoId).get();
                                if (productoDoc.exists) {
                                    const productoData = productoDoc.data();
                                    if ((productoData.stock || 0) < item.cantidad) {
                                        stockValido = false;
                                        console.warn(`Stock insuficiente para ${item.nombre}`);
                                        break;
                                    }
                                }
                            }
                        }
                        
                        if (!stockValido) {
                            ventaData.estado = 'pendiente_revision';
                            ventaData.error = 'stock_insuficiente';
                        }
                        
                        const ventaRef = await db.collection('ventas').add(ventaData);
                        
                        // Actualizar stock si la venta es v√°lida
                        if (stockValido) {
                            for (const item of ventaData.items) {
                                if (item.controlStock) {
                                    await db.collection('productos').doc(item.productoId).update({
                                        stock: firebase.firestore.FieldValue.increment(-item.cantidad),
                                        vendidosTotal: firebase.firestore.FieldValue.increment(item.cantidad)
                                    });
                                }
                            }
                            
                            // Actualizar turno si existe
                            if (ventaData.turnoId) {
                                await db.collection('turnos').doc(ventaData.turnoId).update({
                                    ventasCount: firebase.firestore.FieldValue.increment(1),
                                    totalVentas: firebase.firestore.FieldValue.increment(ventaData.total),
                                    [`desglosePagos.${ventaData.metodoPago}`]: firebase.firestore.FieldValue.increment(ventaData.total)
                                });
                            }
                            
                            // Eliminar del almacenamiento local
                            await eliminarVentaOffline(id);
                            
                            console.log(`Venta ${id} sincronizada correctamente`);
                        }
                        
                    } catch (error) {
                        console.error(`Error sincronizando venta ${venta.id}:`, error);
                        // Marcar venta con error pero mantener en local
                        await actualizarVentaOffline(venta.id, { 
                            syncStatus: 'error',
                            error: error.message 
                        });
                    }
                }
                
                // Actualizar contador de ventas pendientes
                const ventasRestantes = await obtenerVentasPendientes();
                document.getElementById('pendingSalesCount').textContent = ventasRestantes.length;
                
                if (ventasPendientes.length > 0) {
                    mostrarExito(`${ventasPendientes.length} ventas sincronizadas`);
                }
                
            } catch (error) {
                console.error('Error en sincronizaci√≥n:', error);
            }
        }
        
        // 6. Gesti√≥n de Productos Avanzada
        async function cargarProductosCache() {
            try {
                if (!sucursalActual) {
                    console.warn('No hay sucursal para cargar productos');
                    return;
                }
                
                // Intentar cargar desde Firestore
                const snapshot = await db.collection('productos')
                    .where('sucursalId', '==', sucursalActual.id)
                    .where('estado', '==', 'activo')
                    .orderBy('nombre')
                    .limit(500) // Aumentado para manejar m√°s productos
                    .get();
                
                productosCache.clear();
                snapshot.forEach(doc => {
                    productosCache.set(doc.id, { id: doc.id, ...doc.data() });
                });
                
                // Guardar en IndexedDB para offline
                await guardarProductosCacheLocal();
                
                // Actualizar contador
                actualizarContadores();
                
            } catch (error) {
                console.error('Error cargando productos:', error);
                // Intentar cargar desde cache local
                await cargarProductosCacheLocal();
            }
        }
        
        async function importarProductosDesdeExcel(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                
                reader.onload = async function(e) {
                    try {
                        const data = new Uint8Array(e.target.result);
                        const workbook = XLSX.read(data, { type: 'array' });
                        const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
                        const jsonData = XLSX.utils.sheet_to_json(firstSheet);
                        
                        let productosImportados = 0;
                        let productosActualizados = 0;
                        let errores = [];
                        
                        for (const row of jsonData) {
                            try {
                                const productoData = {
                                    codigo: row.Codigo || row.codigo || '',
                                    nombre: row.Nombre || row.nombre || '',
                                    descripcion: row.Descripcion || row.descripcion || '',
                                    categoria: row.Categoria || row.categoria || 'General',
                                    precioCosto: parseFloat(row['Precio Costo'] || row.precioCosto || 0),
                                    precioVenta: parseFloat(row['Precio Venta'] || row.precioVenta || 0),
                                    stock: parseInt(row.Stock || row.stock || 0),
                                    stockMinimo: parseInt(row['Stock Minimo'] || row.stockMinimo || 5),
                                    controlStock: true,
                                    sucursalId: sucursalActual.id,
                                    fechaRegistro: new Date(),
                                    estado: 'activo',
                                    proveedorId: document.getElementById('importarProductosProveedor').value || null
                                };
                                
                                // Validar datos m√≠nimos
                                if (!productoData.nombre || !productoData.codigo) {
                                    errores.push(`Fila ${productosImportados + 1}: Nombre y c√≥digo son requeridos`);
                                    continue;
                                }
                                
                                // Buscar si ya existe el producto
                                let productoExistente = null;
                                for (let prod of productosCache.values()) {
                                    if (prod.codigo === productoData.codigo) {
                                        productoExistente = prod;
                                        break;
                                    }
                                }
                                
                                if (productoExistente && document.getElementById('importarSobrescribir').checked) {
                                    // Actualizar producto existente
                                    await db.collection('productos').doc(productoExistente.id).update(productoData);
                                    productosActualizados++;
                                } else if (!productoExistente) {
                                    // Crear nuevo producto
                                    await db.collection('productos').add(productoData);
                                    productosImportados++;
                                }
                                
                            } catch (error) {
                                errores.push(`Fila ${productosImportados + 1}: ${error.message}`);
                            }
                        }
                        
                        // Recargar cache
                        await cargarProductosCache();
                        
                        resolve({
                            importados: productosImportados,
                            actualizados: productosActualizados,
                            errores: errores
                        });
                        
                    } catch (error) {
                        reject(error);
                    }
                };
                
                reader.onerror = reject;
                reader.readAsArrayBuffer(file);
            });
        }
        
        // 7. Gesti√≥n de Clientes y Cuenta Corriente
        async function cargarClientesCache() {
            try {
                if (!sucursalActual) return;
                
                // Intentar cargar desde Firestore
                const snapshot = await db.collection('clientes')
                    .where('sucursalId', '==', sucursalActual.id)
                    .where('estado', '==', 'activo')
                    .orderBy('nombre')
                    .limit(300)
                    .get();
                
                clientesCache.clear();
                snapshot.forEach(doc => {
                    clientesCache.set(doc.id, { id: doc.id, ...doc.data() });
                });
                
                // Guardar en IndexedDB para offline
                await guardarClientesCacheLocal();
                
            } catch (error) {
                console.error('Error cargando clientes:', error);
                // Intentar cargar desde cache local
                await cargarClientesCacheLocal();
            }
        }
        
        async function registrarPagoCliente() {
            try {
                const clienteId = document.getElementById('pagoClienteSeleccion').value;
                const monto = parseFloat(document.getElementById('pagoMonto').value);
                const metodo = document.getElementById('pagoMetodo').value;
                const referencia = document.getElementById('pagoReferencia').value;
                const notas = document.getElementById('pagoNotas').value;
                const fecha = document.getElementById('pagoFecha').value || new Date().toISOString().split('T')[0];
                
                if (!clienteId || !monto || monto <= 0) {
                    mostrarError('Cliente y monto v√°lido son requeridos');
                    return;
                }
                
                const cliente = clientesCache.get(clienteId);
                if (!cliente) {
                    mostrarError('Cliente no encontrado');
                    return;
                }
                
                if ((cliente.saldo || 0) < monto) {
                    mostrarError('El monto del pago excede la deuda del cliente');
                    return;
                }
                
                // Crear registro de pago
                const pagoData = {
                    clienteId: clienteId,
                    clienteNombre: cliente.nombre,
                    monto: monto,
                    metodo: metodo,
                    referencia: referencia,
                    notas: notas,
                    fecha: new Date(fecha),
                    usuarioId: usuarioActual.uid,
                    usuarioNombre: usuarioActual.displayName || usuarioActual.email,
                    sucursalId: sucursalActual.id,
                    tipo: 'pago',
                    estado: 'completado'
                };
                
                await db.collection('pagos_clientes').add(pagoData);
                
                // Actualizar saldo del cliente
                await db.collection('clientes').doc(clienteId).update({
                    saldo: firebase.firestore.FieldValue.increment(-monto),
                    ultimoPago: new Date(),
                    pagosTotal: firebase.firestore.FieldValue.increment(1)
                });
                
                // Actualizar cache local
                cliente.saldo = (cliente.saldo || 0) - monto;
                
                mostrarExito(`Pago de $${monto.toFixed(2)} registrado correctamente`);
                cerrarModal('modalPagosClientes');
                
                // Recargar vista de clientes si est√° activa
                if (document.getElementById('clientesView').classList.contains('active')) {
                    await cargarTablaClientesGestion();
                }
                
            } catch (error) {
                console.error('Error registrando pago:', error);
                mostrarError('Error al registrar pago: ' + error.message);
            }
        }
        
        // 8. Sistema de Anulaciones
        async function procesarAnulacion() {
            try {
                const numeroFactura = document.getElementById('anulacionNumeroFactura').value;
                const motivo = document.getElementById('anulacionMotivo').value;
                const detalle = document.getElementById('anulacionDetalle').value;
                const devolverStock = document.getElementById('anulacionDevolverStock').checked;
                
                if (!numeroFactura || !motivo || !detalle) {
                    mostrarError('Todos los campos son requeridos');
                    return;
                }
                
                // Buscar la venta
                const ventasRef = db.collection('ventas')
                    .where('numeroFactura', '==', numeroFactura)
                    .where('sucursalId', '==', sucursalActual.id)
                    .limit(1);
                
                const snapshot = await ventasRef.get();
                
                if (snapshot.empty) {
                    mostrarError('No se encontr√≥ la factura especificada');
                    return;
                }
                
                const ventaDoc = snapshot.docs[0];
                const ventaData = ventaDoc.data();
                
                // Validar que no est√© ya anulada
                if (ventaData.anulada) {
                    mostrarError('Esta factura ya est√° anulada');
                    return;
                }
                
                // Confirmar anulaci√≥n
                if (!confirm(`¬øConfirmar anulaci√≥n de la factura ${numeroFactura} por $${ventaData.total.toFixed(2)}?`)) {
                    return;
                }
                
                // Procesar anulaci√≥n con transacci√≥n
                await db.runTransaction(async (transaction) => {
                    // Marcar venta como anulada
                    const ventaRef = db.collection('ventas').doc(ventaDoc.id);
                    transaction.update(ventaRef, {
                        anulada: true,
                        fechaAnulacion: new Date(),
                        motivoAnulacion: motivo,
                        detalleAnulacion: detalle,
                        usuarioAnulacion: usuarioActual.uid,
                        usuarioAnulacionNombre: usuarioActual.displayName || usuarioActual.email
                    });
                    
                    // Devolver stock si corresponde
                    if (devolverStock) {
                        for (const item of ventaData.items) {
                            if (item.controlStock) {
                                const productoRef = db.collection('productos').doc(item.productoId);
                                transaction.update(productoRef, {
                                    stock: firebase.firestore.FieldValue.increment(item.cantidad),
                                    vendidosTotal: firebase.firestore.FieldValue.increment(-item.cantidad)
                                });
                            }
                        }
                    }
                    
                    // Revertir turno si existe
                    if (ventaData.turnoId) {
                        const turnoRef = db.collection('turnos').doc(ventaData.turnoId);
                        transaction.update(turnoRef, {
                            ventasCount: firebase.firestore.FieldValue.increment(-1),
                            totalVentas: firebase.firestore.FieldValue.increment(-ventaData.total),
                            [`desglosePagos.${ventaData.metodoPago}`]: firebase.firestore.FieldValue.increment(-ventaData.total)
                        });
                    }
                    
                    // Revertir saldo del cliente si era cuenta corriente
                    if (ventaData.metodoPago === 'cuenta_corriente' && ventaData.clienteId) {
                        const clienteRef = db.collection('clientes').doc(ventaData.clienteId);
                        transaction.update(clienteRef, {
                            saldo: firebase.firestore.FieldValue.increment(-ventaData.total),
                            comprasTotal: firebase.firestore.FieldValue.increment(-1)
                        });
                    }
                    
                    // Crear nota de cr√©dito
                    const notaCreditoData = {
                        ventaId: ventaDoc.id,
                        numeroFacturaOriginal: ventaData.numeroFactura,
                        numeroNotaCredito: await generarNumeroNotaCredito(transaction),
                        fecha: new Date(),
                        clienteId: ventaData.clienteId,
                        clienteNombre: ventaData.clienteNombre,
                        monto: ventaData.total,
                        motivo: motivo,
                        detalle: detalle,
                        items: ventaData.items,
                        usuarioId: usuarioActual.uid,
                        sucursalId: sucursalActual.id,
                        estado: 'emitida'
                    };
                    
                    const notaCreditoRef = db.collection('notas_credito').doc();
                    transaction.set(notaCreditoRef, notaCreditoData);
                });
                
                mostrarExito(`Factura ${numeroFactura} anulada correctamente. Nota de cr√©dito generada.`);
                cerrarModal('modalAnulacion');
                
                // Recargar ventas si est√° activa la vista
                if (document.getElementById('ventasView').classList.contains('active')) {
                    await cargarTablaVentas();
                }
                
            } catch (error) {
                console.error('Error procesando anulaci√≥n:', error);
                mostrarError('Error al procesar anulaci√≥n: ' + error.message);
            }
        }
        
        // 9. Sistema de Reportes
        async function generarReporteDiario() {
            try {
                const hoy = new Date();
                const inicioDia = new Date(hoy.getFullYear(), hoy.getMonth(), hoy.getDate(), 0, 0, 0);
                const finDia = new Date(hoy.getFullYear(), hoy.getMonth(), hoy.getDate(), 23, 59, 59);
                
                const ventasSnapshot = await db.collection('ventas')
                    .where('sucursalId', '==', sucursalActual.id)
                    .where('fecha', '>=', inicioDia)
                    .where('fecha', '<=', finDia)
                    .where('anulada', '==', false)
                    .orderBy('fecha', 'desc')
                    .get();
                
                let reporteData = {
                    fecha: hoy,
                    totalVentas: 0,
                    cantidadVentas: 0,
                    promedioVenta: 0,
                    productosVendidos: 0,
                    porMetodoPago: {},
                    porCategoria: {},
                    porHora: {},
                    ventas: []
                };
                
                ventasSnapshot.forEach(doc => {
                    const venta = doc.data();
                    reporteData.totalVentas += venta.total;
                    reporteData.cantidadVentas++;
                    reporteData.productosVendidos += venta.items.reduce((sum, item) => sum + item.cantidad, 0);
                    
                    // M√©todo de pago
                    if (!reporteData.porMetodoPago[venta.metodoPago]) {
                        reporteData.porMetodoPago[venta.metodoPago] = 0;
                    }
                    reporteData.porMetodoPago[venta.metodoPago] += venta.total;
                    
                    // Por hora
                    const hora = new Date(venta.fecha.seconds * 1000).getHours();
                    if (!reporteData.porHora[hora]) {
                        reporteData.porHora[hora] = 0;
                    }
                    reporteData.porHora[hora] += venta.total;
                    
                    // Por categor√≠a (de productos)
                    venta.items.forEach(item => {
                        // Aqu√≠ necesitar√≠as tener las categor√≠as de los productos
                        // Por simplicidad, se omite en este ejemplo
                    });
                    
                    reporteData.ventas.push(venta);
                });
                
                reporteData.promedioVenta = reporteData.cantidadVentas > 0 ? 
                    reporteData.totalVentas / reporteData.cantidadVentas : 0;
                
                // Generar Excel con el reporte
                await exportarReporteExcel(reporteData, `reporte_diario_${formatFecha(hoy, 'YYYY-MM-DD')}`);
                
            } catch (error) {
                console.error('Error generando reporte diario:', error);
                mostrarError('Error al generar reporte: ' + error.message);
            }
        }
        
        // 10. Sistema de Proveedores y Pedidos
        async function cargarProveedoresCache() {
            try {
                const snapshot = await db.collection('proveedores')
                    .where('sucursalId', '==', sucursalActual.id)
                    .where('estado', '==', 'activo')
                    .orderBy('nombre')
                    .limit(100)
                    .get();
                
                proveedoresCache.clear();
                snapshot.forEach(doc => {
                    proveedoresCache.set(doc.id, { id: doc.id, ...doc.data() });
                });
                
            } catch (error) {
                console.error('Error cargando proveedores:', error);
            }
        }
        
        async function guardarPedido() {
            try {
                const proveedorId = document.getElementById('pedidoProveedor').value;
                const fechaEntrega = document.getElementById('pedidoFechaEntrega').value;
                const notas = document.getElementById('pedidoNotas').value;
                
                if (!proveedorId) {
                    mostrarError('Seleccione un proveedor');
                    return;
                }
                
                // Recolectar items del pedido
                const items = [];
                let total = 0;
                
                const filas = document.querySelectorAll('#tablaItemsPedido tr:not(#filaPedidoTemplate)');
                filas.forEach(fila => {
                    const productoSelect = fila.querySelector('.producto-pedido');
                    const cantidadInput = fila.querySelector('.cantidad-pedido');
                    const precioInput = fila.querySelector('.precio-pedido');
                    
                    if (productoSelect.value && cantidadInput.value && precioInput.value) {
                        const productoId = productoSelect.value;
                        const productoNombre = productoSelect.options[productoSelect.selectedIndex].text;
                        const cantidad = parseInt(cantidadInput.value);
                        const precio = parseFloat(precioInput.value);
                        const subtotal = cantidad * precio;
                        
                        items.push({
                            productoId: productoId,
                            productoNombre: productoNombre,
                            cantidad: cantidad,
                            precioUnitario: precio,
                            subtotal: subtotal
                        });
                        
                        total += subtotal;
                    }
                });
                
                if (items.length === 0) {
                    mostrarError('Agregue al menos un producto al pedido');
                    return;
                }
                
                // Generar n√∫mero de pedido
                const numeroPedido = await generarNumeroPedido();
                
                const pedidoData = {
                    numeroPedido: numeroPedido,
                    proveedorId: proveedorId,
                    proveedorNombre: proveedoresCache.get(proveedorId)?.nombre || '',
                    fecha: new Date(),
                    fechaEntrega: fechaEntrega ? new Date(fechaEntrega) : null,
                    items: items,
                    total: total,
                    notas: notas,
                    estado: 'pendiente',
                    sucursalId: sucursalActual.id,
                    usuarioId: usuarioActual.uid,
                    usuarioNombre: usuarioActual.displayName || usuarioActual.email
                };
                
                await db.collection('pedidos').add(pedidoData);
                
                mostrarExito(`Pedido #${numeroPedido} guardado correctamente`);
                cerrarModal('modalNuevoPedido');
                
                // Recargar vista de pedidos
                if (document.getElementById('proveedoresView').classList.contains('active')) {
                    await cargarTablaPedidos();
                }
                
            } catch (error) {
                console.error('Error guardando pedido:', error);
                mostrarError('Error al guardar pedido: ' + error.message);
            }
        }
        
        async function enviarPedidosWhatsApp() {
            try {
                // Obtener pedidos pendientes
                const pedidosSnapshot = await db.collection('pedidos')
                    .where('sucursalId', '==', sucursalActual.id)
                    .where('estado', '==', 'pendiente')
                    .get();
                
                if (pedidosSnapshot.empty) {
                    mostrarInfo('No hay pedidos pendientes para enviar');
                    return;
                }
                
                // Construir mensaje
                let mensaje = `*PEDIDOS PENDIENTES - ${sucursalActual.data().nombre}*\n\n`;
                mensaje += `Fecha: ${formatFecha(new Date(), 'DD/MM/YYYY')}\n\n`;
                
                pedidosSnapshot.forEach(doc => {
                    const pedido = doc.data();
                    mensaje += `*Pedido #${pedido.numeroPedido}*\n`;
                    mensaje += `Proveedor: ${pedido.proveedorNombre}\n`;
                    mensaje += `Fecha: ${formatFecha(pedido.fecha, 'DD/MM/YYYY')}\n`;
                    mensaje += `Total: $${pedido.total.toFixed(2)}\n\n`;
                    
                    pedido.items.forEach((item, index) => {
                        mensaje += `${index + 1}. ${item.productoNombre} - ${item.cantidad} x $${item.precioUnitario.toFixed(2)} = $${item.subtotal.toFixed(2)}\n`;
                    });
                    
                    mensaje += `\n---\n\n`;
                });
                
                // Codificar mensaje para URL de WhatsApp
                const mensajeCodificado = encodeURIComponent(mensaje);
                
                // Crear URL de WhatsApp (asumiendo que se env√≠a a un n√∫mero configurado)
                const numeroWhatsApp = configuracionSistema.whatsappContacto || '';
                let whatsappURL = 'https://wa.me/';
                
                if (numeroWhatsApp) {
                    whatsappURL += `${numeroWhatsApp}?text=${mensajeCodificado}`;
                } else {
                    // Si no hay n√∫mero configurado, usar la API de compartir
                    whatsappURL = `https://api.whatsapp.com/send?text=${mensajeCodificado}`;
                }
                
                // Abrir en nueva pesta√±a
                window.open(whatsappURL, '_blank');
                
                mostrarExito('Mensaje preparado para WhatsApp');
                
            } catch (error) {
                console.error('Error enviando pedidos por WhatsApp:', error);
                mostrarError('Error al preparar mensaje: ' + error.message);
            }
        }
        
        // 11. Sistema de Backup y Restauraci√≥n
        async function exportarBackup() {
            try {
                // Recolectar datos
                const backupData = {
                    metadata: {
                        version: '2.0',
                        fecha: new Date().toISOString(),
                        sucursal: sucursalActual.id,
                        usuario: usuarioActual.uid
                    },
                    productos: Array.from(productosCache.values()),
                    clientes: Array.from(clientesCache.values()),
                    proveedores: Array.from(proveedoresCache.values()),
                    configuracion: configuracionSistema,
                    ventas: [] // Nota: Para un backup completo podr√≠as incluir ventas tambi√©n
                };
                
                // Convertir a JSON
                const jsonStr = JSON.stringify(backupData, null, 2);
                
                // Crear blob y descargar
                const blob = new Blob([jsonStr], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `backup_pos_${sucursalActual.id}_${formatFecha(new Date(), 'YYYY-MM-DD_HH-mm')}.json`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
                
                // Guardar registro del backup
                await db.collection('backups').add({
                    fecha: new Date(),
                    tipo: 'manual',
                    tama√±o: jsonStr.length,
                    usuarioId: usuarioActual.uid,
                    sucursalId: sucursalActual.id,
                    estado: 'completado'
                });
                
                mostrarExito('Backup exportado correctamente');
                
            } catch (error) {
                console.error('Error exportando backup:', error);
                mostrarError('Error al exportar backup: ' + error.message);
            }
        }
        
        async function importarBackup() {
            document.getElementById('fileBackupImport').click();
        }
        
        document.getElementById('fileBackupImport').addEventListener('change', async function(e) {
            const file = e.target.files[0];
            if (!file) return;
            
            if (!confirm('¬øEst√° seguro de importar este backup? Se sobrescribir√°n los datos actuales.')) {
                return;
            }
            
            try {
                const reader = new FileReader();
                
                reader.onload = async function(e) {
                    try {
                        const backupData = JSON.parse(e.target.result);
                        
                        // Validar estructura del backup
                        if (!backupData.metadata || !backupData.productos) {
                            throw new Error('Formato de backup inv√°lido');
                        }
                        
                        // Procesar importaci√≥n
                        mostrarCargando('Importando backup...');
                        
                        // Importar productos
                        for (const producto of backupData.productos) {
                            await db.collection('productos').doc(producto.id).set(producto, { merge: true });
                        }
                        
                        // Importar clientes
                        for (const cliente of backupData.clientes) {
                            await db.collection('clientes').doc(cliente.id).set(cliente, { merge: true });
                        }
                        
                        // Actualizar configuraci√≥n local
                        if (backupData.configuracion) {
                            localStorage.setItem('configuracion_sistema', JSON.stringify(backupData.configuracion));
                            configuracionSistema = backupData.configuracion;
                            await actualizarConfiguracionUI();
                        }
                        
                        // Recargar datos
                        await cargarProductosCache();
                        await cargarClientesCache();
                        await cargarProveedoresCache();
                        
                        mostrarExito('Backup importado correctamente');
                        
                    } catch (error) {
                        console.error('Error procesando backup:', error);
                        mostrarError('Error al importar backup: ' + error.message);
                    }
                };
                
                reader.readAsText(file);
                
            } catch (error) {
                console.error('Error leyendo archivo:', error);
                mostrarError('Error al leer el archivo de backup');
            }
        });
        
        // 12. Sistema de Impresi√≥n
        async function imprimirTicket(ventaData) {
            try {
                const ticketContainer = document.getElementById('ticketContainer');
                
                // Datos de la empresa
                const empresaNombre = configuracionSistema.empresaNombre || 'Mi Comercio';
                const empresaDireccion = configuracionSistema.empresaDireccion || '';
                const empresaTelefono = configuracionSistema.empresaTelefono || '';
                const empresaCuit = configuracionSistema.empresaCuit || '';
                const empresaCondicionIva = configuracionSistema.empresaCondicionIva || 'Consumidor Final';
                
                // Generar HTML del ticket
                const ticketHTML = `
                    <div class="ticket" id="ticket-${ventaData.numeroFactura}">
                        <div class="ticket-header">
                            <div class="ticket-empresa">${empresaNombre}</div>
                            ${empresaDireccion ? `<div style="font-size: 12px;">${empresaDireccion}</div>` : ''}
                            ${empresaTelefono ? `<div style="font-size: 12px;">${empresaTelefono}</div>` : ''}
                            ${empresaCuit ? `<div style="font-size: 12px;">CUIT: ${empresaCuit}</div>` : ''}
                            <div style="font-size: 12px;">${empresaCondicionIva}</div>
                            <hr style="margin: 8px 0; border-top: 1px dashed black;">
                            <div style="font-weight: bold; font-size: 14px;">FACTURA ${ventaData.numeroFactura}</div>
                            <div style="font-size: 12px;">${formatFecha(ventaData.fecha, 'DD/MM/YYYY HH:mm')}</div>
                        </div>
                        
                        <div style="font-size: 12px; margin-bottom: 12px;">
                            <div>Cliente: ${ventaData.clienteNombre}</div>
                            ${ventaData.clienteDocumento ? `<div>Documento: ${ventaData.clienteDocumento}</div>` : ''}
                            <div>Vendedor: ${ventaData.usuarioNombre}</div>
                        </div>
                        
                        <div class="ticket-items">
                            ${ventaData.items.map(item => `
                                <div class="ticket-item">
                                    <div style="flex: 3;">${item.cantidad} x ${item.nombre.substring(0, 20)}</div>
                                    <div style="flex: 1; text-align: right;">$${item.subtotal.toFixed(2)}</div>
                                </div>
                            `).join('')}
                        </div>
                        
                        <div class="ticket-total">
                            <div style="display: flex; justify-content: space-between;">
                                <span>Subtotal:</span>
                                <span>$${ventaData.subtotal.toFixed(2)}</span>
                            </div>
                            ${ventaData.descuentoTotal > 0 ? `
                            <div style="display: flex; justify-content: space-between;">
                                <span>Descuento:</span>
                                <span style="color: var(--danger);">-$${ventaData.descuentoTotal.toFixed(2)}</span>
                            </div>
                            ` : ''}
                            <div style="display: flex; justify-content: space-between;">
                                <span>IVA (${(IVA_PORCENTAJE * 100).toFixed(0)}%):</span>
                                <span>$${ventaData.iva.toFixed(2)}</span>
                            </div>
                            <div style="display: flex; justify-content: space-between; font-size: 16px; margin-top: 8px; font-weight: bold;">
                                <span>TOTAL:</span>
                                <span>$${ventaData.total.toFixed(2)}</span>
                            </div>
                            <div style="font-size: 12px; margin-top: 4px;">
                                ${ventaData.metodoPago.toUpperCase()} 
                                ${ventaData.datosPago.montoRecibido ? `- Recibido: $${ventaData.datosPago.montoRecibido.toFixed(2)}` : ''}
                                ${ventaData.datosPago.cambio ? `- Cambio: $${ventaData.datosPago.cambio.toFixed(2)}` : ''}
                            </div>
                        </div>
                        
                        <div class="ticket-footer">
                            ${configuracionSistema.mensajeTicket || '¬°Gracias por su compra!'}
                        </div>
                    </div>
                `;
                
                ticketContainer.innerHTML = ticketHTML;
                
                // Opciones de impresi√≥n
                const printOptions = {
                    margin: [5, 5, 5, 5],
                    filename: `ticket_${ventaData.numeroFactura}.pdf`,
                    image: { type: 'jpeg', quality: 0.98 },
                    html2canvas: { 
                        scale: 2,
                        useCORS: true,
                        logging: false
                    },
                    jsPDF: { 
                        unit: 'mm', 
                        format: [58, 200], 
                        orientation: 'portrait' 
                    }
                };
                
                // Determinar tipo de impresi√≥n seg√∫n configuraci√≥n
                const tipoImpresion = configuracionSistema.tipoImpresion || 'pdf';
                
                if (tipoImpresion === 'pdf') {
                    // Generar PDF
                    await html2pdf().from(ticketContainer).set(printOptions).save();
                } else if (tipoImpresion === 'imprimir') {
                    // Impresi√≥n directa
                    const printWindow = window.open('', '_blank');
                    printWindow.document.write(`
                        <!DOCTYPE html>
                        <html>
                        <head>
                            <title>Ticket ${ventaData.numeroFactura}</title>
                            <style>
                                @media print {
                                    body { margin: 0; padding: 0; }
                                    .ticket { width: 58mm; padding: 0; margin: 0; font-family: monospace; }
                                }
                            </style>
                        </head>
                        <body>${ticketHTML}</body>
                        </html>
                    `);
                    printWindow.document.close();
                    printWindow.print();
                    printWindow.close();
                }
                
                // Registrar reimpresi√≥n
                if (!modoEmergencia && ventaData.id && !ventaData.id.startsWith('offline_')) {
                    await db.collection('ventas').doc(ventaData.id).update({
                        reimpresiones: firebase.firestore.FieldValue.increment(1)
                    });
                }
                
            } catch (error) {
                console.error('Error imprimiendo ticket:', error);
                mostrarError('Error al imprimir ticket: ' + error.message);
            }
        }
        
        // ============================================
        // FUNCIONES DE UTILIDAD Y AUXILIARES
        // ============================================
        
        // Formatear fecha
        function formatFecha(fecha, formato = 'DD/MM/YYYY HH:mm') {
            const date = fecha instanceof Date ? fecha : (fecha && fecha.toDate ? fecha.toDate() : new Date(fecha));
            
            const pad = (n) => n.toString().padStart(2, '0');
            
            const replacements = {
                'YYYY': date.getFullYear(),
                'MM': pad(date.getMonth() + 1),
                'DD': pad(date.getDate()),
                'HH': pad(date.getHours()),
                'mm': pad(date.getMinutes()),
                'ss': pad(date.getSeconds())
            };
            
            return formato.replace(/YYYY|MM|DD|HH|mm|ss/g, match => replacements[match]);
        }
        
        // Mostrar mensajes
        function mostrarError(mensaje) {
            alert(`‚ùå ${mensaje}`);
        }
        
        function mostrarExito(mensaje) {
            alert(`‚úÖ ${mensaje}`);
        }
        
        function mostrarInfo(mensaje) {
            alert(`‚ÑπÔ∏è ${mensaje}`);
        }
        
        function mostrarCargando(mensaje) {
            // Implementar spinner o modal de carga
            console.log(`‚è≥ ${mensaje}`);
        }
        
        // Navegaci√≥n entre vistas
        function cambiarVista(viewId) {
            // Ocultar todas las vistas
            document.querySelectorAll('.view').forEach(view => {
                view.classList.remove('active');
            });
            
            // Mostrar vista seleccionada
            const vistaSeleccionada = document.getElementById(`${viewId}View`);
            if (vistaSeleccionada) {
                vistaSeleccionada.classList.add('active');
                
                // Cargar datos espec√≠ficos de la vista
                switch(viewId) {
                    case 'productos':
                        cargarTablaProductosGestion();
                        break;
                    case 'clientes':
                        cargarTablaClientesGestion();
                        break;
                    case 'ventas':
                        cargarTablaVentas();
                        break;
                    case 'caja':
                        cargarHistorialTurnos();
                        break;
                    case 'reportes':
                        actualizarReportes();
                        break;
                    case 'proveedores':
                        cargarTablaProveedores();
                        break;
                    case 'configuracion':
                        cargarConfiguracionUI();
                        break;
                }
            }
            
            // Actualizar men√∫ activo
            document.querySelectorAll('.menu-item').forEach(item => {
                item.classList.remove('active');
                if (item.getAttribute('data-view') === viewId) {
                    item.classList.add('active');
                }
            });
            
            // Cerrar sidebar en m√≥viles
            if (window.innerWidth <= 1200) {
                document.getElementById('sidebar').classList.remove('active');
            }
        }
        
        // Actualizar contadores
        function actualizarContadores() {
            // Contador de productos
            document.getElementById('productosCount').textContent = productosCache.size;
            
            // Contador de clientes
            document.getElementById('clientesCount').textContent = clientesCache.size;
            
            // Contador de ventas locales (offline)
            if (ventasPendientes) {
                document.getElementById('pendingSalesCount').textContent = ventasPendientes.length;
            }
            
            // Contador local
            document.getElementById('localCount').textContent = productosCache.size;
        }
        
        // Cerrar sesi√≥n
        async function logout() {
            try {
                // Cerrar turno si est√° abierto
                if (turnoActual && turnoActual.data().estado === 'abierto') {
                    if (confirm('Tienes un turno abierto. ¬øDeseas cerrarlo antes de salir?')) {
                        const efectivoFinal = prompt('Ingrese el efectivo final en caja:', '0');
                        if (efectivoFinal !== null) {
                            await db.collection('turnos').doc(turnoActual.id).update({
                                cierre: new Date(),
                                estado: 'cerrado',
                                efectivoFinal: parseFloat(efectivoFinal),
                                observaciones: 'Cerrado al salir del sistema'
                            });
                        }
                    }
                }
                
                // Guardar estado del sistema
                guardarCarritoLocal();
                guardarEstadoSistema();
                
                // Detener todos los listeners
                listenersActivos.forEach(unsubscribe => unsubscribe());
                listenersActivos = [];
                
                // Cerrar sesi√≥n en Firebase
                await auth.signOut();
                
                // Redirigir a p√°gina de login
                window.location.href = 'login.html';
                
            } catch (error) {
                console.error('Error cerrando sesi√≥n:', error);
                mostrarError('Error al cerrar sesi√≥n');
            }
        }
        
        // ============================================
        // FUNCIONES DE UI Y MANEJO DE EVENTOS
        // ============================================
        
        function configurarFormularios() {
            // Formulario nuevo producto
            document.getElementById('formNuevoProducto')?.addEventListener('submit', async function(e) {
                e.preventDefault();
                await guardarNuevoProducto();
            });
            
            // Formulario nuevo cliente
            document.getElementById('formNuevoCliente')?.addEventListener('submit', async function(e) {
                e.preventDefault();
                await guardarNuevoCliente();
            });
            
            // Formulario nuevo proveedor
            document.getElementById('formNuevoProveedor')?.addEventListener('submit', async function(e) {
                e.preventDefault();
                await guardarNuevoProveedor();
            });
            
            // Configurar eventos de b√∫squeda
            document.getElementById('buscarProducto')?.addEventListener('input', buscarProductos);
            document.getElementById('buscarProductosGestion')?.addEventListener('input', filtrarProductosGestion);
            document.getElementById('buscarClientes')?.addEventListener('input', filtrarClientes);
        }
        
        function inicializarListenersTiempoReal() {
            // Listener para cambios en productos
            if (sucursalActual) {
                const productosListener = db.collection('productos')
                    .where('sucursalId', '==', sucursalActual.id)
                    .where('estado', '==', 'activo')
                    .onSnapshot(async (snapshot) => {
                        snapshot.docChanges().forEach(change => {
                            const producto = { id: change.doc.id, ...change.doc.data() };
                            
                            if (change.type === 'added' || change.type === 'modified') {
                                productosCache.set(producto.id, producto);
                            } else if (change.type === 'removed') {
                                productosCache.delete(producto.id);
                            }
                        });
                        
                        actualizarContadores();
                        
                        // Actualizar UI si est√° en la vista de productos
                        if (document.getElementById('productosView').classList.contains('active')) {
                            cargarTablaProductosGestion();
                        }
                        
                        // Actualizar b√∫squeda de POS si est√° activa
                        if (document.getElementById('posView').classList.contains('active')) {
                            buscarProductos();
                        }
                    });
                
                listenersActivos.push(productosListener);
            }
        }
        
        // ============================================
        // FUNCIONES ESPEC√çFICAS DE UI
        // ============================================
        
        // Gesti√≥n del carrito
        function modificarCantidad(index, delta) {
            if (carrito[index]) {
                const nuevaCantidad = carrito[index].cantidad + delta;
                
                if (nuevaCantidad < 1) {
                    eliminarDelCarrito(index);
                    return;
                }
                
                if (carrito[index].controlStock && carrito[index].stock < nuevaCantidad) {
                    mostrarError(`Stock insuficiente. Solo quedan ${carrito[index].stock} unidades.`);
                    return;
                }
                
                carrito[index].cantidad = nuevaCantidad;
                carrito[index].subtotal = nuevaCantidad * carrito[index].precioVenta;
                
                actualizarCarrito();
                guardarCarritoLocal();
            }
        }
        
        function eliminarDelCarrito(index) {
            if (carrito[index]) {
                carrito.splice(index, 1);
                actualizarCarrito();
                guardarCarritoLocal();
            }
        }
        
        function vaciarCarrito() {
            if (carrito.length === 0) {
                mostrarError('El carrito ya est√° vac√≠o');
                return;
            }
            
            if (confirm(`¬øEst√°s seguro de vaciar el carrito? Se eliminar√°n ${carrito.length} productos.`)) {
                carrito = [];
                document.getElementById('descuentoGlobal').value = '0';
                actualizarCarrito();
                guardarCarritoLocal();
                mostrarExito('Carrito vaciado correctamente');
            }
        }
        
        function aplicarDescuentoItem(index, porcentaje) {
            if (carrito[index]) {
                porcentaje = Math.min(Math.max(parseFloat(porcentaje) || 0, 0), 100);
                const item = carrito[index];
                const descuento = (item.cantidad * item.precioVenta * porcentaje) / 100;
                
                item.descuento = descuento;
                item.descuentoPorcentaje = porcentaje;
                item.subtotal = (item.cantidad * item.precioVenta) - descuento;
                
                actualizarCarrito();
                guardarCarritoLocal();
            }
        }
        
        function aplicarDescuentoGlobal() {
            actualizarCarrito();
        }
        
        // M√©todos de pago
        function actualizarPago() {
            const metodoPago = document.getElementById('selectPago').value;
            
            // Ocultar todos los m√©todos
            document.querySelectorAll('.metodo-pago').forEach(div => {
                div.style.display = 'none';
            });
            
            // Mostrar m√©todo seleccionado
            document.getElementById(`pago${metodoPago.charAt(0).toUpperCase() + metodoPago.slice(1)}`).style.display = 'block';
            
            // Actualizar cliente si es cuenta corriente
            if (metodoPago === 'cuenta_corriente') {
                actualizarCliente();
            }
        }
        
        function calcularCambio() {
            const montoRecibido = parseFloat(document.getElementById('montoRecibido').value) || 0;
            const total = parseFloat(document.getElementById('total').textContent.replace('$', '')) || 0;
            
            const cambio = montoRecibido - total;
            document.getElementById('cambio').value = cambio > 0 ? cambio.toFixed(2) : '0.00';
            
            // Cambiar color seg√∫n si hay cambio positivo, negativo o exacto
            const cambioElement = document.getElementById('cambio');
            if (cambio > 0) {
                cambioElement.style.color = 'var(--secondary)';
                cambioElement.style.fontWeight = 'bold';
            } else if (cambio < 0) {
                cambioElement.style.color = 'var(--danger)';
                cambioElement.style.fontWeight = 'bold';
            } else {
                cambioElement.style.color = 'var(--gray)';
                cambioElement.style.fontWeight = 'normal';
            }
        }
        
        function calcularMixto() {
            const efectivo = parseFloat(document.getElementById('mixtoEfectivo').value) || 0;
            const tarjeta = parseFloat(document.getElementById('mixtoTarjeta').value) || 0;
            const transferencia = parseFloat(document.getElementById('mixtoTransferencia').value) || 0;
            const qr = parseFloat(document.getElementById('mixtoQR').value) || 0;
            
            const totalMixto = efectivo + tarjeta + transferencia + qr;
            document.getElementById('totalMixto').value = totalMixto.toFixed(2);
        }
        
        function validarPago(metodo, total) {
            switch(metodo) {
                case 'efectivo':
                    const montoRecibido = parseFloat(document.getElementById('montoRecibido').value) || 0;
                    if (montoRecibido < total) {
                        return { valido: false, mensaje: 'El monto recibido es menor al total' };
                    }
                    break;
                    
                case 'mixto':
                    const totalMixto = parseFloat(document.getElementById('totalMixto').value) || 0;
                    if (Math.abs(totalMixto - total) > 0.01) {
                        return { valido: false, mensaje: `La suma de los montos (${totalMixto}) no coincide con el total (${total})` };
                    }
                    break;
                    
                case 'cuenta_corriente':
                    const clienteId = document.getElementById('selectCliente').value;
                    if (!clienteId) {
                        return { valido: false, mensaje: 'Seleccione un cliente para cuenta corriente' };
                    }
                    const cliente = clientesCache.get(clienteId);
                    if (!cliente) {
                        return { valido: false, mensaje: 'Cliente no encontrado' };
                    }
                    break;
            }
            
            return { valido: true, mensaje: '' };
        }
        
        function obtenerDatosPago(metodo) {
            switch(metodo) {
                case 'efectivo':
                    return {
                        montoRecibido: parseFloat(document.getElementById('montoRecibido').value) || 0,
                        cambio: parseFloat(document.getElementById('cambio').value) || 0
                    };
                    
                case 'tarjeta':
                    return {
                        numero: document.getElementById('tarjetaNumero').value,
                        tipo: document.getElementById('tarjetaTipo').value,
                        cuotas: document.getElementById('tarjetaCuotas').value
                    };
                    
                case 'transferencia':
                    return {
                        comprobante: document.getElementById('transferenciaComprobante').value,
                        banco: document.getElementById('transferenciaBanco').value
                    };
                    
                case 'qr':
                    return {
                        plataforma: document.getElementById('qrPlataforma').value,
                        transaccion: document.getElementById('qrTransaccion').value
                    };
                    
                case 'mixto':
                    return {
                        efectivo: parseFloat(document.getElementById('mixtoEfectivo').value) || 0,
                        tarjeta: parseFloat(document.getElementById('mixtoTarjeta').value) || 0,
                        transferencia: parseFloat(document.getElementById('mixtoTransferencia').value) || 0,
                        qr: parseFloat(document.getElementById('mixtoQR').value) || 0
                    };
                    
                case 'cuenta_corriente':
                    return {
                        clienteId: document.getElementById('selectCliente').value,
                        clienteNombre: document.getElementById('selectCliente').options[document.getElementById('selectCliente').selectedIndex].text
                    };
                    
                default:
                    return {};
            }
        }
        
        // Scanner de c√≥digo de barras
        let scannerStream = null;
        
        async function abrirScanner() {
            try {
                const scanner = document.getElementById('barcodeScanner');
                scanner.style.display = 'block';
                
                // Solicitar permisos de c√°mara
                scannerStream = await navigator.mediaDevices.getUserMedia({ 
                    video: { facingMode: 'environment' } 
                });
                
                const video = document.getElementById('barcodeVideo');
                video.srcObject = scannerStream;
                await video.play();
                
                // Configurar QuaggaJS
                Quagga.init({
                    inputStream: {
                        name: "Live",
                        type: "LiveStream",
                        target: video,
                        constraints: {
                            facingMode: "environment"
                        }
                    },
                    decoder: {
                        readers: ["code_128_reader", "ean_reader", "ean_8_reader", "code_39_reader"]
                    }
                }, function(err) {
                    if (err) {
                        console.error('Error inicializando Quagga:', err);
                        iniciarScannerAlternativo();
                        return;
                    }
                    
                    Quagga.start();
                    
                    Quagga.onDetected(function(result) {
                        const codigo = result.codeResult.code;
                        buscarProductoPorCodigo(codigo);
                        cerrarScanner();
                    });
                });
                
            } catch (error) {
                console.error('Error al abrir scanner:', error);
                iniciarScannerAlternativo();
            }
        }
        
        function iniciarScannerAlternativo() {
            const codigo = prompt('Ingresa el c√≥digo de barras manualmente:');
            if (codigo && codigo.trim() !== '') {
                buscarProductoPorCodigo(codigo.trim());
            }
        }
        
        function buscarProductoPorCodigo(codigo) {
            for (let producto of productosCache.values()) {
                if (producto.codigo === codigo) {
                    agregarAlCarrito(producto);
                    mostrarExito(`Producto agregado: ${producto.nombre}`);
                    return;
                }
            }
            
            mostrarError(`No se encontr√≥ producto con c√≥digo: ${codigo}`);
        }
        
        function cerrarScanner() {
            const scanner = document.getElementById('barcodeScanner');
            scanner.style.display = 'none';
            
            // Detener Quagga
            Quagga.stop();
            
            // Detener stream de c√°mara
            if (scannerStream) {
                scannerStream.getTracks().forEach(track => track.stop());
                scannerStream = null;
            }
        }
        
        // Modo emergencia
        function continuarSinConexion() {
            document.getElementById('emergencyMode').style.display = 'none';
            mostrarExito('Continuando en modo offline');
        }
        
        function verVentasPendientes() {
            // Implementar vista de ventas pendientes
            mostrarInfo('Funcionalidad en desarrollo');
        }
        
        // Presupuestos
        function crearPresupuesto() {
            if (carrito.length === 0) {
                mostrarError('El carrito est√° vac√≠o');
                return;
            }
            
            // Implementar creaci√≥n de presupuesto
            mostrarInfo('Funcionalidad de presupuestos en desarrollo');
        }
        
        function reimprimirUltimo() {
            if (!ultimaVenta) {
                mostrarError('No hay ventas recientes para reimprimir');
                return;
            }
            
            if (confirm(`¬øReimprimir ticket de venta #${ultimaVenta.numeroFactura}?`)) {
                imprimirTicket(ultimaVenta);
            }
        }
        
        function exportarVentaPDF() {
            if (carrito.length === 0) {
                mostrarError('El carrito est√° vac√≠o');
                return;
            }
            
            // Implementar exportaci√≥n a PDF
            mostrarInfo('Exportando venta a PDF...');
        }
        
        function congelarPrecios() {
            if (carrito.length === 0) {
                mostrarError('El carrito est√° vac√≠o');
                return;
            }
            
            carrito.forEach(item => {
                item.congelado = !item.congelado;
            });
            
            mostrarExito('Precios congelados en el carrito actual');
        }
        
        // Modales
        function mostrarModal(modalId) {
            const modal = document.getElementById(modalId);
            if (modal) {
                modal.style.display = 'flex';
                document.body.style.overflow = 'hidden';
                
                // Cargar contenido espec√≠fico del modal
                switch(modalId) {
                    case 'modalProductos':
                        cargarModalProductos();
                        break;
                    case 'modalClientes':
                        cargarModalClientes();
                        break;
                    case 'modalNuevoProducto':
                        cargarOpcionesNuevoProducto();
                        break;
                    case 'modalNuevoCliente':
                        cargarOpcionesNuevoCliente();
                        break;
                    case 'modalNuevoProveedor':
                        cargarOpcionesNuevoProveedor();
                        break;
                }
            }
        }
        
        function cerrarModal(modalId) {
            const modal = document.getElementById(modalId);
            if (modal) {
                modal.style.display = 'none';
                document.body.style.overflow = 'auto';
            }
        }
        
        // ============================================
        // FUNCIONES DE ALMACENAMIENTO LOCAL
        // ============================================
        
        async function cargarConfiguracionLocal() {
            try {
                const configGuardada = localStorage.getItem('configuracion_sistema');
                if (configGuardada) {
                    configuracionSistema = JSON.parse(configGuardada);
                } else {
                    // Configuraci√≥n por defecto
                    configuracionSistema = {
                        empresaNombre: 'Mi Comercio',
                        ivaPorcentaje: 21,
                        puntoVenta: '0001',
                        tipoImpresion: 'pdf',
                        mensajeTicket: '¬°Gracias por su compra!',
                        caja: '1'
                    };
                }
            } catch (error) {
                console.error('Error cargando configuraci√≥n:', error);
            }
        }
        
        function guardarCarritoLocal() {
            localStorage.setItem('pos_carrito', JSON.stringify(carrito));
        }
        
        function cargarCarritoLocal() {
            const carritoGuardado = localStorage.getItem('pos_carrito');
            if (carritoGuardado) {
                try {
                    carrito = JSON.parse(carritoGuardado);
                    actualizarCarrito();
                } catch (e) {
                    console.error('Error cargando carrito:', e);
                    carrito = [];
                }
            }
        }
        
        function guardarEstadoSistema() {
            const estado = {
                carrito: carrito,
                ultimaVenta: ultimaVenta,
                modoEmergencia: modoEmergencia,
                fecha: new Date().toISOString()
            };
            localStorage.setItem('estado_sistema', JSON.stringify(estado));
        }
        
        async function guardarProductosCacheLocal() {
            const productosArray = Array.from(productosCache.values());
            localStorage.setItem('productos_cache', JSON.stringify(productosArray));
        }
        
        async function cargarProductosCacheLocal() {
            const productosGuardados = localStorage.getItem('productos_cache');
            if (productosGuardados) {
                try {
                    const productosArray = JSON.parse(productosGuardados);
                    productosCache.clear();
                    productosArray.forEach(producto => {
                        productosCache.set(producto.id, producto);
                    });
                    actualizarContadores();
                } catch (e) {
                    console.error('Error cargando productos cache:', e);
                }
            }
        }
        
        async function guardarClientesCacheLocal() {
            const clientesArray = Array.from(clientesCache.values());
            localStorage.setItem('clientes_cache', JSON.stringify(clientesArray));
        }
        
        async function cargarClientesCacheLocal() {
            const clientesGuardados = localStorage.getItem('clientes_cache');
            if (clientesGuardados) {
                try {
                    const clientesArray = JSON.parse(clientesGuardados);
                    clientesCache.clear();
                    clientesArray.forEach(cliente => {
                        clientesCache.set(cliente.id, cliente);
                    });
                    actualizarContadores();
                } catch (e) {
                    console.error('Error cargando clientes cache:', e);
                }
            }
        }
        
        // ============================================
        // MONITOREO DE CONEXI√ìN
        // ============================================
        
        function initConnectionMonitor() {
            const connectionStatus = document.getElementById('connectionStatus');
            const connectionStatusIcon = document.getElementById('connectionStatusIcon');
            const syncStatus = document.getElementById('syncStatus');
            
            function actualizarEstadoConexion() {
                if (navigator.onLine) {
                    // Online
                    connectionStatus.textContent = 'Conectado';
                    connectionStatusIcon.className = 'fas fa-wifi status-online';
                    
                    if (modoEmergencia) {
                        // Salir del modo emergencia
                        modoEmergencia = false;
                        document.getElementById('emergencyMode').style.display = 'none';
                        
                        // Intentar sincronizar datos pendientes
                        intentarSincronizar();
                        syncStatus.textContent = 'Sincronizando...';
                        
                        setTimeout(() => {
                            syncStatus.textContent = 'Sincronizado';
                        }, 2000);
                    } else {
                        syncStatus.textContent = 'Sincronizado';
                    }
                    
                } else {
                    // Offline
                    connectionStatus.textContent = 'Sin conexi√≥n';
                    connectionStatusIcon.className = 'fas fa-wifi status-offline';
                    
                    // Activar modo emergencia
                    if (!modoEmergencia) {
                        modoEmergencia = true;
                        document.getElementById('emergencyMode').style.display = 'flex';
                        document.getElementById('pendingSalesCount').textContent = ventasPendientes.length;
                    }
                    
                    syncStatus.textContent = 'Modo offline';
                }
            }
            
            // Estado inicial
            actualizarEstadoConexion();
            
            // Escuchar cambios de conexi√≥n
            window.addEventListener('online', actualizarEstadoConexion);
            window.addEventListener('offline', actualizarEstadoConexion);
        }
        
        // ============================================
        // TIMER DE INACTIVIDAD
        // ============================================
        
        function setupInactivityTimer(timeout) {
            let inactivityTimer;
            
            function resetTimer() {
                clearTimeout(inactivityTimer);
                inactivityTimer = setTimeout(() => {
                    if (usuarioActual) {
                        if (confirm('Has estado inactivo por mucho tiempo. ¬øDeseas continuar trabajando?')) {
                            resetTimer();
                        } else {
                            logout();
                        }
                    }
                }, timeout);
            }
            
            // Eventos que reinician el timer
            const events = ['mousedown', 'mousemove', 'keypress', 'scroll', 'touchstart'];
            events.forEach(event => {
                document.addEventListener(event, resetTimer, true);
            });
            
            resetTimer();
        }
        
        // ============================================
        // FUNCIONES DE INICIALIZACI√ìN RESTANTES
        // ============================================
        
        // Funci√≥n para mostrar login
        function mostrarLogin() {
            // En un sistema real, redirigir√≠a a login.html
            console.log('Redirigiendo a login...');
            // window.location.href = 'login.html';
        }
        
        // Inicializar actualizaci√≥n de pago
        actualizarPago();
        
        // ============================================
        // NOTA: Este es un sistema completo pero simplificado.
        // En producci√≥n, se necesitar√≠a:
        // 1. Manejo de errores m√°s robusto
        // 2. Validaci√≥n de datos m√°s estricta
        // 3. Seguridad mejorada
        // 4. Optimizaci√≥n de rendimiento
        // 5. Pruebas exhaustivas
        // ============================================
        
        console.log('Sistema POS completamente inicializado');
        
    </script>
</body>
</html>
